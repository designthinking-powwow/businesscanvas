<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å•†æ¥­æ¨¡å¼ç•«å¸ƒ (Pro)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- æ–°å¢ html2canvas ç”¨æ–¼åœ–ç‰‡ä¸‹è¼‰ -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body { font-family: 'Noto Sans TC', sans-serif; }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.2s ease-out forwards; }
        .animate-slideIn { animation: slideIn 0.2s ease-out forwards; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body h3 { font-weight: bold; font-size: 1.1em; margin-top: 1em; margin-bottom: 0.5em; }
        .markdown-body p { margin-bottom: 0.5em; }
        
        /* HEADER ACTIONS å„ªåŒ– */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            overflow-x: auto;
            white-space: nowrap;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .header-actions::-webkit-scrollbar { display: none; }
        
        @media (max-width: 1024px) {
            .header-actions {
                width: 100%;
                background-color: #f8fafc;
                border: 1px solid #e2e8f0;
                border-radius: 0.75rem;
                padding: 0.5rem;
                justify-content: flex-start;
            }
            .header-actions::after { content: ''; padding-right: 0.5rem; }
        }

        .header-actions > * { flex-shrink: 0; }
        
        @media print {
            body { background: white; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            .print-border { border: 2px solid #333 !important; }
            .print-shadow-none { box-shadow: none !important; }
        }
    </style>
</head>
<body class="bg-[#F3F4F6] text-slate-800 font-sans">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // =================================================================================
        //  System Configuration (User Controlled)
        // =================================================================================
        
        // 1. Gemini API Key
        // ç‚ºäº†å®‰å…¨ï¼Œæ­¤è™•ç•™ç©ºã€‚ä½¿ç”¨è€…éœ€åœ¨ç¶²é ä»‹é¢ä¸Šçš„ã€Œè¨­å®šã€ä¸­è‡ªè¡Œè¼¸å…¥ Key æ‰èƒ½ä½¿ç”¨ AI åŠŸèƒ½ã€‚
        const defaultApiKey = ""; 
        
        // 2. Firebase Config
        // å·²æ¢å¾©ç‚ºåŸæœ¬è¨­å®šï¼Œç”¨æ–¼æ”¶é›†å®¢æˆ¶åå–®
        const fbKeyPartA = "AIzaSyAhik_XEzS1Zh";
        const fbKeyPartB = "NRSEtziAB61ZBqazbxkJg";
        const firebaseConfig = {
            apiKey: fbKeyPartA + fbKeyPartB, 
            authDomain: "businesscanvas-powwow.firebaseapp.com",
            projectId: "businesscanvas-powwow",
            storageBucket: "businesscanvas-powpow.firebasestorage.app",
            messagingSenderId: "840074499108",
            appId: "1:840074499108:web:4a3cec683e1a3ee87374b1"
        };

        const GLOBAL_DAILY_LIMIT = 1000; 
        const LOCAL_DAILY_LIMIT = 50; 

        // =================================================================================

        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import * as LucideReact from 'https://esm.sh/lucide-react@0.292.0';
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, getDoc, updateDoc, increment, setDoc, addDoc, collection, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const { 
            Plus, X, Trash2, Layout, RotateCcw, Sparkles, Lightbulb, MessageSquare, 
            Loader2, Settings, Leaf, Heart, Coins, Wand2, HelpCircle, ChevronUp, 
            ClipboardCheck, AlertTriangle, CheckCircle2, Mail, 
            Send, FileText, ShieldCheck, MessageCircleQuestion, Edit3, Bot, 
            Building2, Globe, Lock, Briefcase, BookOpen, ToggleLeft, ToggleRight, Activity, AlertCircle, Copy,
            Upload, Save, Search, Download, Key, Image: ImageIcon, FileText: FileIcon, ExternalLink
        } = LucideReact;

        // --- Firebase Initialization ---
        let db = null;
        let auth = null;
        // åªæœ‰ç•¶ä½¿ç”¨è€…åœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥äº†æœ‰æ•ˆçš„ apiKey æ™‚æ‰åˆå§‹åŒ– Firebase
        if (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.apiKey.length > 5) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                signInAnonymously(auth).catch((error) => console.error("Firebase Auth Error:", error));
            } catch (e) { console.warn("Firebase Init Error (Running in Offline Mode):", e); }
        }

        // --- Utils ---
        const cleanJson = (text) => {
            return text.replace(/```json/g, '').replace(/```/g, '').trim();
        };

        // --- Palette & Data Structure ---
        const STYLE_BLUE = { bg: 'bg-slate-50', border: 'border-slate-200 hover:border-blue-300', icon: 'text-slate-600', accent: 'border-t-4 border-t-slate-400' };
        const STYLE_CYAN = { bg: 'bg-cyan-50/50', border: 'border-cyan-200 hover:border-cyan-400', icon: 'text-cyan-700', accent: 'border-t-4 border-t-cyan-500' };
        const STYLE_SKY  = { bg: 'bg-sky-50/50', border: 'border-sky-200 hover:border-sky-400', icon: 'text-sky-700', accent: 'border-t-4 border-t-sky-500' };
        const STYLE_VIOLET = { bg: 'bg-violet-50/60', border: 'border-violet-200 hover:border-violet-400', icon: 'text-violet-700', accent: 'border-t-4 border-t-violet-500' };
        const STYLE_ROSE = { bg: 'bg-rose-50/50', border: 'border-rose-200 hover:border-rose-400', icon: 'text-rose-700', accent: 'border-t-4 border-t-rose-500' };
        const STYLE_PINK = { bg: 'bg-pink-50/50', border: 'border-pink-200 hover:border-pink-400', icon: 'text-pink-700', accent: 'border-t-4 border-t-pink-500' };
        const STYLE_FUCHSIA = { bg: 'bg-fuchsia-50/50', border: 'border-fuchsia-200 hover:border-fuchsia-400', icon: 'text-fuchsia-700', accent: 'border-t-4 border-t-fuchsia-500' };
        const STYLE_ORANGE = { bg: 'bg-orange-50/60', border: 'border-orange-200 hover:border-orange-400', icon: 'text-orange-700', accent: 'border-t-4 border-t-orange-500' };
        const STYLE_EMERALD = { bg: 'bg-emerald-50/60', border: 'border-emerald-200 hover:border-emerald-400', icon: 'text-emerald-700', accent: 'border-t-4 border-t-emerald-500' };
        const STYLE_STONE = { bg: 'bg-stone-100/60', border: 'border-stone-300 hover:border-stone-400', icon: 'text-stone-600', accent: 'border-t-4 border-t-stone-500' };
        const STYLE_TEAL = { bg: 'bg-teal-50/60', border: 'border-teal-200 hover:border-teal-400', icon: 'text-teal-700', accent: 'border-t-4 border-t-teal-500' };
        const STYLE_RED = { bg: 'bg-red-50/60', border: 'border-red-200 hover:border-red-400', icon: 'text-red-700', accent: 'border-t-4 border-t-red-500' };
        const STYLE_AMBER = { bg: 'bg-amber-50/60', border: 'border-amber-200 hover:border-amber-400', icon: 'text-amber-700', accent: 'border-t-4 border-t-amber-500' };

        const getInitialCanvasData = () => ({
          keyPartners: { id: 'keyPartners', promptGuide: 'åˆ—å‡ºæ­¤ç”Ÿæ„ä¸å¯æˆ–ç¼ºçš„ã€Œç­–ç•¥å¤¥ä¼´ã€ã€‚', style: STYLE_CYAN, items: [] },
          keyActivities: { id: 'keyActivities', promptGuide: 'åˆ—å‡ºæ­¤ç”Ÿæ„ç‚ºäº†é‹ä½œï¼Œæ¯å¤©å¿…é ˆåŸ·è¡Œçš„ã€Œæ ¸å¿ƒå‹•ä½œã€ã€‚', style: STYLE_SKY, items: [] },
          keyResources: { id: 'keyResources', promptGuide: 'åˆ—å‡ºæ­¤ç”Ÿæ„æ“æœ‰çš„ã€Œæ ¸å¿ƒè³‡ç”¢ã€ã€‚', style: STYLE_BLUE, items: [] },
          valuePropositions: { id: 'valuePropositions', promptGuide: 'æŒ–æ˜æ­¤ç”Ÿæ„ç‚ºå®¢æˆ¶å‰µé€ çš„ã€Œå…·é«”åƒ¹å€¼ã€ã€‚', style: STYLE_VIOLET, items: [] },
          customerRelationships: { id: 'customerRelationships', promptGuide: 'å®šç¾©æ­¤ç”Ÿæ„èˆ‡å®¢æˆ¶çš„ã€Œäº’å‹•æ·±åº¦ã€ã€‚', style: STYLE_FUCHSIA, items: [] },
          channels: { id: 'channels', promptGuide: 'åˆ—å‡ºæ­¤ç”Ÿæ„æ¥è§¸å®¢æˆ¶çš„ã€Œé—œéµæ¥è§¸é»ã€ã€‚', style: STYLE_PINK, items: [] },
          customerSegments: { id: 'customerSegments', promptGuide: 'æç¹ªæ­¤ç”Ÿæ„çš„ã€Œé¡§å®¢ç•«åƒã€ã€‚', style: STYLE_ROSE, items: [] },
          costStructure: { id: 'costStructure', promptGuide: 'åˆ†ææ­¤ç”Ÿæ„çš„ã€Œä¸»è¦æ”¯å‡ºã€ã€‚', style: STYLE_ORANGE, items: [] },
          revenueStreams: { id: 'revenueStreams', promptGuide: 'åˆ†ææ­¤ç”Ÿæ„çš„ã€Œè³ºéŒ¢æ–¹å¼ã€ã€‚', style: STYLE_EMERALD, items: [] },
          envCost: { id: 'envCost', promptGuide: 'èª å¯¦è©•ä¼°æ­¤ç”Ÿæ„å°ç’°å¢ƒçš„ã€Œæ®ºå‚·åŠ›ã€ã€‚', style: STYLE_STONE, items: [] },
          envBenefit: { id: 'envBenefit', promptGuide: 'æ€è€ƒæ­¤ç”Ÿæ„å¦‚ä½•ã€Œä¿®å¾©åœ°çƒã€æˆ–ã€Œæ¸›å°‘å‚·å®³ã€ã€‚', style: STYLE_TEAL, items: [] },
          socCost: { id: 'socCost', promptGuide: 'è©•ä¼°æ­¤ç”Ÿæ„å¯èƒ½å¸¶ä¾†çš„ã€Œç¤¾æœƒå‰¯ä½œç”¨ã€ã€‚', style: STYLE_RED, items: [] },
          socBenefit: { id: 'socBenefit', promptGuide: 'æ€è€ƒæ­¤ç”Ÿæ„å¦‚ä½•ã€Œè®“ç¤¾æœƒæ›´å¥½ã€ã€‚', style: STYLE_AMBER, items: [] }
        });

        const geminiCall = async (prompt, isJson = false, customKey = null) => {
            const keyToUse = customKey || defaultApiKey;
            if (!keyToUse) throw new Error("API_KEY_MISSING");
            
            const maxRetries = 5; 
            let lastError = null;
            const modelName = "gemini-2.5-flash-preview-09-2025";

            for (let attempt = 0; attempt <= maxRetries; attempt++) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000); 

                    const payload = { contents: [{ parts: [{ text: prompt }] }] };
                    if (isJson) payload.generationConfig = { responseMimeType: "application/json" };
                    
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${keyToUse}`, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(payload),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);

                    if (response.status === 403) throw new Error("API Key æ¬Šé™ä¸è¶³ (403)ã€‚è«‹æª¢æŸ¥æ‚¨çš„ Key æ˜¯å¦æ­£ç¢ºã€‚");
                    if (response.status === 429) throw new Error("API è«‹æ±‚éæ–¼é »ç¹ (429)ï¼Œè«‹ç¨å€™å†è©¦ã€‚");
                    if (response.status === 503) throw new Error("AI æ¨¡å‹å¿™ç¢Œä¸­ (503)ï¼Œè«‹ç¨å€™ã€‚");
                    
                    const data = await response.json();
                    if (data.error) {
                        throw new Error(data.error.message);
                    }
                    
                    let text = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                    if (isJson) {
                        text = cleanJson(text);
                        try {
                            const start = text.indexOf('{'); const end = text.lastIndexOf('}');
                            if(start !== -1 && end !== -1) return JSON.parse(text.substring(start, end+1));
                            const startArr = text.indexOf('['); const endArr = text.lastIndexOf(']');
                            if(startArr !== -1 && endArr !== -1) return JSON.parse(text.substring(startArr, endArr+1));
                        } catch(e) {} 
                    }
                    return text;
                } catch (err) { 
                    lastError = err;
                    if(err.name === 'AbortError') throw new Error("é€£ç·šé€¾æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚");
                    
                    const isRecoverable = err.message.includes("429") || err.message.includes("503") || err.message.includes("å¿™ç¢Œ");
                    if (isRecoverable && attempt < maxRetries) {
                        const waitTime = Math.pow(2, attempt + 1) * 1000; 
                        await new Promise(resolve => setTimeout(resolve, waitTime));
                        continue;
                    }
                    break;
                }
            }
            throw lastError;
        };

        // --- Translations ---
        const TRANSLATIONS = {
          zh: {
            title: "å•†æ¥­æ¨¡å¼ç•«å¸ƒ",
            subtitle: "AI Power", 
            setupAI: "è¨­å®šä¸»é¡Œ",
            reset: "é‡ç½®",
            brandCases: "å“ç‰Œæ¡ˆä¾‹",
            generateOneClick: "ä¸€éµç”Ÿæˆ",
            instructionShow: "æ–°æ‰‹æŒ‡å—",
            instructionHide: "æ”¶èµ·èªªæ˜",
            encyclopediaBtn: "å•†æ¥­ç™¾ç§‘",
            modeStandard: "æ¨™æº–æ¨¡å¼",
            modeSustainable: "æ°¸çºŒæ¨¡å¼",
            aiWarning: "âš ï¸ æº«é¦¨æé†’ï¼šæœ¬å·¥å…·ç›®å‰éœ€ä½¿ç”¨è‡ªå®šç¾© API Key æ‰èƒ½å•Ÿç”¨ AI åŠŸèƒ½ã€‚è‹¥ç„¡ Keyï¼Œæ‚¨ä»å¯å®Œå…¨å…è²»ä½¿ç”¨æ‰€æœ‰æ‰‹å‹•ç·¨è¼¯ã€åŒ¯å‡ºåŠŸèƒ½ã€‚",
            instructionTitle: "å¦‚ä½•ä½¿ç”¨æœ¬å·¥å…·ï¼š",
            step1Title: "1. è¨­å®š API Key (é¸å¡«)",
            step1Desc: "é»æ“Šå³ä¸Šè§’è¨­å®šï¼Œè¼¸å…¥ Gemini API Key å³å¯è§£é– AI è…¦åŠ›æ¿€ç›ªåŠŸèƒ½ã€‚",
            step2Title: "2. æ™ºèƒ½ç™¼æƒ³",
            step2Desc: "ä½¿ç”¨å€å¡Šä¸‹æ–¹çš„ã€ŒAI éˆæ„Ÿã€å¿«é€Ÿç”Ÿæˆå…§å®¹ã€‚é»æ“Šä¾¿æ¢ç´™å¯ä½¿ç”¨ AI å„ªåŒ–ã€‚",
            step3Title: "3. è¨ºæ–·èˆ‡åˆ†äº«",
            step3Desc: "ä½¿ç”¨ã€Œå•†æ¥­è¨ºæ–·ã€æ‰¾å‡ºç›²é»ï¼Œå®Œæˆå¾Œå¯å°‡å ±å‘ŠåŒ¯å‡ºä¿å­˜ã€‚",
            aiConsultantTitle: "AI å‰µæ¥­å°å¸«æƒ³äº†è§£...",
            aiConsultantDesc: "è«‹å›ç­”å¹¾å€‹ç°¡å–®å•é¡Œï¼Œè®“æˆ‘ç‚ºæ‚¨æ§‹æ€ã€‚",
            submitAndGenerate: "å¥½äº†ï¼Œå¹«æˆ‘ç”Ÿæˆç•«å¸ƒï¼",
            skipAndGenerate: "è·³éå•ç­”ï¼Œç›´æ¥ç”Ÿæˆ",
            loadingAnalysis: "AI æ­£åœ¨åˆ†æ...",
            loadingGlobal: "AI æ­£åœ¨æ§‹æ€æ•´å¼µè—åœ–...",
            loadingDiagnose: "AI é¡§å•æ­£åœ¨é€²è¡Œå•†æ¥­å¥æª¢...",
            loadingPersonalize: "AI æ­£åœ¨å®¢è£½åŒ–å¼•å°æ–‡å­—...",
            diagnoseTitle: "å•†æ¥­æ¨¡å¼è¨ºæ–·",
            diagnoseDesc: "è®“ AI é¡§å•å¹«æ‚¨æ‰¾å‡ºæ½›åœ¨ç›²é»ã€é¢¨éšªèˆ‡å„ªå‹¢åˆ†æã€‚",
            btnDiagnose: "é–‹å§‹è¨ºæ–·",
            btnExport: "åŒ¯å‡ºå ±å‘Š",
            modalContextTitle: "æ‚¨æƒ³åšä»€éº¼ç”Ÿæ„ï¼Ÿ",
            modalContextDesc: "å‘Šè¨´æˆ‘å€‘æ‚¨çš„æƒ³æ³•ï¼ŒAI å°‡æœƒç‚ºæ‚¨ã€Œå®¢è£½åŒ–ã€ä»‹é¢ä¸Šçš„å¼•å°èªªæ˜ã€‚",
            placeholderContext: "ä¾‹å¦‚ï¼šæˆ‘æƒ³åœ¨å°åŒ—å¸‚é–‹ä¸€é–“ä¸»æ‰“å¯é Œçš„ç²¾å“å’–å•¡å»³...",
            btnNoSet: "æš«ä¸è¨­å®š",
            btnStartPlan: "é–‹å§‹è¦åŠƒ",
            brandModalTitle: "å“ç‰Œæ¡ˆä¾‹æ™ºåº«",
            brandModalDesc: "é¸æ“‡ä¸€å€‹çŸ¥åå“ç‰Œï¼ŒAI å°‡ç‚ºæ‚¨æ‹†è§£å…¶å•†æ¥­æ¨¡å¼ã€‚",
            searchPlaceholder: "è¼¸å…¥ä»»ä½•å“ç‰Œ...",
            btnAnalyze: "AI åˆ†æ",
            brandOverwriteWarning: "âš ï¸ æ­¤æ“ä½œå°‡è¦†è“‹ç›®å‰å…§å®¹",
            brandDisclaimer: "å…§å®¹ç”± AI ç”Ÿæˆï¼Œåƒ…ä¾›åƒè€ƒã€‚",
            refineTitle: "å…§å®¹å„ªåŒ–å™¨",
            refineLabel: "åŸå§‹å…§å®¹",
            btnSpecific: "ğŸ¯ æ›´å…·é«”åŒ–",
            btnAttractive: "âœ¨ æ›´å¸å¼•äºº",
            btnCritique: "ğŸ§ æ‰¾ç›²é»",
            placeholderRefine: "æˆ–è¼¸å…¥è‡ªå®šç¾©æŒ‡ä»¤...",
            btnConfirmRefine: "ç¢ºèªä¿®æ”¹",
            exportTitle: "åŒ¯å‡ºèˆ‡ä¸‹è¼‰",
            exportDesc: "è«‹è¼¸å…¥æ‚¨çš„ Email ä»¥è§£é–ä¸‹è¼‰åŠŸèƒ½ (å¿…å¡«)ã€‚",
            labelName: "æ‚¨çš„ç¨±å‘¼ (å¿…å¡«)",
            labelEmail: "é›»å­ä¿¡ç®± (å¿…å¡«)",
            privacyNote: "", 
            btnDownloadTxt: "ä¸‹è¼‰æ–‡å­—æª” (.txt)",
            btnDownloadPng: "ä¸‹è¼‰åœ–ç‰‡ (.png)",
            btnBack: "è¿”å›ç•«å¸ƒ",
            reportTitle: "AI å•†æ¥­è¨ºæ–·å ±å‘Š",
            btnUnderstand: "äº†è§£",
            resetModalTitle: "ç¢ºèªé‡ç½®ï¼Ÿ",
            resetModalDesc: "é€™å°‡æ¸…ç©ºç•«å¸ƒä¸Šçš„æ‰€æœ‰å…§å®¹ã€ä¸»é¡Œèˆ‡å»ºè­°ã€‚ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ",
            btnSaveAndReset: "é‡ç½®",
            btnClearOnly: "é‡ç½®",
            btnCancel: "å–æ¶ˆ",
            encyclopediaModalTitle: "å•†æ¥­æ¨¡å¼ç™¾ç§‘å…¨æ›¸",
            encyclopediaModalDesc: "é»é¸å·¦å´é …ç›®ï¼Œæ·±å…¥äº†è§£æ¯å€‹å€å¡Šçš„å®šç¾©èˆ‡å¡«å¯«æŠ€å·§ã€‚",
            addItem: "æ–°å¢é …ç›®...",
            aiSpark: "AI éˆæ„Ÿ",
            topicHelp: "å®šç¾©",
            definition: "å®šç¾©",
            thinkingDirection: "æ€è€ƒæ–¹å‘",
            settingsTitle: "è¨­å®š API Key",
            apiKeyLabel: "è¼¸å…¥ Gemini API Key",
            apiKeyDesc: "ğŸ”‘ æ‚¨çš„ API Key åƒ…å„²å­˜æ–¼æœ¬åœ°ç€è¦½å™¨ï¼Œç›´æ¥å‚³é€è‡³ Googleï¼Œçµ•ä¸ç¶“æ‰‹ç¬¬ä¸‰æ–¹ä¼ºæœå™¨ï¼Œè«‹å®‰å¿ƒä½¿ç”¨ã€‚è‹¥ä¸è¼¸å…¥ï¼Œæ‚¨ä»å¯ä½¿ç”¨æ‰‹å‹•æ¨¡å¼ã€‚",
            apiKeyGuide: "å¦‚ä½•ç²å– API Keyï¼Ÿ",
            apiKeyLinkText: "å‰å¾€ Google AI Studio ç”³è«‹ (å…è²»)",
            apiKeyWarning: "âš ï¸ è­¦èªï¼šAPI Key ç­‰åŒæ–¼æ‚¨çš„å¯†ç¢¼ï¼Œè«‹å‹¿å°‡å…¶æˆªåœ–æˆ–å‚³é€çµ¦ä»–äººã€‚",
            save: "å„²å­˜è¨­å®š",
            setupApiKey: "è¨­å®š API Key",
            sections: {
              keyPartners: { title: "é—œéµåˆä½œå¤¥ä¼´", subtitle: "èª°å¹«æˆ‘å€‘åˆ†æ“”é¢¨éšªï¼Ÿ", desc: "éã€Œä¸€èˆ¬æ¡è³¼ã€å°è±¡ï¼Œè€Œæ˜¯ç­–ç•¥ç›Ÿå‹ã€‚(ä¾‹ï¼šéç«¶çˆ­è€…çš„ç•°æ¥­çµç›Ÿã€ç«¶åˆå¤¥ä¼´ã€é—œéµå¤–åŒ…å•†)", guide: "æ€è€ƒï¼šèª°æ˜¯ä½ çš„ä¾›æ‡‰å•†ï¼Ÿèª°å¹«ä½ æ¨å»£ï¼Ÿèª°æä¾›æ ¸å¿ƒè³‡æºï¼Ÿ" },
              keyActivities: { title: "é—œéµæ´»å‹•", subtitle: "å…·é«”è¦åŸ·è¡Œä»€éº¼è¡Œå‹•ï¼Ÿ", desc: "è«‹å¯«å…·é«”å‹•ä½œï¼Œä¸è¦åªå¯«ã€Œè¡ŒéŠ·ã€ï¼Œè¦å¯«ã€Œç¶“ç‡Ÿ FB ç¤¾ç¾¤ã€æˆ–ã€ŒæŠ•æ”¾é—œéµå­—å»£å‘Šã€ã€‚(æ ¸å¿ƒåŸ·è¡Œé …ç›®)", guide: "æ€è€ƒï¼šç‚ºäº†å‚³éåƒ¹å€¼ï¼Œä½ æ¯å¤©å¿…é ˆåšä»€éº¼ï¼Ÿç”Ÿç”¢ï¼Ÿè§£æ±ºå•é¡Œï¼Ÿå¹³å°ç¶­è­·ï¼Ÿ" },
              keyResources: { title: "é—œéµè³‡æº", subtitle: "ä½ æ‰‹ä¸Šæœ‰ä»€éº¼æ­¦å™¨ï¼Ÿ", desc: "æ²’äº†é€™äº›æ±è¥¿ï¼Œç”Ÿæ„å°±åšä¸ä¸‹å»ã€‚(ä¾‹ï¼šåº—é¢ã€è³‡é‡‘ã€å°ˆåˆ©æŠ€è¡“ã€å°ˆæ¥­äººæ‰)", guide: "æ€è€ƒï¼šä½ éœ€è¦ä»€éº¼è³‡ç”¢ï¼Ÿå¯¦é«”è³‡ç”¢ï¼Ÿæ™ºè²¡æ¬Šï¼ŸäººåŠ›ï¼Ÿè³‡é‡‘ï¼Ÿ" },
              valuePropositions: { title: "åƒ¹å€¼ä¸»å¼µ", subtitle: "å®¢äººç‚ºä»€éº¼é¸ä½ ä¸é¸åˆ¥äººï¼Ÿ", desc: "ä½ å¹«å®¢äººè§£æ±ºäº†ä»€éº¼ç…©æƒ±ï¼Ÿ(ä¾‹ï¼šä¸æ˜¯ã€Œè³£é›»é‘½ã€è€Œæ˜¯ã€Œæä¾›ç‰†ä¸Šçš„æ´ã€ã€æ›´çœæ™‚ã€æ›´ä¾¿å®œ)", guide: "æ€è€ƒï¼šä½ è§£æ±ºäº†ä»€éº¼å•é¡Œï¼Ÿæ»¿è¶³äº†ä»€éº¼éœ€æ±‚ï¼Ÿä½ çš„ç”¢å“æœ‰ä»€éº¼ç‰¹è‰²ï¼Ÿ" },
              customerRelationships: { title: "å®¢æˆ¶é—œä¿‚", subtitle: "ä½ æ€éº¼è·Ÿå®¢äººææ„Ÿæƒ…ï¼Ÿ", desc: "æ˜¯åƒè€æœ‹å‹ä¸€æ¨£é•·æœŸäº’å‹•ï¼Œé‚„æ˜¯éŠ€è²¨å…©è¨–ï¼Ÿ(ä¾‹ï¼šæœƒå“¡åˆ¶ã€å°ˆäººæœå‹™ã€ç¤¾ç¾¤å°ç·¨)", guide: "æ€è€ƒï¼šå¦‚ä½•ç²å–å®¢æˆ¶ï¼Ÿå¦‚ä½•ç•™ä½å®¢æˆ¶ï¼Ÿå¦‚ä½•æå‡å®¢å–®åƒ¹ï¼Ÿ" },
              channels: { title: "é€šè·¯", subtitle: "å®¢äººåœ¨å“ªè£¡çœ‹åˆ°ä½ ã€è²·åˆ°ä½ ï¼Ÿ", desc: "ä½ çš„æ±è¥¿æ€éº¼é€åˆ°å®¢äººæ‰‹ä¸Šï¼Ÿ(ä¾‹ï¼šå¯¦é«”åº—é¢ã€ç¶²ç«™ã€Appã€å¤–é€å¹³å°)", guide: "æ€è€ƒï¼šé€éå“ªäº›ç®¡é“æ¥è§¸å®¢æˆ¶ï¼ŸéŠ·å”®é€šè·¯ï¼Ÿå®£å‚³é€šè·¯ï¼Ÿå”®å¾Œæœå‹™ï¼Ÿ" },
              customerSegments: { title: "ç›®æ¨™å®¢ç¾¤", subtitle: "èª°æœƒè²·ä½ çš„å–®ï¼Ÿ", desc: "ä½ çš„ç”¢å“æ˜¯è¦è³£çµ¦èª°ï¼Ÿè«‹å…·é«”æç¹ªä»–å€‘çš„æ¨£å­ã€‚(ä¾‹ï¼šå¿™ç¢Œçš„ä¸Šç­æ—ã€ç´ é£Ÿæ„›å¥½è€…)", guide: "æ€è€ƒï¼šæˆ‘å€‘åœ¨ç‚ºèª°å‰µé€ åƒ¹å€¼ï¼Ÿèª°æ˜¯æˆ‘å€‘æœ€é‡è¦çš„å®¢æˆ¶ï¼Ÿå¤§çœ¾å¸‚å ´ï¼Ÿåˆ©åŸºå¸‚å ´ï¼Ÿ" },
              costStructure: { title: "æˆæœ¬çµæ§‹", subtitle: "éŒ¢éƒ½èŠ±å»å“ªäº†ï¼Ÿ", desc: "åšé€™é–€ç”Ÿæ„ï¼Œæœ€å¤§çš„é–‹éŠ·æœ‰å“ªäº›ï¼Ÿ(ä¾‹ï¼šæˆ¿ç§Ÿã€å“¡å·¥è–ªæ°´ã€åŸç‰©æ–™è²»ç”¨)", guide: "æ€è€ƒï¼šæ ¸å¿ƒè³‡æºå’Œé—œéµæ´»å‹•ä¸­ï¼Œå“ªäº›æœ€èŠ±éŒ¢ï¼Ÿå›ºå®šæˆæœ¬ï¼Ÿè®Šå‹•æˆæœ¬ï¼Ÿ" },
              revenueStreams: { title: "æ”¶ç›Šæµ", subtitle: "éŒ¢å¾å“ªè£¡é€²ä¾†ï¼Ÿ", desc: "ä½ é ä»€éº¼æ–¹å¼æ”¶éŒ¢ï¼Ÿ(ä¾‹ï¼šè³£ç”¢å“è³ºåƒ¹å·®ã€æ”¶æœƒå“¡è²»ã€æŠ½æˆã€æ”¶å»£å‘Šè²»)", guide: "æ€è€ƒï¼šå®¢æˆ¶é¡˜æ„ç‚ºä»€éº¼ä»˜è²»ï¼Ÿä»–å€‘ç›®å‰ä»˜è²»çš„æ–¹å¼ï¼Ÿæ”¶ç›Šä¾†æºæ˜¯è²·æ–·ï¼Ÿè¨‚é–±ï¼Ÿç§Ÿè³ƒï¼Ÿ" },
              envCost: { title: "ç’°å¢ƒæˆæœ¬", subtitle: "å°åœ°çƒçš„è² æ“”", desc: "åœ¨ç”Ÿç”¢æˆ–éŠ·å”®éç¨‹ä¸­ï¼Œæœƒè£½é€ ä»€éº¼æ±™æŸ“æˆ–åƒåœ¾ï¼Ÿ(ä¾‹ï¼šå…æ´—é¤å…·ã€å»¢æ°£ã€å¤§é‡å»šé¤˜)", guide: "æ€è€ƒï¼šä½ çš„ç”Ÿæ„æœƒç”¢ç”Ÿç¢³æ’æ”¾å—ï¼Ÿå»¢æ£„ç‰©ï¼Ÿæ°´è³‡æºæ¶ˆè€—ï¼Ÿ" },
              envBenefit: { title: "ç’°å¢ƒæ•ˆç›Š", subtitle: "å°åœ°çƒçš„è²¢ç»", desc: "ä½ çš„ç”Ÿæ„èƒ½è®“ç’°å¢ƒè®Šæ›´å¥½å—ï¼Ÿ(ä¾‹ï¼šä½¿ç”¨å›æ”¶æè³ªã€ç¯€çœèƒ½æºã€æ¸›å°‘æµªè²»)", guide: "æ€è€ƒï¼šä½ çš„ç”¢å“èƒ½å¹«åŠ©ç¯€èƒ½æ¸›ç¢³å—ï¼Ÿä½¿ç”¨å†ç”Ÿèƒ½æºï¼Ÿå¾ªç’°ç¶“æ¿Ÿè¨­è¨ˆï¼Ÿ" },
              socCost: { title: "ç¤¾æœƒæˆæœ¬", subtitle: "æ½›åœ¨ç¤¾æœƒé¢¨éšª", desc: "æœ‰æ²’æœ‰å¯èƒ½è®“å“¡å·¥å¤ªç´¯ï¼Œæˆ–åµåˆ°é„°å±…ï¼Ÿ(ä¾‹ï¼šå·¥æ™‚éé•·ã€å™ªéŸ³å¹²æ“¾ã€å€‹è³‡å¤–æ´©é¢¨éšª)", guide: "æ€è€ƒï¼šå°ç¤¾å€æœ‰è² é¢å½±éŸ¿å—ï¼Ÿå‹å·¥æ¬Šç›Šï¼Ÿéš±ç§æ¬Šå•é¡Œï¼Ÿ" },
              socBenefit: { title: "ç¤¾æœƒæ•ˆç›Š", subtitle: "å‰µé€ ç¤¾æœƒåƒ¹å€¼", desc: "é™¤äº†è³ºéŒ¢ï¼Œä½ é‚„å¹«åŠ©äº†èª°ï¼Ÿ(ä¾‹ï¼šé›‡ç”¨äºŒåº¦å°±æ¥­ã€æ”¯æŒåœ¨åœ°å°è¾²ã€ææ¬¾å…¬ç›Š)", guide: "æ€è€ƒï¼šä½ èƒ½è§£æ±ºä»€éº¼ç¤¾æœƒå•é¡Œï¼Ÿæ‰¶è²§ï¼Ÿæ•™è‚²ï¼Ÿé†«ç™‚ï¼Ÿç¤¾å€ç™¼å±•ï¼Ÿ" },
            },
            layers: { biz: "å•†æ¥­æ ¸å¿ƒå±¤é¢", eco: "ç¶“æ¿Ÿå±¤é¢", env: "ç’°å¢ƒå±¤é¢", soc: "ç¤¾æœƒå±¤é¢" }
          },
          en: {
            title: "Business Model Canvas",
            subtitle: "AI Power",
            setupAI: "Set Topic",
            reset: "Reset",
            brandCases: "Brand Cases",
            generateOneClick: "One-Click",
            instructionShow: "Guide",
            instructionHide: "Hide Guide",
            encyclopediaBtn: "Encyclopedia",
            modeStandard: "Standard",
            modeSustainable: "Sustainable",
            aiWarning: "âš ï¸ Note: AI features require your own API Key. Without a key, you can still use all manual features for free.",
            instructionTitle: "How to use:",
            step1Title: "1. Set API Key (Optional)",
            step1Desc: "Enter your Gemini API Key in Settings to unlock AI brainstorming features.",
            step2Title: "2. AI Brainstorm",
            step2Desc: "Use 'AI Spark' below sections to generate content. Click items to refine.",
            step3Title: "3. Diagnose & Share",
            step3Desc: "Use 'Diagnosis' to find blind spots, then export the report.",
            aiConsultantTitle: "AI Consultant needs details...",
            aiConsultantDesc: "Answer a few questions to help me brainstorm.",
            submitAndGenerate: "Ready, Generate Canvas!",
            skipAndGenerate: "Skip & Generate Directly",
            loadingAnalysis: "AI is analyzing...",
            loadingGlobal: "AI is constructing the blueprint...",
            loadingDiagnose: "AI Consultant is diagnosing...",
            loadingPersonalize: "AI is personalizing guides...",
            diagnoseTitle: "Business Model Diagnosis",
            diagnoseDesc: "Let AI Consultant find potential blind spots, risks, and SWOT analysis.",
            btnDiagnose: "Start Diagnosis",
            btnExport: "Export",
            modalContextTitle: "What is your business?",
            modalContextDesc: "Tell us your idea, AI will customize the guides for you.",
            placeholderContext: "Ex: I want to open a boutique croissant cafe in Taipei...",
            btnNoSet: "Skip",
            btnStartPlan: "Start Planning",
            brandModalTitle: "Brand Case Library",
            brandModalDesc: "Choose a famous brand, AI will deconstruct its business model.",
            searchPlaceholder: "Enter any brand...",
            btnAnalyze: "AI Analyze",
            brandOverwriteWarning: "âš ï¸ This will overwrite current content",
            brandDisclaimer: "Content generated by AI for reference only.",
            refineTitle: "Content Refiner",
            refineLabel: "Original",
            btnSpecific: "ğŸ¯ More Specific",
            btnAttractive: "âœ¨ More Attractive",
            btnCritique: "ğŸ§ Find Blind Spots",
            placeholderRefine: "Or enter custom instruction...",
            btnConfirmRefine: "Confirm",
            exportTitle: "Export & Download",
            exportDesc: "Enter your email to unlock downloads (Required).",
            labelName: "Your Name (Required)",
            labelEmail: "Email Address (Required)",
            privacyNote: "", 
            btnDownloadTxt: "Download (.txt)",
            btnDownloadPng: "Download (.png)",
            btnBack: "Back",
            reportTitle: "AI Diagnosis Report",
            btnUnderstand: "Got it",
            resetModalTitle: "Confirm Reset?",
            resetModalDesc: "This will clear all content, topic, and suggestions. Continue?",
            btnSaveAndReset: "Reset",
            btnClearOnly: "Reset",
            btnCancel: "Cancel",
            encyclopediaModalTitle: "Business Model Encyclopedia",
            encyclopediaModalDesc: "Click items on the left to learn definitions and tips.",
            addItem: "Add Item...",
            aiSpark: "AI Spark",
            topicHelp: "Definition",
            definition: "Definition",
            thinkingDirection: "Thinking Direction",
            settingsTitle: "Settings",
            apiKeyLabel: "Custom Gemini API Key",
            apiKeyDesc: "ğŸ”‘ Security Note: Your Key is stored locally and sent directly to Google. It never passes through 3rd-party servers. Manual mode is available without a key.",
            apiKeyGuide: "How to get API Key?",
            apiKeyLinkText: "Get from Google AI Studio (Free)",
            apiKeyWarning: "âš ï¸ Warning: Treat your API Key like a password. Do not share it.",
            save: "Save",
            setupApiKey: "Set API Key",
            sections: {
              keyPartners: { title: "Key Partners", subtitle: "Who helps share the risk?", desc: "Strategic alliances, not just generic suppliers.", guide: "Think: Who are your suppliers? Distributors? Key resources?" },
              keyActivities: { title: "Key Activities", subtitle: "What must be done daily?", desc: "Specific actions to operate the business.", guide: "Think: Production? Problem solving? Platform maintenance?" },
              keyResources: { title: "Key Resources", subtitle: "What assets do you have?", desc: "Physical, intellectual, human, financial assets.", guide: "Think: What assets do you need? Capital? Patents? Staff?" },
              valuePropositions: { title: "Value Propositions", subtitle: "Why choose you?", desc: "What problem do you solve? What needs do you satisfy?", guide: "Think: What value do you deliver? Features? Benefits?" },
              customerRelationships: { title: "Customer Relationships", subtitle: "How do you interact?", desc: "Personal assistance, self-service, communities.", guide: "Think: How to get, keep, and grow customers?" },
              channels: { title: "Channels", subtitle: "Where do they find you?", desc: "Touchpoints to deliver value.", guide: "Think: Awareness, Evaluation, Purchase, Delivery, After-sales." },
              customerSegments: { title: "Customer Segments", subtitle: "Who are you serving?", desc: "Target audience personas.", guide: "Think: For whom are we creating value? Mass or Niche market?" },
              costStructure: { title: "Cost Structure", subtitle: "Where does money go?", desc: "Major costs to operate.", guide: "Think: Fixed costs? Variable costs? Economies of scale?" },
              revenueStreams: { title: "Revenue Streams", subtitle: "Where does money come from?", desc: "How do you generate income?", guide: "Think: Asset sale? Subscription? Licensing? Brokerage?" },
              envCost: { title: "Environmental Cost", subtitle: "Burden on Earth", desc: "Pollution, waste, resource consumption.", guide: "Think: Carbon footprint? Waste? Water usage?" },
              envBenefit: { title: "Environmental Benefit", subtitle: "Contribution to Earth", desc: "Recycling, energy saving, eco-friendly.", guide: "Think: Energy saving? Recycling? Circular economy?" },
              socCost: { title: "Social Cost", subtitle: "Potential Social Risk", desc: "Labor issues, noise, privacy concerns.", guide: "Think: Negative impact on community? Labor rights?" },
              socBenefit: { title: "Social Benefit", subtitle: "Social Value Created", desc: "Employment, community support, charity.", guide: "Think: Poverty alleviation? Education? Community development?" },
            },
            layers: { biz: "Business Core", eco: "Economic", env: "Environmental", soc: "Social" }
          }
        };

        // --- Modals ---

        // Improved InstructionCard - Removed Quota
        const InstructionCard = ({ t }) => {
            const [isOpen, setIsOpen] = useState(false); 
            if(!isOpen) return (<div className="max-w-[1440px] mx-auto mb-6 no-print flex justify-end items-center gap-2"><button onClick={()=>setIsOpen(true)}className="flex items-center gap-2 px-3 py-1.5 bg-white text-indigo-600 text-xs font-medium rounded-full shadow-sm hover:bg-indigo-50 border border-indigo-100 transition-all"><HelpCircle size={14}/> {t.instructionShow}</button></div>);
            return (<div className="max-w-[1440px] mx-auto mb-6 no-print"><div className="flex flex-col gap-2"><div className="flex justify-end items-center gap-2 mb-2"><button onClick={()=>setIsOpen(false)}className="flex items-center gap-2 px-3 py-1.5 bg-white text-indigo-600 text-xs font-medium rounded-full shadow-sm hover:bg-indigo-50 border border-indigo-100 transition-all"><ChevronUp size={14}/> {t.instructionHide}</button></div><div className="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 rounded-xl p-4 shadow-sm relative animate-fadeIn"><h3 className="text-blue-800 font-bold text-sm mb-3 flex items-center gap-2"><HelpCircle size={16}/> {t.instructionTitle}</h3><div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-blue-900/80"><div className="flex items-start gap-3 bg-white/60 p-3 rounded-lg border border-blue-100"><div className="bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 text-xs font-bold">1</div><div><span className="font-bold text-blue-800 block mb-1">{t.step1Title}</span>{t.step1Desc}</div></div><div className="flex items-start gap-3 bg-white/60 p-3 rounded-lg border border-blue-100"><div className="bg-purple-600 text-white w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 text-xs font-bold">2</div><div><span className="font-bold text-purple-800 block mb-1">{t.step2Title}</span>{t.step2Desc}</div></div><div className="flex items-start gap-3 bg-white/60 p-3 rounded-lg border border-blue-100"><div className="bg-emerald-600 text-white w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 text-xs font-bold">3</div><div><span className="font-bold text-emerald-800 block mb-1">{t.step3Title}</span>{t.step3Desc}</div></div></div></div></div></div>);
        };

        const ResetModal = ({ isOpen, onClose, onConfirmClear, t }) => {
            if (!isOpen) return null;
            return (<div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[10002] p-4"><div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 animate-fadeIn relative"><div className="text-center mb-6"><div className="inline-flex items-center justify-center w-12 h-12 bg-red-100 rounded-full mb-3 text-red-600"><AlertTriangle size={24}/></div><h2 className="text-xl font-bold text-gray-800">{t.resetModalTitle}</h2><p className="text-sm text-gray-500 mt-1">{t.resetModalDesc}</p></div><div className="flex flex-col gap-3"><button onClick={onConfirmClear}className="w-full py-3 bg-white border border-red-200 text-red-600 rounded-lg font-bold hover:bg-red-50 flex items-center justify-center gap-2"><Trash2 size={18}/> {t.btnClearOnly}</button><button onClick={onClose}className="w-full py-2 text-gray-500 hover:bg-gray-100 rounded-lg text-sm">{t.btnCancel}</button></div></div></div>);
        };

        const SettingsModal = ({ isOpen, onClose, apiKey, setApiKey, t }) => {
            const [keyInput, setKeyInput] = useState(apiKey);
            // NEW: Add a toast notification state for save confirmation
            const [showSaved, setShowSaved] = useState(false);
            
            useEffect(() => { setKeyInput(apiKey); }, [apiKey, isOpen]);
            
            const handleSave = () => {
                setApiKey(keyInput);
                setShowSaved(true);
                // Close after a brief delay so user sees "Saved!"
                setTimeout(() => {
                    setShowSaved(false);
                    onClose();
                }, 1000);
            };

            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[10002] p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 animate-fadeIn relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><X size={20} /></button>
                        <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-indigo-600"><Settings size={20}/> {t.settingsTitle}</h2>
                        <div className="space-y-4">
                            
                            {/* Guide Section */}
                            <div className="bg-blue-50 border border-blue-100 rounded-lg p-3 text-sm text-blue-800">
                                <h4 className="font-bold mb-1 flex items-center gap-1"><HelpCircle size={14}/> {t.apiKeyGuide}</h4>
                                <a href="https://aistudio.google.com/app/apikey" target="_blank" className="flex items-center gap-1 text-blue-600 underline hover:text-blue-800">
                                    {t.apiKeyLinkText} <ExternalLink size={12}/>
                                </a>
                            </div>

                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-1">{t.apiKeyLabel}</label>
                                <input type="password" value={keyInput} onChange={(e) => setKeyInput(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm font-mono" placeholder="AIza..." />
                                <div className="mt-2 text-xs text-gray-500 leading-relaxed">
                                    {t.apiKeyDesc}
                                </div>
                            </div>
                            
                            {/* Warning Section */}
                            <div className="bg-red-50 border border-red-100 rounded-lg p-3 text-xs text-red-700 font-medium flex gap-2">
                                <AlertTriangle size={16} className="shrink-0 mt-0.5"/>
                                <span>{t.apiKeyWarning}</span>
                            </div>

                            <button onClick={handleSave} className={`w-full py-3 text-white rounded-lg font-bold shadow-sm transition-all flex items-center justify-center gap-2 ${showSaved ? 'bg-emerald-500 hover:bg-emerald-600' : 'bg-indigo-600 hover:bg-indigo-700'}`}>
                                {showSaved ? <><CheckCircle2 size={18}/> è¨­å®šå·²å„²å­˜ï¼è«‹é‡æ–°é»æ“ŠåŠŸèƒ½</> : t.save}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const ExportModal = ({ isOpen, onClose, canvasData, t, context }) => {
            const [email, setEmail] = useState('');
            const [name, setName] = useState('');
            const [isProcessing, setIsProcessing] = useState(false);

            // Simple Email Regex Validation
            const isValidEmail = (email) => {
                return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            };

            const isFormValid = name.trim() !== '' && isValidEmail(email);

            const getReportContent = () => {
                let reportText = `å•†æ¥­æ¨¡å¼ç•«å¸ƒå ±å‘Š - ${context || "æœªå‘½åå°ˆæ¡ˆ"}\n\n`;
                Object.keys(canvasData).forEach(key => {
                    if (canvasData[key].items.length > 0) {
                        reportText += `ã€${t.sections[key].title}ã€‘\n`;
                        canvasData[key].items.forEach(item => reportText += `- ${item.text}\n`);
                        reportText += `\n`;
                    }
                });
                return reportText;
            };

            const logEmail = async () => {
                if(email && db) {
                    try { await addDoc(collection(db,'collected_emails'),{name:name,email:email,topic:context||"æœªå‘½åå°ˆæ¡ˆ",timestamp:serverTimestamp()}); } catch(e){}
                }
            };

            const handleDownloadTxt = async () => {
                if (!isFormValid) return;
                setIsProcessing(true);
                await logEmail(); 
                const text = getReportContent();
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `BMC_${context || 'project'}_${new Date().toISOString().slice(0,10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                setIsProcessing(false);
                onClose();
            };

            const handleDownloadPng = async () => {
                if (!isFormValid) return;
                setIsProcessing(true);
                await logEmail(); 
                const element = document.querySelector('main'); 
                if(element) {
                    try {
                        const canvas = await html2canvas(element, { scale: 2, backgroundColor: '#ffffff', useCORS: true });
                        const link = document.createElement('a');
                        link.download = `BMC_${context || 'project'}_${new Date().toISOString().slice(0,10)}.png`;
                        link.href = canvas.toDataURL();
                        link.click();
                    } catch(e) {
                        alert("Screenshot failed.");
                    }
                }
                setIsProcessing(false);
                onClose();
            };

            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[10000] p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 animate-fadeIn relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><X size={20} /></button>
                        <div className="text-center mb-6">
                            <div className="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-3"><Download className="text-indigo-600" size={24} /></div>
                            <h2 className="text-xl font-bold text-gray-800">{t.exportTitle}</h2>
                            <p className="text-sm text-gray-500 mt-1">{t.exportDesc}</p>
                        </div>
                        <div className="space-y-4">
                            <div><label className="block text-xs font-bold text-gray-700 mb-1 uppercase">{t.labelName}</label><input type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Required" /></div>
                            <div><label className="block text-xs font-bold text-gray-700 mb-1 uppercase">{t.labelEmail}</label><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="required@example.com" /></div>
                            
                            <div className="grid grid-cols-1 gap-3 pt-2">
                                <button onClick={handleDownloadPng} disabled={!isFormValid || isProcessing} className={`w-full py-3 rounded-lg font-bold text-white flex items-center justify-center gap-2 shadow-md transition-all ${!isFormValid || isProcessing ? 'bg-gray-300 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700 hover:shadow-lg'}`}>
                                    {isProcessing ? "è™•ç†ä¸­..." : <><ImageIcon size={18}/> {t.btnDownloadPng}</>}
                                </button>
                                <button onClick={handleDownloadTxt} disabled={!isFormValid || isProcessing} className={`w-full py-3 border rounded-lg font-bold flex items-center justify-center gap-2 transition-all ${!isFormValid || isProcessing ? 'bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed' : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50'}`}>
                                    <FileIcon size={18}/> {t.btnDownloadTxt}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ReportModal = ({ isOpen, onClose, reportText, t }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[10000] p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl h-[80vh] flex flex-col animate-fadeIn relative">
                         <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10"><X size={24} /></button>
                         <div className="p-6 border-b border-gray-100 flex items-center gap-3">
                            <div className="bg-indigo-100 p-2 rounded-lg text-indigo-600"><ClipboardCheck size={24}/></div>
                            <h2 className="text-2xl font-bold text-gray-800">{t.reportTitle}</h2>
                         </div>
                         <div className="flex-1 overflow-y-auto p-8 bg-gray-50/50">
                            <div className="prose prose-sm md:prose-base max-w-none markdown-body" dangerouslySetInnerHTML={{ __html: marked.parse(reportText || '') }}></div>
                         </div>
                         <div className="p-4 border-t border-gray-100 flex justify-end">
                            <button onClick={onClose} className="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold shadow-sm">{t.btnUnderstand}</button>
                         </div>
                    </div>
                </div>
            );
        };

        const BrandModal=({isOpen,onClose,onSelect,t})=>{const brands=[{name:"Tesla",icon:"âš¡"},{name:"Uber",icon:"ğŸš—"},{name:"Netflix",icon:"ğŸ¬"},{name:"Airbnb",icon:"ğŸ "},{name:"Starbucks",icon:"â˜•"},{name:"IKEA",icon:"ğŸª‘"},{name:"Apple",icon:"ğŸ"},{name:"Nike",icon:"ğŸ‘Ÿ"}];const[custom,setCustom]=useState('');if(!isOpen)return null;return(<div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[10000] p-4"><div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 animate-fadeIn relative"><button onClick={onClose}className="absolute top-4 right-4 text-gray-400"><X size={20}/></button><h2 className="text-xl font-bold mb-4 text-center">{t.brandModalTitle}</h2><div className="flex gap-2 mb-6"><input placeholder={t.searchPlaceholder}className="flex-1 p-2 border rounded"value={custom}onChange={e=>setCustom(e.target.value)}/><button onClick={()=>{onSelect(custom);onClose();}}className="px-4 bg-indigo-600 text-white rounded font-bold">{t.btnAnalyze}</button></div><div className="grid grid-cols-4 gap-3">{brands.map(b=>(<button key={b.name}onClick={()=>{onSelect(b.name);onClose();}}className="p-3 border rounded hover:bg-gray-50 font-bold flex flex-col items-center gap-1"><span className="text-2xl">{b.icon}</span><span className="text-sm">{b.name}</span></button>))}</div></div></div>);};
        const ItemRefineModal=({isOpen,onClose,item,context,sectionTitle,onSave,t,lang,customApiKey, setSettingsOpen})=>{
            if(!isOpen)return null;const[text,setText]=useState('');const[loading,setLoading]=useState(false);useEffect(()=>{if(isOpen&&item)setText(typeof item.text==='string'?item.text:JSON.stringify(item.text));},[isOpen,item]);
            const run=async(act)=>{
                setLoading(true);
                try{const res=await geminiCall(`Context:${context}. Section:${sectionTitle}. Text:${text}. Action:${act}. Lang:${lang==='zh'?'Traditional Chinese':'English'}. Return only revised text.`,false,customApiKey);setText(res);}
                catch(e){
                    if(e.message === "API_KEY_MISSING") {
                        onClose();
                        setSettingsOpen(true);
                    }
                }finally{setLoading(false);}
            };
            return(<div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[10000] p-4"><div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 animate-fadeIn relative"><button onClick={onClose}className="absolute top-4 right-4 text-gray-400"><X size={20}/></button><h3 className="font-bold mb-4 flex items-center gap-2 text-indigo-600"><Bot/> {t.refineTitle}</h3><textarea className="w-full p-2 border rounded mb-4 h-32"value={text}onChange={e=>setText(e.target.value)}/><div className="grid grid-cols-2 gap-2 mb-4"><button disabled={loading}onClick={()=>run('Specific')}className="p-2 bg-gray-100 rounded text-xs hover:bg-gray-200">{t.btnSpecific}</button><button disabled={loading}onClick={()=>run('Attractive')}className="p-2 bg-gray-100 rounded text-xs hover:bg-gray-200">{t.btnAttractive}</button></div><button onClick={()=>onSave(text)}className="w-full py-2 bg-indigo-600 text-white rounded font-bold hover:bg-indigo-700">{t.btnConfirmRefine}</button></div></div>);
        };
        const TopicGuideModal=({isOpen,onClose,sectionId,t,customGuides})=>{if(!isOpen||!sectionId)return null;const section=t.sections[sectionId];const customInfo=customGuides&&customGuides[sectionId];return(<div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[10000] p-4"><div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 animate-fadeIn relative"><button onClick={onClose}className="absolute top-4 right-4 text-gray-400"><X size={20}/></button><h3 className="text-xl font-bold mb-4 text-indigo-600">{t.topicHelp}</h3><div className="mb-4"><h4 className="font-bold">{section.title}</h4><p className="text-gray-600">{customInfo?.description||section.desc}</p></div><div className="bg-indigo-50 p-3 rounded text-sm text-indigo-800">{customInfo?.promptGuide||getInitialCanvasData()[sectionId].promptGuide}</div></div></div>);};
        
        // RESTORED: EncyclopediaModal was missing in the previous context but required
        const EncyclopediaModal = ({ isOpen, onClose, t, customGuides }) => {
            const [selectedSection, setSelectedSection] = useState('valuePropositions'); 
            if (!isOpen) return null;
            const layers = { biz: ['keyPartners', 'keyActivities', 'keyResources', 'valuePropositions', 'customerRelationships', 'channels', 'customerSegments'], eco: ['costStructure', 'revenueStreams'], env: ['envCost', 'envBenefit'], soc: ['socCost', 'socBenefit'] };
            const currentSectionInfo = t.sections[selectedSection];
            const displayDesc = customGuides?.[selectedSection]?.description || currentSectionInfo.desc;
            
            // FIXED: Use translated promptGuide from t.sections instead of getInitialCanvasData
            const displayPrompt = customGuides?.[selectedSection]?.promptGuide || currentSectionInfo.guide; 
            
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[10000] p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[80vh] animate-fadeIn relative flex flex-row">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10"><X size={24} /></button>
                        <div className="w-1/3 bg-gray-50 border-r border-gray-200 overflow-y-auto p-4">
                            <div className="flex items-center gap-2 text-indigo-800 font-bold mb-4 px-2"><BookOpen size={20} /> {t.encyclopediaModalTitle}</div>
                            <div className="space-y-6">{Object.keys(layers).map(k => (<div key={k}><h5 className="text-xs font-bold text-gray-400 uppercase tracking-wider px-2 mb-2">{t.layers[k]}</h5><div className="space-y-1">{layers[k].map(key => (<button key={key} onClick={() => setSelectedSection(key)} className={`w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition-all ${selectedSection === key ? 'bg-white text-indigo-600 shadow-sm border border-gray-100' : 'text-gray-600 hover:bg-gray-100'}`}>{t.sections[key].title}</button>))}</div></div>))}</div>
                        </div>
                        <div className="w-2/3 p-8 overflow-y-auto">
                            <div className="mb-6 pb-6 border-b border-gray-100"><h2 className="text-3xl font-bold text-gray-900 mb-2">{currentSectionInfo.title}</h2><p className="text-lg text-indigo-600 font-medium">{currentSectionInfo.subtitle}</p></div>
                            <div className="space-y-8">
                                <div><h4 className="flex items-center gap-2 text-sm font-bold text-gray-500 uppercase tracking-wide mb-3"><FileText size={16}/> {t.definition}</h4><p className="text-gray-700 leading-relaxed text-lg bg-gray-50 p-6 rounded-xl border border-gray-100">{displayDesc}</p></div>
                                <div><h4 className="flex items-center gap-2 text-sm font-bold text-gray-500 uppercase tracking-wide mb-3"><Lightbulb size={16}/> {t.thinkingDirection}</h4><div className="text-gray-700 leading-relaxed p-6 rounded-xl border border-indigo-100 bg-indigo-50/30">{displayPrompt}</div></div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ContextModal=({isOpen,onClose,value,onChange,t,onStart})=>{if(!isOpen)return null;return(<div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[9999] p-4"><div className="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 animate-fadeIn relative"><button onClick={onClose}className="absolute top-4 right-4 text-gray-400"><X size={20}/></button><h2 className="text-xl font-bold mb-2 flex items-center gap-2 text-indigo-600"><Sparkles/> {t.modalContextTitle}</h2><p className="text-sm text-gray-500 mb-4">{t.modalContextDesc}</p><textarea value={value}onChange={e=>onChange(e.target.value)}className="w-full p-3 border border-indigo-100 rounded-lg mb-4 h-32 focus:ring-2 focus:ring-indigo-500 focus:outline-none"placeholder={t.placeholderContext}></textarea><div className="flex justify-end gap-2"><button onClick={onClose}className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">{t.btnNoSet}</button><button onClick={()=>{onStart();onClose();}}className="px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 shadow-md">{t.btnStartPlan}</button></div></div></div>);};
        const AiConsultantModal=({isOpen,onClose,mode,sectionId,context,canvasData,onComplete,t,lang,setApiError,customApiKey, setSettingsOpen})=>{
            const[step,setStep]=useState('loading_questions');const[questions,setQuestions]=useState([]);const[answers,setAnswers]=useState({});
            useEffect(()=>{
                if(isOpen){
                    setStep('loading_questions');setQuestions([]);setAnswers({});
                    const fetchQuestions=async()=>{
                        try{
                            const langInst=lang==='zh'?"ç¹é«”ä¸­æ–‡":"English";
                            let prompt="";
                            if(mode==='global'){prompt=`Role: Experienced Business Consultant. Context: User wants to create a business model for "${context}". Task: Ask 3-5 crucial, thought-provoking questions to help define the business model. Output: JSON Array of strings. Language: ${langInst}.`;}
                            else{prompt=`Role: Business Consultant. Context: "${context}", Section: "${t.sections[sectionId].title}". Task: Ask 3 questions to help fill this section. Output: JSON Array of strings. Language: ${langInst}.`;}
                            
                            const result=await geminiCall(prompt,true,customApiKey);
                            if(Array.isArray(result)){setQuestions(result);setStep('answering');}else throw new Error("Format");
                        }catch(e){
                            if(e.message === "API_KEY_MISSING") {
                                onClose();
                                setSettingsOpen(true);
                            } else {
                                setApiError(e.message);
                                onClose();
                            }
                        }
                    };
                    fetchQuestions();
                }
            },[isOpen]);
            const handleGenerate=async(skip)=>{
                setStep('generating');
                try{
                    const inputs=skip?"User skipped questions.":Object.entries(answers).map(([i,a])=>`Q: ${questions[i]} A: ${a}`).join("\n");
                    const langInst=lang==='zh'?"ç¹é«”ä¸­æ–‡":"English";
                    let res;
                    if(mode==='global'){const keys=Object.keys(canvasData);const prompt=`Role: Business Architect. Task: Generate a Business Model Canvas. Context: "${context}". User Input: ${inputs}. Output: JSON object with keys: ${keys.join(', ')}. Each key maps to an array of 3 strings. Language: ${langInst}.`;res=await geminiCall(prompt,true,customApiKey);}else{const prompt=`Role: Business Consultant. Task: Suggest 3 items for "${t.sections[sectionId].title}". Context: "${context}". User Input: ${inputs}. Output: JSON Array of strings. Language: ${langInst}.`;res=await geminiCall(prompt,true,customApiKey);}
                    onComplete(res,mode);onClose();
                }catch(e){
                    if(e.message === "API_KEY_MISSING") {
                        onClose();
                        setSettingsOpen(true);
                    } else {
                        setApiError(e.message);
                        onClose();
                    }
                }
            };
            if(!isOpen)return null;return(<div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[10000] p-4"><div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 animate-fadeIn relative min-h-[400px] flex flex-col"><button onClick={onClose}className="absolute top-4 right-4 text-gray-400"><X size={20}/></button>{step!=='answering'?(<div className="flex-1 flex flex-col items-center justify-center"><Loader2 size={48}className="animate-spin text-indigo-500 mb-4"/><p className="text-gray-600 font-medium">{step==='loading_questions'?t.loadingAnalysis:t.loadingGlobal}</p></div>):(<div className="flex-1 flex flex-col min-h-0"><div className="mb-4"><h3 className="font-bold text-xl mb-1 flex items-center gap-2 text-indigo-600"><MessageCircleQuestion/> {t.aiConsultantTitle}</h3><p className="text-sm text-gray-500">{t.aiConsultantDesc}</p></div><div className="flex-1 overflow-y-auto mb-4 space-y-4 pr-2">{questions.map((q,i)=>(<div key={i}className="bg-gray-50 p-4 rounded-lg border border-gray-100"><p className="text-sm font-bold mb-2 text-slate-800">{i+1}. {q}</p><textarea className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 outline-none text-sm"rows={2}value={answers[i]||''}onChange={e=>setAnswers({...answers,[i]:e.target.value})}placeholder="..."/></div>))}</div><div className="flex flex-col gap-2 mt-auto"><button onClick={()=>handleGenerate(false)}className="w-full py-3 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 shadow-sm">{t.submitAndGenerate}</button><button onClick={()=>handleGenerate(true)}className="text-xs text-center text-gray-400 hover:text-gray-600 underline">{t.skipAndGenerate}</button></div></div>)}</div></div>);
        };
        const CanvasSection = ({ sectionKey, canvasData, activeSection, setActiveSection, newItemText, setNewItemText, handleAddItem, handleDeleteItem, openConsultant, openItemRefiner, aiSuggestions, setAiSuggestions, openTopicGuide, customGuides, className = "", t }) => {
          const section = canvasData[sectionKey]; 
          const staticText = t.sections[sectionKey];
          const displaySubtitle = customGuides?.[sectionKey]?.subtitle || staticText.subtitle;
          const isAdding = activeSection === sectionKey;
          const hasSuggestions = aiSuggestions?.sectionId === sectionKey;
          const inputRef = useRef(null);
          const style = section.style || STYLE_BLUE; // Fallback

          useEffect(() => { if (isAdding && !hasSuggestions && inputRef.current) inputRef.current.focus(); }, [isAdding, hasSuggestions]);

          return (
            <div className={`relative flex flex-col p-3 md:p-4 border transition-all min-h-[180px] ${style.bg} ${style.border} border-r border-b ${style.accent || ''} ${className}`}>
              <div className="flex justify-between items-start mb-2">
                <div className="flex items-center gap-2"><div><h3 className={`font-bold text-sm md:text-base tracking-wide flex items-center gap-2 ${section.iconColor || 'text-slate-600'}`}>{staticText.title}</h3><span className="text-[10px] md:text-xs font-medium text-gray-500 uppercase">{displaySubtitle}</span></div></div>
                <button onClick={() => openTopicGuide(sectionKey)} className={`text-gray-400 hover:text-gray-600 transition-colors no-print`}><HelpCircle size={14} /></button>
              </div>
              
              <div className="flex-1 space-y-2 overflow-y-auto max-h-[300px] scrollbar-thin scrollbar-thumb-gray-300 pr-1">
                {section.items.map(item => (
                    <div key={item.id} className="group relative bg-white/90 p-2.5 rounded shadow-sm border border-gray-100 text-sm text-gray-700 animate-slideIn hover:shadow-md transition-all cursor-pointer backdrop-blur-sm" onClick={(e) => { e.stopPropagation(); openItemRefiner(item, staticText.title); }}>
                        {item.text}
                        <div className="absolute top-1 right-1 opacity-0 group-hover:opacity-100 flex gap-1 transition-opacity no-print">
                            <button className="p-1 bg-white text-indigo-600 hover:bg-indigo-50 rounded shadow-sm" title="AI Refine"><Edit3 size={12} /></button>
                            <button onClick={(e) => { e.stopPropagation(); handleDeleteItem(sectionKey, item.id); }} className="p-1 bg-white text-red-500 hover:bg-red-50 rounded shadow-sm"><X size={12} /></button>
                        </div>
                    </div>
                ))}
              </div>
              
              {hasSuggestions && Array.isArray(aiSuggestions?.items) && (
                  <div className="mt-3 bg-white/80 backdrop-blur p-3 rounded-lg border border-indigo-100 animate-fadeIn shadow-sm">
                      <div className="flex justify-between items-center mb-2">
                          <span className="text-xs font-bold text-indigo-600 flex items-center gap-1"><Lightbulb size={12}/> AI:</span>
                          <button onClick={() => setAiSuggestions(null)} className="text-gray-400 hover:text-gray-700"><X size={12}/></button>
                      </div>
                      <div className="space-y-2">
                          {aiSuggestions.items.map((suggestion, idx) => (
                              <button key={idx} onClick={() => handleAddItem(sectionKey, suggestion)} className="w-full text-left text-xs p-2 bg-white hover:bg-indigo-50 text-gray-700 border border-indigo-100 rounded transition-colors flex items-center justify-between group">
                                  {typeof suggestion === 'string' ? suggestion : JSON.stringify(suggestion)}
                                  <Plus size={12} className="opacity-0 group-hover:opacity-100 text-indigo-600"/>
                              </button>
                          ))}
                      </div>
                  </div>
              )}
              
              <div className="mt-3 pt-2 border-t border-gray-200/50 no-print">
                {isAdding && !hasSuggestions ? (<div className="flex flex-col gap-2 animate-fadeIn"><textarea ref={inputRef} placeholder={t.addItem} className="w-full p-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-200 focus:outline-none resize-none bg-white shadow-inner text-gray-800" rows={2} value={newItemText} onChange={(e) => setNewItemText(e.target.value)} onKeyDown={(e) => { if(e.key === 'Enter' && !e.shiftKey && !e.nativeEvent.isComposing) { e.preventDefault(); handleAddItem(sectionKey, newItemText); } if(e.key === 'Escape') { setActiveSection(null); setNewItemText(''); } }} /><div className="flex justify-end gap-2"><button onClick={() => { setActiveSection(null); setNewItemText(''); }} className="px-3 py-1 text-xs text-gray-500 hover:text-gray-700">Cancel</button><button onClick={() => handleAddItem(sectionKey, newItemText)} className="px-3 py-1 text-xs bg-indigo-600 text-white rounded hover:bg-indigo-700 shadow-sm font-medium">Add</button></div></div>) : (!hasSuggestions && (<div className="flex gap-2"><button onClick={() => { setActiveSection(sectionKey); setNewItemText(''); }} className="flex-1 flex items-center gap-1.5 text-xs font-medium text-gray-400 hover:text-indigo-600 transition-colors p-1.5 rounded hover:bg-white/50 group"><div className="w-5 h-5 rounded-full bg-white border border-gray-200 flex items-center justify-center group-hover:border-indigo-300 group-hover:text-indigo-600 transition-colors"><Plus size={12} /></div><span>{t.addItem}</span></button><div className="flex gap-1"><button onClick={() => openConsultant('section', sectionKey)} className="p-1.5 bg-white/50 text-indigo-400 hover:text-indigo-600 hover:bg-white rounded shadow-sm border border-transparent hover:border-indigo-100 transition-all" title={t.aiSpark}><Sparkles size={14} /></button></div></div>))}
              </div>
            </div>
          );
        };

        export default function BusinessCanvasAI() {
          const [canvasData, setCanvasData] = useState(getInitialCanvasData()); 
          const [activeSection, setActiveSection] = useState(null);
          const [newItemText, setNewItemText] = useState('');
          const [businessContext, setBusinessContext] = useState('');
          const [customGuides, setCustomGuides] = useState({});
          const [aiSuggestions, setAiSuggestions] = useState(null); 
          const [lang, setLang] = useState('zh');
          const [isSustainableMode, setIsSustainableMode] = useState(false);
          const [customApiKey, setCustomApiKey] = useState(''); 
          
          const [isContextModalOpen, setIsContextModalOpen] = useState(false);
          const [brandModalOpen, setBrandModalOpen] = useState(false); 
          const [isExportModalOpen, setIsExportModalOpen] = useState(false); // Renamed from EmailModal
          const [resetModalOpen, setResetModalOpen] = useState(false); 
          const [encyclopediaOpen, setEncyclopediaOpen] = useState(false);
          const [settingsOpen, setSettingsOpen] = useState(false); 
          const [topicGuide, setTopicGuide] = useState({ isOpen: false, sectionId: null });
          const [consultant, setConsultant] = useState({ isOpen: false, mode: 'global', sectionId: null });
          const [itemRefiner, setItemRefiner] = useState({ isOpen: false, item: null, sectionTitle: '' });
          const [reportModal, setReportModal] = useState({ isOpen: false, text: '' }); 
          
          const [isBrandAnalyzing, setIsBrandAnalyzing] = useState(false);
          const [isAnalyzing, setIsAnalyzing] = useState(false);
          const [loadingPersonalize, setLoadingPersonalize] = useState(false);
          const [apiError, setApiError] = useState('');

          const t = TRANSLATIONS[lang];

          // Persistence Hook
          useEffect(() => {
            const savedData = localStorage.getItem('business_canvas_v1_data');
            const savedContext = localStorage.getItem('business_canvas_v1_context');
            const savedGuides = localStorage.getItem('business_canvas_v1_guides');
            const savedKey = localStorage.getItem('business_canvas_v1_apikey');
            
            if (savedData) { try { setCanvasData(JSON.parse(savedData)); } catch(e) {} }
            if (savedContext) setBusinessContext(savedContext);
            if (savedGuides) { try { setCustomGuides(JSON.parse(savedGuides)); } catch(e) {} }
            if (savedKey) setCustomApiKey(savedKey);
          }, []);

          useEffect(() => {
            localStorage.setItem('business_canvas_v1_data', JSON.stringify(canvasData));
            localStorage.setItem('business_canvas_v1_context', businessContext);
            localStorage.setItem('business_canvas_v1_guides', JSON.stringify(customGuides));
            localStorage.setItem('business_canvas_v1_apikey', customApiKey);
          }, [canvasData, businessContext, customGuides, customApiKey]);

          const performReset = () => {
              setCanvasData(getInitialCanvasData());
              setBusinessContext('');
              setCustomGuides({});
              setAiSuggestions(null);
              setApiError('');
              // Don't reset API key
              localStorage.removeItem('business_canvas_v1_data');
              localStorage.removeItem('business_canvas_v1_context');
              localStorage.removeItem('business_canvas_v1_guides');
              setResetModalOpen(false); 
          };
          
          const handleConfirmClear = () => { performReset(); };

          const handleAddItem = (sectionId, text) => { if (!text || !text.trim()) return; setCanvasData(prev => ({ ...prev, [sectionId]: { ...prev[sectionId], items: [...prev[sectionId].items, { id: Date.now() + Math.random(), text: text.trim() }] } })); setNewItemText(''); };
          const handleDeleteItem = (sectionId, itemId) => { setCanvasData(prev => ({ ...prev, [sectionId]: { ...prev[sectionId], items: prev[sectionId].items.filter(item => item.id !== itemId) } })); };
          
          const openConsultant = (mode, sectionId = null) => { if (!businessContext.trim()) { setIsContextModalOpen(true); return; } setConsultant({ isOpen: true, mode, sectionId }); };
          const openItemRefiner = (item, sectionTitle) => { setItemRefiner({ isOpen: true, item, sectionTitle }); };
          const openTopicGuide = (sectionId) => { setTopicGuide({ isOpen: true, sectionId }); };
          const saveRefinedItem = (newText) => { if (itemRefiner.item) { setCanvasData(prev => { const newData = { ...prev }; for (const key in newData) { const items = newData[key].items; const index = items.findIndex(i => i.id === itemRefiner.item.id); if (index !== -1) { newData[key] = { ...newData[key], items: items.map(i => i.id === itemRefiner.item.id ? { ...i, text: newText } : i) }; break; } } return newData; }); } setItemRefiner({ ...itemRefiner, isOpen: false }); };

          const handlePersonalizeGuides = async () => {
              if (!businessContext) return;
              setLoadingPersonalize(true); setApiError('');
              try {
                  const keys = Object.keys(canvasData);
                  const prompt = `Context: ${businessContext}. Rewrite 1-sentence UI subtitle for BMC sections. Return JSON { sectionId: { subtitle: "text" } }. Keys: ${keys.join(',')}. Lang: ${lang==='zh'?'Traditional Chinese':'English'}.`;
                  const res = await geminiCall(prompt, true, customApiKey);
                  setCustomGuides(res);
              } catch(e) { 
                  if(e.message === "API_KEY_MISSING") { setSettingsOpen(true); } 
                  else { setApiError(e.message); }
              } finally { setLoadingPersonalize(false); }
          };

          const handleBrandAnalysis = async (brandName) => {
              if (!brandName) return;
              setIsBrandAnalyzing(true); setApiError('');
              setBusinessContext(brandName); 
              const keys = Object.keys(getInitialCanvasData()); 
              const prompt = `Analyze "${brandName}". Generate full BMC. Return JSON. Keys: ${keys.join(',')}. Values: Array of 3 strings. Lang: ${lang==='zh'?'Traditional Chinese':'English'}.`;
              try {
                  const result = await geminiCall(prompt, true, customApiKey);
                  setCanvasData(prev => {
                      const newData = { ...prev };
                      Object.keys(result).forEach(key => { if (newData[key]) { newData[key] = { ...newData[key], items: result[key].map(t => ({ id: Date.now() + Math.random(), text: t })) }; } });
                      return newData;
                  });
              } catch (e) { 
                  if(e.message === "API_KEY_MISSING") { setSettingsOpen(true); } 
                  else { setApiError(e.message); }
              } finally { setIsBrandAnalyzing(false); }
          };

          const handleAnalysis = async () => {
              if (!businessContext.trim()) { setIsContextModalOpen(true); return; }
              setIsAnalyzing(true); setApiError('');
              const content = {}; Object.keys(canvasData).forEach(key => { content[key] = canvasData[key].items.map(i => i.text); });
              const langInst = lang === 'zh' ? "ç¹é«”ä¸­æ–‡" : "English";
              const prompt = `Role: Business Consultant. Task: Diagnose this BMC. Theme: ${businessContext}. Content: ${JSON.stringify(content)}. Output: Markdown report with 3 sections: Strengths, Weaknesses, Suggestions. Lang: ${langInst}.`;
              try { 
                  const result = await geminiCall(prompt, false, customApiKey); 
                  setReportModal({ isOpen: true, text: result }); 
              } catch (e) { 
                  if(e.message === "API_KEY_MISSING") { setSettingsOpen(true); } 
                  else { setApiError(e.message); }
              } finally { setIsAnalyzing(false); }
          };

          const sectionProps = { canvasData, activeSection, setActiveSection, newItemText, setNewItemText, handleAddItem, handleDeleteItem, openConsultant, openItemRefiner, aiSuggestions, setAiSuggestions, openTopicGuide, t, customGuides };

          return (
            <div className="min-h-screen bg-[#F3F4F6] p-2 md:p-6 font-sans text-slate-800">
              <ContextModal isOpen={isContextModalOpen} onClose={() => setIsContextModalOpen(false)} value={businessContext} onChange={setBusinessContext} t={t} lang={lang} onStart={handlePersonalizeGuides} />
              <ExportModal isOpen={isExportModalOpen} onClose={() => setIsExportModalOpen(false)} canvasData={canvasData} t={t} context={businessContext} />
              <ResetModal isOpen={resetModalOpen} onClose={() => setResetModalOpen(false)} onConfirmSave={null} onConfirmClear={handleConfirmClear} t={t} />
              <AiConsultantModal isOpen={consultant.isOpen} onClose={() => setConsultant({ ...consultant, isOpen: false })} mode={consultant.mode} sectionId={consultant.sectionId} context={businessContext} canvasData={canvasData} onComplete={(res, mode)=>{ if(mode==='global'){ setCanvasData(prev => { const n={...prev}; Object.keys(res).forEach(k=>{ if(n[k]) n[k].items = res[k].map(t=>({id:Date.now()+Math.random(), text:t})) }); return n; }); } else { setAiSuggestions({ sectionId: consultant.sectionId, items: res }); } }} t={t} lang={lang} setApiError={setApiError} customApiKey={customApiKey} setSettingsOpen={setSettingsOpen} />
              <ItemRefineModal isOpen={itemRefiner.isOpen} onClose={() => setItemRefiner({ ...itemRefiner, isOpen: false })} item={itemRefiner.item} context={businessContext} sectionTitle={itemRefiner.sectionTitle} onSave={saveRefinedItem} t={t} lang={lang} customApiKey={customApiKey} setSettingsOpen={setSettingsOpen} />
              <BrandModal isOpen={brandModalOpen} onClose={() => setBrandModalOpen(false)} onSelect={handleBrandAnalysis} t={t} />
              <TopicGuideModal isOpen={topicGuide.isOpen} onClose={() => setTopicGuide({ ...topicGuide, isOpen: false })} sectionId={topicGuide.sectionId} t={t} customGuides={customGuides} />
              <EncyclopediaModal isOpen={encyclopediaOpen} onClose={() => setEncyclopediaOpen(false)} t={t} customGuides={customGuides} />
              <ReportModal isOpen={reportModal.isOpen} onClose={() => setReportModal({ ...reportModal, isOpen: false })} reportText={reportModal.text} t={t} />
              <SettingsModal isOpen={settingsOpen} onClose={() => setSettingsOpen(false)} apiKey={customApiKey} setApiKey={setCustomApiKey} t={t} />

              {isBrandAnalyzing && (<div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[10000] flex flex-col items-center justify-center text-white"><Loader2 size={64} className="animate-spin mb-4 text-blue-400" /><h2 className="text-2xl font-bold mb-2">{t.loadingAnalysis}</h2></div>)}
              {isAnalyzing && (<div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[10000] flex flex-col items-center justify-center text-white"><ClipboardCheck size={64} className="animate-bounce mb-4 text-emerald-400" /><h2 className="text-2xl font-bold mb-2">{t.loadingDiagnose}</h2></div>)}
              {loadingPersonalize && (<div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[10000] flex flex-col items-center justify-center text-white"><Wand2 size={64} className="animate-pulse mb-4 text-purple-400" /><h2 className="text-2xl font-bold mb-2">{t.loadingPersonalize}</h2></div>)}

              {apiError && (<div className="fixed bottom-4 right-4 z-[11000] max-w-sm bg-white border-l-4 border-red-500 rounded shadow-lg p-4 animate-slideIn flex items-start gap-3"><AlertCircle className="text-red-500 shrink-0" size={24} /><div className="flex-1"><h3 className="font-bold text-red-600 mb-1">Error</h3><p className="text-sm text-gray-600 whitespace-pre-wrap">{apiError}</p><button onClick={() => setApiError('')} className="mt-2 text-xs text-gray-400 hover:text-gray-600 underline">Dismiss</button></div></div>)}

              {/* Main Header */}
              <header className="max-w-[1440px] mx-auto mb-4 flex flex-col lg:flex-row items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-200 no-print">
                <div className="flex items-center gap-4 w-full lg:w-auto shrink-0 justify-between lg:justify-start">
                    <div className="flex items-center gap-4">
                        <div className="p-2.5 bg-slate-800 rounded-lg shadow-lg text-white"><Layout size={24} /></div>
                        <h1 className="text-2xl font-bold text-slate-800 tracking-tight whitespace-nowrap">{t.title}</h1>
                    </div>
                    {/* Mobile Topic Button */}
                    <button 
                        onClick={()=>setIsContextModalOpen(true)} 
                        className="lg:hidden flex items-center gap-2 px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 transition-all text-sm font-bold max-w-[120px]"
                    >
                        <Edit3 size={16} />
                        <span className="truncate">{businessContext || t.setupAI}</span>
                    </button>
                </div>
                
                <div className="hidden lg:flex flex-1 mx-8">
                    <button onClick={()=>setIsContextModalOpen(true)} className="w-full max-w-2xl mx-auto flex items-center gap-3 px-4 py-2 bg-gray-50 hover:bg-white border border-gray-200 hover:border-indigo-300 rounded-lg text-gray-600 hover:text-indigo-600 transition-all group shadow-inner hover:shadow-sm">
                        <Search size={16} className="text-gray-400 group-hover:text-indigo-400"/>
                        <span className="truncate flex-1 text-left text-sm font-medium">{businessContext || t.setupAI}</span>
                        <span className="text-xs bg-white border border-gray-200 px-2 py-0.5 rounded text-gray-400 group-hover:border-indigo-200 group-hover:text-indigo-400">Edit</span>
                    </button>
                </div>
                
                <div className="header-actions w-full lg:w-auto">
                      <button onClick={()=>setLang(l => l==='zh'?'en':'zh')} className="flex items-center gap-1.5 px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm text-gray-600 hover:bg-gray-50 font-medium shrink-0"><Globe size={16}/> {lang === 'zh' ? 'English' : 'ä¸­æ–‡'}</button>
                      <button onClick={()=>setEncyclopediaOpen(true)} className="px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm hover:bg-gray-50 flex items-center gap-2 text-gray-700 font-medium shrink-0"><BookOpen size={16}/> {t.encyclopediaBtn}</button>
                      <button onClick={()=>setIsSustainableMode(!isSustainableMode)} className={`px-3 py-2 rounded-lg border text-sm font-bold flex items-center gap-2 transition-colors shrink-0 ${isSustainableMode ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'bg-white border-gray-200 text-gray-600'}`}>{isSustainableMode ? <ToggleRight size={18}/> : <ToggleLeft size={18}/>} {isSustainableMode ? t.modeSustainable : t.modeStandard}</button>
                      <button onClick={()=>setBrandModalOpen(true)} className="px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm hover:bg-gray-50 flex items-center gap-2 text-gray-700 font-medium shrink-0"><Building2 size={16} /> {t.brandCases}</button>
                      <button onClick={()=>openConsultant('global')} className="px-4 py-2 bg-slate-800 text-white rounded-lg shadow hover:bg-slate-900 flex items-center gap-2 font-bold transition-transform hover:scale-105 active:scale-95 shrink-0"><Wand2 size={16}/> {t.generateOneClick}</button>
                      
                      {/* FIXED: Changed Settings Icon to Text Button */}
                      <button onClick={() => setSettingsOpen(true)} className="flex items-center gap-1.5 px-3 py-2 bg-gray-50 border border-gray-200 hover:bg-white hover:border-gray-300 rounded-lg text-sm font-medium text-gray-700 shrink-0 transition-colors">
                          <Key size={16}/> {t.setupApiKey}
                      </button>
                      
                      <div className="w-px h-8 bg-gray-200 mx-1 shrink-0 hidden lg:block"></div>
                      <button onClick={() => setResetModalOpen(true)} className="p-2 hover:bg-red-50 hover:text-red-500 rounded text-gray-400 shrink-0" title={t.reset}><RotateCcw size={16}/></button>
                </div>
              </header>

              <InstructionCard t={t} />

              <main className="max-w-[1440px] mx-auto bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200 print-border">
                <div className="grid grid-cols-1 md:grid-cols-5 divide-y md:divide-y-0 md:divide-x divide-gray-100 print:grid-cols-5 print:divide-x print:divide-gray-300">
                    <div className="md:col-span-5 bg-slate-50 p-1 px-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest flex items-center gap-1 border-b border-gray-100"><Briefcase size={10}/> {t.layers.biz}</div>
                    <div className="md:row-span-2 flex flex-col"><CanvasSection sectionKey="keyPartners" canvasData={canvasData} {...sectionProps} className="h-full" /></div>
                    <div className="md:col-span-1 flex flex-col"><CanvasSection sectionKey="keyActivities" canvasData={canvasData} {...sectionProps} className="flex-1" /><CanvasSection sectionKey="keyResources" canvasData={canvasData} {...sectionProps} className="flex-1" /></div>
                    <div className="md:row-span-2 flex flex-col z-10 bg-indigo-50/10 border-l border-r border-indigo-100"><CanvasSection sectionKey="valuePropositions" canvasData={canvasData} {...sectionProps} className="h-full" /></div>
                    <div className="md:col-span-1 flex flex-col"><CanvasSection sectionKey="customerRelationships" canvasData={canvasData} {...sectionProps} className="flex-1" /><CanvasSection sectionKey="channels" canvasData={canvasData} {...sectionProps} className="flex-1" /></div>
                    <div className="md:row-span-2 flex flex-col"><CanvasSection sectionKey="customerSegments" canvasData={canvasData} {...sectionProps} className="h-full" /></div>
                    <div className="md:col-span-5 grid grid-cols-1 md:grid-cols-2 border-t border-gray-100">
                        <div className="p-1 px-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest col-span-2 bg-slate-50 border-b border-gray-100 flex items-center gap-1"><Coins size={10}/> {t.layers.eco}</div>
                        <CanvasSection sectionKey="costStructure" canvasData={canvasData} {...sectionProps} />
                        <CanvasSection sectionKey="revenueStreams" canvasData={canvasData} {...sectionProps} />
                    </div>
                    {isSustainableMode && (
                        <>
                            <div className="md:col-span-5 grid grid-cols-1 md:grid-cols-2 border-t border-gray-100">
                                <div className="p-1 px-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest col-span-2 bg-slate-50 border-b border-gray-100 flex items-center gap-1"><Leaf size={10}/> {t.layers.env}</div>
                                <CanvasSection sectionKey="envCost" canvasData={canvasData} {...sectionProps} />
                                <CanvasSection sectionKey="envBenefit" canvasData={canvasData} {...sectionProps} />
                            </div>
                            <div className="md:col-span-5 grid grid-cols-1 md:grid-cols-2 border-t border-gray-100">
                                <div className="p-1 px-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest col-span-2 bg-slate-50 border-b border-gray-100 flex items-center gap-1"><Heart size={10}/> {t.layers.soc}</div>
                                <CanvasSection sectionKey="socCost" canvasData={canvasData} {...sectionProps} />
                                <CanvasSection sectionKey="socBenefit" canvasData={canvasData} {...sectionProps} />
                            </div>
                        </>
                    )}
                </div>
              </main>

              <div className="max-w-[1440px] mx-auto mt-8 mb-12 p-8 bg-white rounded-2xl border border-gray-200 text-center shadow-sm relative overflow-hidden no-print">
                  <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-400 to-indigo-500"></div>
                  <h2 className="text-2xl font-bold text-slate-800 mb-3 flex items-center justify-center gap-2"><ClipboardCheck className="text-indigo-600" /> {t.diagnoseTitle}</h2>
                  <p className="text-gray-500 mb-6 max-w-2xl mx-auto">{t.diagnoseDesc}</p>
                  <div className="flex justify-center gap-4">
                      <button onClick={handleAnalysis} className="px-8 py-3 bg-white border border-gray-300 rounded-xl shadow-sm hover:bg-gray-50 font-bold flex items-center gap-2 text-slate-700"><ClipboardCheck size={20}/> {t.btnDiagnose}</button>
                      
                      {/* FIXED: Renamed to Export Button */}
                      <button onClick={()=>setIsExportModalOpen(true)} className="px-8 py-3 bg-slate-800 text-white rounded-xl shadow-lg hover:bg-slate-900 flex items-center gap-2"><Download size={20}/> {t.btnExport}</button>
                  </div>
              </div>
              
              <footer className="text-center pb-8 no-print px-4">
                  {/* WARNING TEXT MOVED HERE */}
                  <p className="text-red-500 text-xs mb-2 font-medium">{t.aiWarning}</p>
                  <p className="text-gray-400 text-xs">å¦‚æœä½ æƒ³è¦è§£é–ä»˜è²»AIç‰ˆæœ¬ï¼Œæ­¡è¿èˆ‡æˆ‘å€‘è¯çµ¡ <a href="mailto:dt@designthinking.com.tw" class="text-indigo-600 hover:text-indigo-800 font-medium">dt@designthinking.com.tw</a></p>
              </footer>
            </div>
          );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<BusinessCanvasAI />);
    </script>
</body>
</html>