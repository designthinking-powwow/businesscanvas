<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ÂïÜÊ•≠Ê®°ÂºèÁï´Â∏É</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.2s ease-out forwards; }
        .animate-slideIn { animation: slideIn 0.2s ease-out forwards; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @media print {
            body { background: white; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            .print-border { border: 2px solid #333 !important; }
            .print-shadow-none { box-shadow: none !important; }
        }
    </style>
</head>
<body class="bg-[#F3F4F6] text-slate-800 font-sans">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // =================================================================================
        //  Á≥ªÁµ±Ë®≠ÂÆöÂçÄ (System Configuration)
        // =================================================================================
        
        // 1. API Key Ë®≠ÂÆö
        // Â∑≤Â°´ÂÖ•ÊÇ®Êèê‰æõÁöÑ Key„ÄÇËã•Âá∫Áèæ "referer blocked" ÈåØË™§ÔºåË´ãËá≥ Google Cloud Console Êö´ÊôÇÂ∞áÈôêÂà∂Ë®≠ÁÇ∫ "None"„ÄÇ
        const apiKey = "AIzaSyBGC9_EOIRNkUA1Sf0VH1S9Ua9Cxmj8Uh4"; 

        // 2. Firebase Ë®≠ÂÆö (Áî®ÊñºÂÖ®ÂüüÈ°çÂ∫¶ÊéßÂà∂ÔºåÈÅ∏Â°´)
        const firebaseConfig = null; 

        const GLOBAL_DAILY_LIMIT = 1000; // ÂÖ®Á´ôÊØèÊó•ÊúÄÂ§ß API ÂëºÂè´Ê¨°Êï∏

        // =================================================================================

        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import * as LucideReact from 'https://esm.sh/lucide-react@0.292.0';
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, getDoc, updateDoc, increment, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const { 
            Plus, X, Trash2, Layout, RotateCcw, Sparkles, Lightbulb, MessageSquare, 
            Loader2, Settings, Leaf, Heart, Coins, Wand2, HelpCircle, ChevronUp, 
            ClipboardCheck, AlertTriangle, CheckCircle2, Mail, 
            Send, FileText, ShieldCheck, MessageCircleQuestion, Edit3, Bot, 
            Building2, Globe, Lock, Briefcase, BookOpen, ToggleLeft, ToggleRight, Activity, AlertCircle
        } = LucideReact;

        // --- Firebase ÂàùÂßãÂåñ ---
        let db = null;
        if (firebaseConfig) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const auth = getAuth(app);
                signInAnonymously(auth).catch(console.error);
            } catch (e) {
                console.warn("Firebase Init Error (Using Local Mode):", e);
            }
        }

        // --- È°çÂ∫¶ÊéßÂà∂ÈÇèËºØ ---
        const checkAndIncrementUsage = async () => {
            const today = new Date().toISOString().slice(0, 10);

            if (db) {
                const docRef = doc(db, "usage_stats", today);
                try {
                    const docSnap = await getDoc(docRef);
                    let currentCount = 0;
                    if (docSnap.exists()) {
                        currentCount = docSnap.data().count || 0;
                    } else {
                        await setDoc(docRef, { count: 0 });
                    }
                    if (currentCount >= GLOBAL_DAILY_LIMIT) throw new Error(`Á≥ªÁµ±‰ªäÊó•È°çÂ∫¶ (${GLOBAL_DAILY_LIMIT}) Â∑≤ÊªøÔºåË´ãÊòéÊó•ÂÜçË©¶„ÄÇ`);
                    await updateDoc(docRef, { count: increment(1) });
                    return true;
                } catch (e) {
                    if (e.message.includes("Â∑≤Êªø")) throw e;
                    console.warn("Firestore access failed, falling back to local.");
                }
            }

            const LOCAL_KEY = 'local_usage_stats';
            const LOCAL_LIMIT = 50; 
            const stored = localStorage.getItem(LOCAL_KEY);
            let stats = { date: today, count: 0 };
            if (stored) {
                const parsed = JSON.parse(stored);
                if (parsed.date === today) stats = parsed;
            }
            if (stats.count >= LOCAL_LIMIT) throw new Error(`ÊÇ®‰ªäÊó•ÁöÑÂÖçË≤ªÈ°çÂ∫¶ (${LOCAL_LIMIT}Ê¨°) Â∑≤Áî®ÂÆå„ÄÇ`);
            
            stats.count += 1;
            localStorage.setItem(LOCAL_KEY, JSON.stringify(stats));
            window.dispatchEvent(new Event('usageUpdated'));
            return true;
        };

        const getLocalUsage = () => {
            const today = new Date().toISOString().slice(0, 10);
            const stored = localStorage.getItem('local_usage_stats');
            if (stored) {
                const parsed = JSON.parse(stored);
                if (parsed.date === today) return parsed.count;
            }
            return 0;
        };

        // --- ÁøªË≠ØË≥áÊñôÂ∫´ ---
        const TRANSLATIONS = {
          zh: {
            title: "ÂïÜÊ•≠Ê®°ÂºèÁï´Â∏É",
            subtitle: "AI Power", 
            setupAI: "Ë®≠ÂÆö‰∏ªÈ°å",
            reset: "ÈáçÁΩÆ",
            brandCases: "ÂìÅÁâåÊ°à‰æã",
            generateOneClick: "‰∏ÄÈçµÁîüÊàê",
            instructionShow: "Êñ∞ÊâãÊåáÂçó",
            instructionHide: "Êî∂Ëµ∑Ë™™Êòé",
            encyclopediaBtn: "ÂïÜÊ•≠ÁôæÁßë",
            modeStandard: "Ê®ôÊ∫ñÊ®°Âºè",
            modeSustainable: "Ê∞∏Á∫åÊ®°Âºè",
            usageTitle: "ÂÄã‰∫∫È°çÂ∫¶",
            language: "English",
            instructionTitle: "Â¶Ç‰Ωï‰ΩøÁî®Êú¨Â∑•ÂÖ∑Ôºö",
            step1Title: "1. Ë®≠ÂÆö‰∏ªÈ°å",
            step1Desc: "ÈªûÊìäÂ∑¶‰∏äËßíÁöÑ„ÄåË®≠ÂÆö‰∏ªÈ°å„ÄçÔºåAI ÊúÉÊ†πÊìöÊÇ®ÁöÑË°åÊ•≠Ëá™ÂãïÊîπÂØ´ÂºïÂ∞éÊñáÂ≠ó„ÄÇ",
            step2Title: "2. Êô∫ËÉΩÁôºÊÉ≥",
            step2Desc: "‰ΩøÁî®ÂçÄÂ°ä‰∏ãÊñπÁöÑ„ÄåAI ÈùàÊÑü„ÄçÂø´ÈÄüÁîüÊàêÂÖßÂÆπ„ÄÇÈªûÊìä‰æøÊ¢ùÁ¥ôÂèØ‰ΩøÁî® AI ÂÑ™Âåñ„ÄÇ",
            step3Title: "3. Ë®∫Êñ∑ËàáÂàÜ‰∫´",
            step3Desc: "‰ΩøÁî®„ÄåÂïÜÊ•≠Ë®∫Êñ∑„ÄçÊâæÂá∫Áõ≤ÈªûÔºåÂÆåÊàêÂæåÂèØÂ∞áÂ†±ÂëäÂØÑËá≥ Email ‰øùÂ≠ò„ÄÇ",
            quotaTitle: "4. ÂÖçË≤ªÈ°çÂ∫¶Ë™™Êòé",
            quotaDesc: "Êú¨Â∑•ÂÖ∑Áî±ÈñãÁôºËÄÖÊèê‰æõÂÖçË≤ªË©¶Áî®„ÄÇÁÇ∫Èò≤Ê≠¢Êø´Áî®ÔºåË®≠ÊúâÊØèÊó•‰ΩøÁî®‰∏äÈôê„ÄÇ",
            aiConsultantTitle: "AI ÂâµÊ•≠Â∞éÂ∏´",
            aiConsultantDesc: "Ë´ãÂõûÁ≠îÂπæÂÄãÁ∞°ÂñÆÂïèÈ°åÔºåËÆìÊàëÁÇ∫ÊÇ®ÊßãÊÄù„ÄÇ",
            submitAndGenerate: "ÁîüÊàêÁï´Â∏É",
            skipAndGenerate: "Áõ¥Êé•ÁîüÊàê",
            loadingAnalysis: "AI Ê≠£Âú®ÂàÜÊûê...",
            loadingGlobal: "AI Ê≠£Âú®ÊßãÊÄùÊï¥ÂºµËóçÂúñ...",
            loadingDiagnose: "AI È°ßÂïèÊ≠£Âú®ÈÄ≤Ë°åÂïÜÊ•≠ÂÅ•Ê™¢...",
            loadingPersonalize: "AI Ê≠£Âú®ÂÆ¢Ë£ΩÂåñÂºïÂ∞éÊñáÂ≠ó...",
            diagnoseTitle: "ÂïÜÊ•≠Ê®°ÂºèË®∫Êñ∑",
            diagnoseDesc: "ËÆì AI È°ßÂïèÂπ´ÊÇ®ÊâæÂá∫ÊΩõÂú®Áõ≤Èªû„ÄÅÈ¢®Èö™ËàáÂÑ™Âã¢ÂàÜÊûê„ÄÇ",
            btnDiagnose: "ÈñãÂßãË®∫Êñ∑",
            btnEmail: "Email ÂØÑÈÄÅÂ†±Âëä",
            modalContextTitle: "ÊÇ®ÊÉ≥ÂÅö‰ªÄÈ∫ºÁîüÊÑèÔºü",
            modalContextDesc: "ÂëäË®¥ÊàëÂÄëÊÇ®ÁöÑÊÉ≥Ê≥ïÔºåAI Â∞áÊúÉÁÇ∫ÊÇ®„ÄåÂÆ¢Ë£ΩÂåñ„Äç‰ªãÈù¢‰∏äÁöÑÂºïÂ∞éË™™Êòé„ÄÇ",
            placeholderContext: "‰æãÂ¶ÇÔºöÊàëÊÉ≥Âú®Âè∞ÂåóÂ∏ÇÈñã‰∏ÄÈñì‰∏ªÊâìÂèØÈ†åÁöÑÁ≤æÂìÅÂíñÂï°Âª≥...",
            btnNoSet: "Êö´‰∏çË®≠ÂÆö",
            btnStartPlan: "ÈñãÂßãË¶èÂäÉ",
            brandModalTitle: "ÂìÅÁâåÊ°à‰æãÊô∫Â∫´",
            brandModalDesc: "ÈÅ∏Êìá‰∏ÄÂÄãÁü•ÂêçÂìÅÁâåÔºåAI Â∞áÁÇ∫ÊÇ®ÊãÜËß£ÂÖ∂ÂïÜÊ•≠Ê®°Âºè„ÄÇ",
            searchPlaceholder: "Ëº∏ÂÖ•‰ªª‰ΩïÂìÅÁâå...",
            btnAnalyze: "AI ÂàÜÊûê (Ë¶ÜËìã)",
            brandOverwriteWarning: "‚ö†Ô∏è Ê≠§Êìç‰ΩúÂ∞áË¶ÜËìãÁõÆÂâçÂÖßÂÆπ",
            brandDisclaimer: "ÂÖßÂÆπÁî± AI ÁîüÊàêÔºåÂÉÖ‰æõÂèÉËÄÉ„ÄÇ",
            refineTitle: "ÂÖßÂÆπÂÑ™ÂåñÂô®",
            refineLabel: "ÂéüÂßãÂÖßÂÆπ",
            btnSpecific: "üéØ Êõ¥ÂÖ∑È´îÂåñ",
            btnAttractive: "‚ú® Êõ¥Âê∏Âºï‰∫∫",
            btnCritique: "üßê ÊâæÁõ≤Èªû",
            placeholderRefine: "ÊàñËº∏ÂÖ•Ëá™ÂÆöÁæ©Êåá‰ª§...",
            btnConfirmRefine: "Á¢∫Ë™ç‰øÆÊîπ",
            emailTitle: "ÂØÑÈÄÅÊÇ®ÁöÑÂïÜÊ•≠Ê®°ÂºèÂúñ",
            emailDesc: "ÊàëÂÄëÂ∞áÂçîÂä©ÊÇ®ÈñãÂïüÈÉµ‰ª∂ËªüÈ´îÔºå‰∏¶Ëá™ÂãïÂ∏∂ÂÖ•ÊñáÂ≠óÂ†±Âëä„ÄÇ",
            labelName: "ÊÇ®ÁöÑÁ®±Âëº",
            labelEmail: "Êî∂‰ª∂‰ø°ÁÆ±",
            privacyNote: "Ê≠§Êìç‰ΩúÂ∞áÈñãÂïüÊÇ®Ë£ùÁΩÆ‰∏äÁöÑÈ†êË®≠ÈÉµ‰ª∂ App (Â¶Ç Gmail/Outlook)„ÄÇ",
            btnSend: "ÈñãÂïüÈÉµ‰ª∂ËªüÈ´î",
            btnSending: "Ê∫ñÂÇô‰∏≠...",
            sentTitle: "Â∑≤ÈñãÂïü",
            sentDesc: "Ë´ãÂú®Ë∑≥Âá∫ÁöÑÈÉµ‰ª∂Ë¶ñÁ™ó‰∏≠Á¢∫Ë™çÂÖßÂÆπ‰∏¶Êåâ‰∏ãÂÇ≥ÈÄÅ„ÄÇ",
            btnBack: "ËøîÂõûÁï´Â∏É",
            reportTitle: "AI Ë®∫Êñ∑Â†±Âëä",
            btnUnderstand: "‰∫ÜËß£",
            resetModalTitle: "Á¢∫Ë™çÈáçÁΩÆÔºü",
            resetModalDesc: "ÈÄôÂ∞áÊ∏ÖÁ©∫Áï´Â∏É‰∏äÁöÑÊâÄÊúâÂÖßÂÆπ„ÄÅ‰∏ªÈ°åËàáÂª∫Ë≠∞„ÄÇÁ¢∫ÂÆöË¶ÅÁπºÁ∫åÂóéÔºü",
            btnSaveAndReset: "ÈáçÁΩÆ",
            btnClearOnly: "ÈáçÁΩÆ",
            btnCancel: "ÂèñÊ∂à",
            encyclopediaModalTitle: "ÂïÜÊ•≠Ê®°ÂºèÁôæÁßëÂÖ®Êõ∏",
            encyclopediaModalDesc: "ÈªûÈÅ∏Â∑¶ÂÅ¥È†ÖÁõÆÔºåÊ∑±ÂÖ•‰∫ÜËß£ÊØèÂÄãÂçÄÂ°äÁöÑÂÆöÁæ©ËàáÂ°´ÂØ´ÊäÄÂ∑ß„ÄÇ",
            addItem: "Êñ∞Â¢ûÈ†ÖÁõÆ...",
            aiSpark: "AI ÈùàÊÑü",
            topicHelp: "ÂÆöÁæ©",
            sections: {
              keyPartners: { title: "ÈóúÈçµÂêà‰ΩúÂ§•‰º¥", subtitle: "Ë™∞Âπ´ÊàëÂÄëÂàÜÊìîÈ¢®Èö™Ôºü", desc: "Èùû„Äå‰∏ÄËà¨Êé°Ë≥º„ÄçÂ∞çË±°ÔºåËÄåÊòØÁ≠ñÁï•ÁõüÂèã„ÄÇ(‰æãÔºöÈùûÁ´∂Áà≠ËÄÖÁöÑÁï∞Ê•≠ÁµêÁõü„ÄÅÁ´∂ÂêàÂ§•‰º¥„ÄÅÈóúÈçµÂ§ñÂåÖÂïÜ)" },
              keyActivities: { title: "ÈóúÈçµÊ¥ªÂãï", subtitle: "ÂÖ∑È´îË¶ÅÂü∑Ë°å‰ªÄÈ∫ºË°åÂãïÔºü", desc: "Ë´ãÂØ´ÂÖ∑È´îÂãï‰ΩúÔºå‰∏çË¶ÅÂè™ÂØ´„ÄåË°åÈä∑„ÄçÔºåË¶ÅÂØ´„ÄåÁ∂ìÁáü FB Á§æÁæ§„ÄçÊàñ„ÄåÊäïÊîæÈóúÈçµÂ≠óÂª£Âëä„Äç„ÄÇ(Ê†∏ÂøÉÂü∑Ë°åÈ†ÖÁõÆ)" },
              keyResources: { title: "ÈóúÈçµË≥áÊ∫ê", subtitle: "‰Ω†Êâã‰∏äÊúâ‰ªÄÈ∫ºÊ≠¶Âô®Ôºü", desc: "Ê≤í‰∫ÜÈÄô‰∫õÊù±Ë•øÔºåÁîüÊÑèÂ∞±ÂÅö‰∏ç‰∏ãÂéª„ÄÇ(‰æãÔºöÂ∫óÈù¢„ÄÅË≥áÈáë„ÄÅÂ∞àÂà©ÊäÄË°ì„ÄÅÂ∞àÊ•≠‰∫∫Êâç)" },
              valuePropositions: { title: "ÂÉπÂÄº‰∏ªÂºµ", subtitle: "ÂÆ¢‰∫∫ÁÇ∫‰ªÄÈ∫ºÈÅ∏‰Ω†‰∏çÈÅ∏Âà•‰∫∫Ôºü", desc: "‰Ω†Âπ´ÂÆ¢‰∫∫Ëß£Ê±∫‰∫Ü‰ªÄÈ∫ºÁÖ©ÊÉ±Ôºü(‰æãÔºö‰∏çÊòØ„ÄåË≥£ÈõªÈëΩ„ÄçËÄåÊòØ„ÄåÊèê‰æõÁâÜ‰∏äÁöÑÊ¥û„Äç„ÄÅÊõ¥ÁúÅÊôÇ„ÄÅÊõ¥‰æøÂÆú)" },
              customerRelationships: { title: "ÂÆ¢Êà∂Èóú‰øÇ", subtitle: "‰Ω†ÊÄéÈ∫ºË∑üÂÆ¢‰∫∫ÊêèÊÑüÊÉÖÔºü", desc: "ÊòØÂÉèËÄÅÊúãÂèã‰∏ÄÊ®£Èï∑Êúü‰∫íÂãïÔºåÈÇÑÊòØÈäÄË≤®ÂÖ©Ë®ñÔºü(‰æãÔºöÊúÉÂì°Âà∂„ÄÅÂ∞à‰∫∫ÊúçÂãô„ÄÅÁ§æÁæ§Â∞èÁ∑®)" },
              channels: { title: "ÈÄöË∑Ø", subtitle: "ÂÆ¢‰∫∫Âú®Âì™Ë£°ÁúãÂà∞‰Ω†„ÄÅË≤∑Âà∞‰Ω†Ôºü", desc: "‰Ω†ÁöÑÊù±Ë•øÊÄéÈ∫ºÈÄÅÂà∞ÂÆ¢‰∫∫Êâã‰∏äÔºü(‰æãÔºöÂØ¶È´îÂ∫óÈù¢„ÄÅÁ∂≤Á´ô„ÄÅApp„ÄÅÂ§ñÈÄÅÂπ≥Âè∞)" },
              customerSegments: { title: "ÁõÆÊ®ôÂÆ¢Áæ§", subtitle: "Ë™∞ÊúÉË≤∑‰Ω†ÁöÑÂñÆÔºü", desc: "‰Ω†ÁöÑÁî¢ÂìÅÊòØË¶ÅË≥£Áµ¶Ë™∞ÔºüË´ãÂÖ∑È´îÊèèÁπ™‰ªñÂÄëÁöÑÊ®£Â≠ê„ÄÇ(‰æãÔºöÂøôÁ¢åÁöÑ‰∏äÁè≠Êóè„ÄÅÁ¥†È£üÊÑõÂ•ΩËÄÖ)" },
              costStructure: { title: "ÊàêÊú¨ÁµêÊßã", subtitle: "Èå¢ÈÉΩËä±ÂéªÂì™‰∫ÜÔºü", desc: "ÂÅöÈÄôÈñÄÁîüÊÑèÔºåÊúÄÂ§ßÁöÑÈñãÈä∑ÊúâÂì™‰∫õÔºü(‰æãÔºöÊàøÁßü„ÄÅÂì°Â∑•Ëñ™Ê∞¥„ÄÅÂéüÁâ©ÊñôË≤ªÁî®)" },
              revenueStreams: { title: "Êî∂ÁõäÊµÅ", subtitle: "Èå¢ÂæûÂì™Ë£°ÈÄ≤‰æÜÔºü", desc: "‰Ω†Èù†‰ªÄÈ∫ºÊñπÂºèÊî∂Èå¢Ôºü(‰æãÔºöË≥£Áî¢ÂìÅË≥∫ÂÉπÂ∑Æ„ÄÅÊî∂ÊúÉÂì°Ë≤ª„ÄÅÊäΩÊàê„ÄÅÊî∂Âª£ÂëäË≤ª)" },
              envCost: { title: "Áí∞Â¢ÉÊàêÊú¨", subtitle: "ÊúÉ‰∏çÊúÉÂºÑÈ´íÁí∞Â¢ÉÔºü", desc: "Âú®ÁîüÁî¢ÊàñÈä∑ÂîÆÈÅéÁ®ã‰∏≠ÔºåÊúÉË£ΩÈÄ†‰ªÄÈ∫ºÊ±ôÊüìÊàñÂûÉÂúæÔºü(‰æãÔºöÂÖçÊ¥óÈ§êÂÖ∑„ÄÅÂª¢Ê∞£„ÄÅÂ§ßÈáèÂªöÈ§ò)" },
              envBenefit: { title: "Áí∞Â¢ÉÊïàÁõä", subtitle: "ËÉΩÁÇ∫Âú∞ÁêÉÂÅö‰ªÄÈ∫ºÂ•Ω‰∫ãÔºü", desc: "‰Ω†ÁöÑÁîüÊÑèËÉΩËÆìÁí∞Â¢ÉËÆäÊõ¥Â•ΩÂóéÔºü(‰æãÔºö‰ΩøÁî®ÂõûÊî∂ÊùêË≥™„ÄÅÁØÄÁúÅËÉΩÊ∫ê„ÄÅÊ∏õÂ∞ëÊµ™Ë≤ª)" },
              socCost: { title: "Á§æÊúÉÊàêÊú¨", subtitle: "ÊúÉ‰∏çÊúÉÊúâË≤†Èù¢ÂΩ±ÈüøÔºü", desc: "ÊúâÊ≤íÊúâÂèØËÉΩËÆìÂì°Â∑•Â§™Á¥ØÔºåÊàñÂêµÂà∞ÈÑ∞Â±ÖÔºü(‰æãÔºöÂ∑•ÊôÇÈÅéÈï∑„ÄÅÂô™Èü≥Âπ≤Êìæ„ÄÅÂÄãË≥áÂ§ñÊ¥©È¢®Èö™)" },
              socBenefit: { title: "Á§æÊúÉÊïàÁõä", subtitle: "ËÉΩÂπ´Á§æÊúÉËß£Ê±∫‰ªÄÈ∫ºÂïèÈ°åÔºü", desc: "Èô§‰∫ÜË≥∫Èå¢Ôºå‰Ω†ÈÇÑÂπ´Âä©‰∫ÜË™∞Ôºü(‰æãÔºöÈõáÁî®‰∫åÂ∫¶Â∞±Ê•≠„ÄÅÊîØÊåÅÂú®Âú∞Â∞èËæ≤„ÄÅÊçêÊ¨æÂÖ¨Áõä)" },
            },
            layers: { biz: "ÂïÜÊ•≠Ê†∏ÂøÉÂ±§Èù¢", eco: "Á∂ìÊøüÂ±§Èù¢", env: "Áí∞Â¢ÉÂ±§Èù¢", soc: "Á§æÊúÉÂ±§Èù¢" }
          },
          en: {
            title: "Business Model Canvas",
            subtitle: "Public AI",
            setupAI: "Set Topic",
            reset: "Reset",
            brandCases: "Brand Cases",
            generateOneClick: "One-Click",
            instructionShow: "Guide",
            instructionHide: "Hide Guide",
            encyclopediaBtn: "Encyclopedia",
            modeStandard: "Standard",
            modeSustainable: "Sustainable",
            usageTitle: "Quota",
            language: "ÁπÅÈ´î‰∏≠Êñá",
            instructionTitle: "Quick Guide & Limits:",
            step1Title: "1. Topic",
            step1Desc: "Set Topic top-left. AI customizes guides.",
            step2Title: "2. Ideate",
            step2Desc: "Use AI Spark. Click notes to refine.",
            step3Title: "3. Diagnose",
            step3Desc: "Find blind spots, then Email report.",
            quotaTitle: "4. Daily Quota",
            quotaDesc: "Free tier limited to 50 requests/day.",
            aiConsultantTitle: "AI Consultant",
            aiConsultantDesc: "Answer to get started.",
            submitAndGenerate: "Generate",
            skipAndGenerate: "Skip & Generate",
            loadingAnalysis: "Analyzing...",
            loadingGlobal: "Generating Blueprint...",
            loadingDiagnose: "Diagnosing...",
            loadingPersonalize: "Personalizing...",
            diagnoseTitle: "Diagnosis",
            diagnoseDesc: "Find risks and blind spots.",
            btnDiagnose: "Start Diagnosis",
            btnEmail: "Email Report",
            modalContextTitle: "Business Idea?",
            modalContextDesc: "Tell us your idea for customized guides.",
            placeholderContext: "e.g., A coffee shop...",
            btnNoSet: "Skip",
            btnStartPlan: "Start",
            brandModalTitle: "Brand Library",
            brandModalDesc: "Select a brand to analyze.",
            searchPlaceholder: "Enter brand...",
            btnAnalyze: "Analyze",
            brandOverwriteWarning: "‚ö†Ô∏è Overwrites content",
            brandDisclaimer: "AI generated.",
            refineTitle: "Refiner",
            refineLabel: "Original Text",
            btnSpecific: "üéØ Specific",
            btnAttractive: "‚ú® Attractive",
            btnCritique: "üßê Critique",
            placeholderRefine: "Or command...",
            btnConfirmRefine: "Confirm",
            emailTitle: "Send Report",
            emailDesc: "We will open your mail app with the report ready.",
            labelName: "Name",
            labelEmail: "Recipient Email",
            privacyNote: "Opens your default mail app.",
            btnSend: "Open Mail App",
            btnSending: "Preparing...",
            sentTitle: "Opened",
            sentDesc: "Check mail window.",
            btnBack: "Back",
            reportTitle: "Report",
            btnUnderstand: "OK",
            resetModalTitle: "Reset?",
            resetModalDesc: "Clear all content? Cannot be undone.",
            btnSaveAndReset: "Reset",
            btnClearOnly: "Reset",
            btnCancel: "Cancel",
            encyopediaModalTitle: "Encyclopedia",
            encyopediaModalDesc: "Click sections for info.",
            addItem: "Add...",
            aiSpark: "AI Spark",
            topicHelp: "Info",
            sections: {
              keyPartners: { title: "Key Partners", subtitle: "Strategic alliances." },
              keyActivities: { title: "Key Activities", subtitle: "Core actions." },
              keyResources: { title: "Key Resources", subtitle: "Key assets." },
              valuePropositions: { title: "Value Propositions", subtitle: "Value created." },
              customerRelationships: { title: "Relationships", subtitle: "Interactions." },
              channels: { title: "Channels", subtitle: "Touchpoints." },
              customerSegments: { title: "Segments", subtitle: "Target audience." },
              costStructure: { title: "Cost Structure", subtitle: "Major costs." },
              revenueStreams: { title: "Revenue Streams", subtitle: "Income sources." },
              envCost: { title: "Env. Costs", subtitle: "Negative impact." },
              envBenefit: { title: "Env. Benefits", subtitle: "Positive impact." },
              socCost: { title: "Social Costs", subtitle: "Negative impact." },
              socBenefit: { title: "Social Benefits", subtitle: "Positive impact." },
            },
            layers: { biz: "Business", eco: "Economic", env: "Environmental", soc: "Social" }
          }
        };

        // --- Morandi Pro Palette ---
        const STYLE_BLUE = { bg: 'bg-slate-50', border: 'border-slate-200 hover:border-blue-300', icon: 'text-slate-600', accent: 'border-t-4 border-t-slate-400' };
        const STYLE_CYAN = { bg: 'bg-cyan-50/50', border: 'border-cyan-200 hover:border-cyan-400', icon: 'text-cyan-700', accent: 'border-t-4 border-t-cyan-500' };
        const STYLE_SKY  = { bg: 'bg-sky-50/50', border: 'border-sky-200 hover:border-sky-400', icon: 'text-sky-700', accent: 'border-t-4 border-t-sky-500' };
        const STYLE_VIOLET = { bg: 'bg-violet-50/60', border: 'border-violet-200 hover:border-violet-400', icon: 'text-violet-700', accent: 'border-t-4 border-t-violet-500' };
        const STYLE_ROSE = { bg: 'bg-rose-50/50', border: 'border-rose-200 hover:border-rose-400', icon: 'text-rose-700', accent: 'border-t-4 border-t-rose-500' };
        const STYLE_PINK = { bg: 'bg-pink-50/50', border: 'border-pink-200 hover:border-pink-400', icon: 'text-pink-700', accent: 'border-t-4 border-t-pink-500' };
        const STYLE_FUCHSIA = { bg: 'bg-fuchsia-50/50', border: 'border-fuchsia-200 hover:border-fuchsia-400', icon: 'text-fuchsia-700', accent: 'border-t-4 border-t-fuchsia-500' };
        const STYLE_ORANGE = { bg: 'bg-orange-50/60', border: 'border-orange-200 hover:border-orange-400', icon: 'text-orange-700', accent: 'border-t-4 border-t-orange-500' };
        const STYLE_EMERALD = { bg: 'bg-emerald-50/60', border: 'border-emerald-200 hover:border-emerald-400', icon: 'text-emerald-700', accent: 'border-t-4 border-t-emerald-500' };
        const STYLE_STONE = { bg: 'bg-stone-100/60', border: 'border-stone-300 hover:border-stone-400', icon: 'text-stone-600', accent: 'border-t-4 border-t-stone-500' };
        const STYLE_TEAL = { bg: 'bg-teal-50/60', border: 'border-teal-200 hover:border-teal-400', icon: 'text-teal-700', accent: 'border-t-4 border-t-teal-500' };
        const STYLE_RED = { bg: 'bg-red-50/60', border: 'border-red-200 hover:border-red-400', icon: 'text-red-700', accent: 'border-t-4 border-t-red-500' };
        const STYLE_AMBER = { bg: 'bg-amber-50/60', border: 'border-amber-200 hover:border-amber-400', icon: 'text-amber-700', accent: 'border-t-4 border-t-amber-500' };

        const initialCanvasDataStructure = {
          keyPartners: { id: 'keyPartners', style: STYLE_CYAN, items: [] },
          keyActivities: { id: 'keyActivities', style: STYLE_SKY, items: [] },
          keyResources: { id: 'keyResources', style: STYLE_BLUE, items: [] },
          valuePropositions: { id: 'valuePropositions', style: STYLE_VIOLET, items: [] },
          customerRelationships: { id: 'customerRelationships', style: STYLE_FUCHSIA, items: [] },
          channels: { id: 'channels', style: STYLE_PINK, items: [] },
          customerSegments: { id: 'customerSegments', style: STYLE_ROSE, items: [] },
          costStructure: { id: 'costStructure', style: STYLE_ORANGE, items: [] },
          revenueStreams: { id: 'revenueStreams', style: STYLE_EMERALD, items: [] },
          envCost: { id: 'envCost', style: STYLE_STONE, items: [] },
          envBenefit: { id: 'envBenefit', style: STYLE_TEAL, items: [] },
          socCost: { id: 'socCost', style: STYLE_RED, items: [] },
          socBenefit: { id: 'socBenefit', style: STYLE_AMBER, items: [] }
        };

        const geminiCall = async (prompt, isJson = false) => {
            if (!apiKey) {
                alert("Ë´ãÂ°´ÂÖ• API KeyÔºÅ\n\n(Â¶ÇÊûúÊòØÈñãÁôºËÄÖÔºåË´ãÂú®Á®ãÂºèÁ¢ºÁöÑ const apiKey ËÆäÊï∏‰∏≠Â°´ÂÖ•ÊÇ®ÁöÑÈáëÈë∞)");
                return "";
            }
            await checkAndIncrementUsage();
            try {
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                if (isJson) payload.generationConfig = { responseMimeType: "application/json" };
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await response.json();
                
                // ËôïÁêÜ Google API ÂõûÂÇ≥ÁöÑÈåØË™§
                if (data.error) {
                    // ÁâπÂà•ËôïÁêÜ "referer" ÈåØË™§
                    if (data.error.message && data.error.message.includes("referer")) {
                        throw new Error(`‚ö†Ô∏è API Key ÂèóÈôê\n\nÊÇ®ÁöÑ API Key Ë®≠ÂÆö‰∫Ü HTTP Referrer ÈôêÂà∂Ôºå‰ΩÜÁõÆÂâçÁöÑÁ∂≤ÂùÄ‰∏çÂú®ÂÖÅË®±Ê∏ÖÂñÆ‰∏≠„ÄÇ\n\nË´ãÂ∞á‰ª•‰∏ãÁ∂≤ÂùÄÂä†ÂÖ• Google Cloud Console ÁôΩÂêçÂñÆÔºö\n${window.location.origin}/*\n\nÊàñËÄÖÊö´ÊôÇÂ∞áÈôêÂà∂Ë®≠ÁÇ∫„ÄåÁÑ° (None)„Äç„ÄÇ`);
                    }
                    throw new Error(data.error.message);
                }
                
                let text = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                if (isJson) {
                    text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    try {
                        const start = text.indexOf('{'); const end = text.lastIndexOf('}');
                        if(start !== -1 && end !== -1) return JSON.parse(text.substring(start, end+1));
                        const startArr = text.indexOf('['); const endArr = text.lastIndexOf(']');
                        if(startArr !== -1 && endArr !== -1) return JSON.parse(text.substring(startArr, endArr+1));
                    } catch(e) {} 
                }
                return text;
            } catch (err) { console.error(err); alert(err.message); throw err; }
        };

        // --- ÁµÑ‰ª∂ ---

        const InstructionCard = ({ t }) => {
            const [isOpen, setIsOpen] = useState(false); 
            if (!isOpen) return (<div className="max-w-[1440px] mx-auto mb-4 flex justify-end no-print"><button onClick={() => setIsOpen(true)} className="flex items-center gap-2 px-3 py-1.5 bg-white text-indigo-600 text-xs font-medium rounded-full shadow-sm hover:bg-indigo-50 border border-indigo-100 transition-all"><HelpCircle size={14} /> {t.instructionShow}</button></div>);
            return (
                <div className="max-w-[1440px] mx-auto mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 rounded-xl p-4 shadow-sm relative animate-fadeIn no-print">
                    <button onClick={() => setIsOpen(false)} className="absolute top-2 right-2 text-blue-400 hover:text-blue-600 p-1 rounded-full hover:bg-blue-100/50 transition-colors"><ChevronUp size={18} /></button>
                    <h3 className="text-blue-800 font-bold text-sm mb-3 flex items-center gap-2"><HelpCircle size={16}/> {t.instructionTitle}</h3>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm text-blue-900/80">
                        <div className="flex items-start gap-3 bg-white/60 p-3 rounded-lg border border-blue-100"><div className="bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 text-xs font-bold">1</div><div><span className="font-bold text-blue-800 block mb-1">{t.step1Title}</span>{t.step1Desc}</div></div>
                        <div className="flex items-start gap-3 bg-white/60 p-3 rounded-lg border border-blue-100"><div className="bg-purple-600 text-white w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 text-xs font-bold">2</div><div><span className="font-bold text-purple-800 block mb-1">{t.step2Title}</span>{t.step2Desc}</div></div>
                        <div className="flex items-start gap-3 bg-white/60 p-3 rounded-lg border border-blue-100"><div className="bg-emerald-600 text-white w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 text-xs font-bold">3</div><div><span className="font-bold text-emerald-800 block mb-1">{t.step3Title}</span>{t.step3Desc}</div></div>
                        <div className="flex items-start gap-3 bg-white/60 p-3 rounded-lg border border-blue-100"><div className="bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 text-xs font-bold">!</div><div><span className="font-bold text-red-800 block mb-1">{t.quotaTitle}</span>{t.quotaDesc}</div></div>
                    </div>
                </div>
            );
        };

        const EncyclopediaModal = ({ isOpen, onClose, t, customGuides }) => {
            const [selectedSection, setSelectedSection] = useState('valuePropositions'); 
            if (!isOpen) return null;
            const layers = { biz: ['keyPartners', 'keyActivities', 'keyResources', 'valuePropositions', 'customerRelationships', 'channels', 'customerSegments'], eco: ['costStructure', 'revenueStreams'], env: ['envCost', 'envBenefit'], soc: ['socCost', 'socBenefit'] };
            const currentSectionInfo = t.sections[selectedSection];
            const displayDesc = customGuides?.[selectedSection]?.description || currentSectionInfo.desc;
            const displayPrompt = customGuides?.[selectedSection]?.promptGuide || initialCanvasDataStructure[selectedSection].promptGuide;
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[10000] p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[80vh] animate-fadeIn relative flex overflow-hidden">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10"><X size={24} /></button>
                        <div className="w-1/3 bg-gray-50 border-r border-gray-200 overflow-y-auto p-4">
                            <div className="flex items-center gap-2 text-indigo-800 font-bold mb-4 px-2"><BookOpen size={20} /> {t.encyclopediaModalTitle}</div>
                            <div className="space-y-6">{Object.keys(layers).map(k => (<div key={k}><h5 className="text-xs font-bold text-gray-400 uppercase tracking-wider px-2 mb-2">{t.layers[k]}</h5><div className="space-y-1">{layers[k].map(key => (<button key={key} onClick={() => setSelectedSection(key)} className={`w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition-all ${selectedSection === key ? 'bg-white text-indigo-600 shadow-sm border border-gray-100' : 'text-gray-600 hover:bg-gray-100'}`}>{t.sections[key].title}</button>))}</div></div>))}</div>
                        </div>
                        <div className="w-2/3 p-8 overflow-y-auto">
                            <div className="mb-6 pb-6 border-b border-gray-100"><h2 className="text-3xl font-bold text-gray-900 mb-2">{currentSectionInfo.title}</h2><p className="text-lg text-indigo-600 font-medium">{currentSectionInfo.subtitle}</p></div>
                            <div className="space-y-8">
                                <div><h4 className="flex items-center gap-2 text-sm font-bold text-gray-500 uppercase tracking-wide mb-3"><FileText size={16}/> ÂÆöÁæ©</h4><p className="text-gray-700 leading-relaxed text-lg bg-gray-50 p-6 rounded-xl border border-gray-100">{displayDesc}</p></div>
                                <div><h4 className="flex items-center gap-2 text-sm font-bold text-gray-500 uppercase tracking-wide mb-3"><Lightbulb size={16}/> ÊÄùËÄÉÊñπÂêë</h4><div className="text-gray-700 leading-relaxed p-6 rounded-xl border border-indigo-100 bg-indigo-50/30">{displayPrompt}</div></div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ContextModal = ({ isOpen, onClose, value, onChange, t, onStart }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[9999] p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 animate-fadeIn relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400"><X size={20}/></button>
                        <h2 className="text-xl font-bold mb-2 flex items-center gap-2 text-indigo-600"><Sparkles/> {t.modalContextTitle}</h2>
                        <p className="text-sm text-gray-500 mb-4">{t.modalContextDesc}</p>
                        <textarea value={value} onChange={e=>onChange(e.target.value)} className="w-full p-3 border border-indigo-100 rounded-lg mb-4 h-32 focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder={t.placeholderContext}></textarea>
                        <div className="flex justify-end gap-2"><button onClick={onClose} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">{t.btnNoSet}</button><button onClick={() => { onStart(); onClose(); }} className="px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 shadow-md">{t.btnStartPlan}</button></div>
                    </div>
                </div>
            )
        };

        const AiConsultantModal = ({ isOpen, onClose, mode, sectionId, context, canvasData, onComplete, t, lang }) => {
            const [step, setStep] = useState('loading_questions');
            const [questions, setQuestions] = useState([]);
            const [answers, setAnswers] = useState({});
            useEffect(() => {
                if (isOpen) {
                    setStep('loading_questions'); setQuestions([]); setAnswers({});
                    const fetchQuestions = async () => {
                        try {
                            const langInst = lang === 'zh' ? "ÁπÅÈ´î‰∏≠Êñá" : "English";
                            const prompt = mode === 'global' ? `ÈáùÂ∞ç„Äå${context}„Äç‰∏ªÈ°åÔºåÊèêÂá∫ 5 ÂÄãÂºïÂ∞éÂïèÈ°åÂπ´Âä©ÁôºÊÉ≥ÂïÜÊ•≠Ê®°Âºè„ÄÇÁî®${langInst}ÂõûÂÇ≥ JSON Array„ÄÇ` : `ÈáùÂ∞ç„Äå${context}„ÄçÁöÑ„Äå${sectionId}„ÄçÂçÄÂ°äÔºåÊèêÂá∫ 3 ÂÄãÂºïÂ∞éÂïèÈ°å„ÄÇÁî®${langInst}ÂõûÂÇ≥ JSON Array„ÄÇ`;
                            const result = await geminiCall(prompt, true);
                            if (Array.isArray(result)) { setQuestions(result); setStep('answering'); } else throw new Error("Format");
                        } catch (e) { handleGenerate(true); }
                    };
                    fetchQuestions();
                }
            }, [isOpen]);
            const handleGenerate = async (skip) => {
                setStep('generating');
                try {
                    const inputs = skip ? "Skipped" : Object.values(answers).join("\n");
                    const langInst = lang === 'zh' ? "ÁπÅÈ´î‰∏≠Êñá" : "English";
                    let res;
                    if(mode==='global') {
                        const keys = Object.keys(canvasData);
                        const p = `Theme:${context} Answers:${inputs} Generate Canvas. Keys:${keys.join(',')}. Values:Array of 3 strings. Lang:${langInst}. JSON Object.`;
                        res = await geminiCall(p, true);
                    } else {
                        const p = `Theme:${context} Section:${sectionId} Answers:${inputs} Give 3 suggestions. Lang:${langInst}. JSON Array.`;
                        res = await geminiCall(p, true);
                    }
                    
                    if (mode === 'section' && !Array.isArray(res)) throw new Error("Format error");
                    
                    onComplete(res, mode);
                    onClose();
                } catch(e) { 
                    console.error(e);
                    onClose(); 
                }
            };
            if(!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[10000] p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 animate-fadeIn relative min-h-[400px] flex flex-col">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400"><X size={20}/></button>
                        {step !== 'answering' ? (<div className="flex-1 flex flex-col items-center justify-center"><Loader2 size={48} className="animate-spin text-indigo-500 mb-4"/><p>{t.loadingGlobal}</p></div>) : 
                        (<div className="flex-1 flex flex-col"><h3 className="font-bold mb-4 flex gap-2 text-indigo-600"><MessageCircleQuestion/> {t.aiConsultantTitle}</h3><div className="flex-1 overflow-y-auto mb-4 space-y-4">{questions.map((q,i)=>(<div key={i}><p className="text-sm font-bold mb-1 text-slate-700">{i+1}. {q}</p><input className="w-full p-2 border rounded" value={answers[i]||''} onChange={e=>setAnswers({...answers, [i]:e.target.value})}/></div>))}</div><button onClick={()=>handleGenerate(false)} className="w-full py-3 bg-indigo-600 text-white rounded font-bold hover:bg-indigo-700">{t.submitAndGenerate}</button><button onClick={()=>handleGenerate(true)} className="text-xs text-center mt-2 text-gray-400 underline">{t.skipAndGenerate}</button></div>)}
                    </div>
                </div>
            );
        };

        const EmailModal = ({ isOpen, onClose, canvasData, t, context }) => {
            const [email, setEmail] = useState('');
            const [name, setName] = useState('');
            const handleSend = () => { 
                let reportText = `ÂïÜÊ•≠Ê®°ÂºèÁï´Â∏ÉÂ†±Âëä - ${context || "Êú™ÂëΩÂêçÂ∞àÊ°à"}\n\n`;
                Object.keys(canvasData).forEach(key => {
                    if (canvasData[key].items.length > 0) {
                        reportText += `„Äê${t.sections[key].title}„Äë\n`;
                        canvasData[key].items.forEach(item => reportText += `- ${item.text}\n`);
                        reportText += `\n`;
                    }
                });
                
                if(reportText.length > 1500) reportText = reportText.substring(0, 1500) + "\n... (ÂÖßÂÆπÈÅéÈï∑Â∑≤Êà™Êñ∑ÔºåË´ãÂõûÁ∂≤È†ÅÊü•ÁúãÂÆåÊï¥Áâà)";

                const subject = encodeURIComponent(`ÂïÜÊ•≠Ê®°ÂºèÁï´Â∏ÉÂ†±Âëä: ${context || "Project"}`);
                const body = encodeURIComponent(`Hi ${name},\n\nÈÄôÊòØÊÇ®ÁöÑÂïÜÊ•≠Ê®°ÂºèÁï´Â∏ÉÂ†±ÂëäÊëòË¶ÅÔºö\n\n${reportText}\n\nGenerated by AI Business Canvas`);
                window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
                onClose();
            };
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[10000] p-4"><div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 animate-fadeIn relative"><button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><X size={20} /></button><div className="text-center mb-6"><div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3"><Mail className="text-blue-600" size={24} /></div><h2 className="text-xl font-bold text-gray-800">{t.emailTitle}</h2><p className="text-sm text-gray-500 mt-1">{t.emailDesc}</p></div><div className="space-y-4"><div><label className="block text-xs font-bold text-gray-700 mb-1 uppercase">{t.labelName}</label><input type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Name"/></div><div><label className="block text-xs font-bold text-gray-700 mb-1 uppercase">{t.labelEmail}</label><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="email@example.com"/></div><div className="bg-blue-50 p-3 rounded text-xs text-blue-700 flex gap-2"><ShieldCheck size={14} className="flex-shrink-0 mt-0.5"/>{t.privacyNote}</div><button onClick={handleSend} disabled={!email || !name} className={`w-full py-3 rounded-lg font-bold text-white flex items-center justify-center gap-2 transition-all ${(!email || !name) ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 shadow-md hover:shadow-lg'}`}><Send size={18}/>{t.btnSend}</button></div></div></div>
            );
        };

        const BrandModal = ({ isOpen, onClose, onSelect, t }) => {
            const brands = ["Tesla", "Uber", "Netflix", "Airbnb", "Starbucks", "IKEA", "Apple", "Nike"];
            const [custom, setCustom] = useState('');
            if(!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[10000] p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 animate-fadeIn relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400"><X size={20}/></button>
                        <h2 className="text-xl font-bold mb-4 text-center">{t.brandModalTitle}</h2>
                        <div className="flex gap-2 mb-6"><input placeholder={t.searchPlaceholder} className="flex-1 p-2 border rounded" value={custom} onChange={e=>setCustom(e.target.value)} /><button onClick={()=>{onSelect(custom); onClose();}} className="px-4 bg-indigo-600 text-white rounded font-bold">{t.btnAnalyze}</button></div>
                        <div className="grid grid-cols-4 gap-3">{brands.map(b=>(<button key={b} onClick={()=>{onSelect(b); onClose();}} className="p-3 border rounded hover:bg-gray-50 font-bold">{b}</button>))}</div>
                    </div>
                </div>
            );
        };

        const ItemRefineModal = ({ isOpen, onClose, item, context, sectionTitle, onSave, t, lang }) => {
            const [text, setText] = useState('');
            const [loading, setLoading] = useState(false);
            useEffect(()=>{ if(isOpen && item) setText(typeof item.text==='string'?item.text:JSON.stringify(item.text)); },[isOpen,item]);
            const run = async (act) => {
                setLoading(true);
                try { const res = await geminiCall(`Context:${context}. Section:${sectionTitle}. Text:${text}. Action:${act}. Lang:${lang==='zh'?'Traditional Chinese':'English'}. Return only revised text.`, false); setText(res); } catch(e){} finally { setLoading(false); }
            };
            if(!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[10000] p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 animate-fadeIn relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400"><X size={20}/></button>
                        <h3 className="font-bold mb-4 flex items-center gap-2 text-indigo-600"><Bot/> {t.refineTitle}</h3>
                        <textarea className="w-full p-2 border rounded mb-4 h-32" value={text} onChange={e=>setText(e.target.value)}/>
                        <div className="grid grid-cols-2 gap-2 mb-4"><button disabled={loading} onClick={()=>run('Specific')} className="p-2 bg-gray-100 rounded text-xs hover:bg-gray-200">{t.btnSpecific}</button><button disabled={loading} onClick={()=>run('Attractive')} className="p-2 bg-gray-100 rounded text-xs hover:bg-gray-200">{t.btnAttractive}</button></div>
                        <button onClick={()=>onSave(text)} className="w-full py-2 bg-indigo-600 text-white rounded font-bold hover:bg-indigo-700">{t.btnConfirmRefine}</button>
                    </div>
                </div>
            );
        };

        const TopicGuideModal = ({ isOpen, onClose, sectionId, t, customGuides }) => {
            if (!isOpen || !sectionId) return null;
            const section = t.sections[sectionId];
            const customInfo = customGuides && customGuides[sectionId];
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[10000] p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 animate-fadeIn relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400"><X size={20}/></button>
                        <h3 className="text-xl font-bold mb-4 text-indigo-600">{t.topicHelp}</h3>
                        <div className="mb-4"><h4 className="font-bold">{section.title}</h4><p className="text-gray-600">{customInfo?.description || section.desc}</p></div>
                        <div className="bg-indigo-50 p-3 rounded text-sm text-indigo-800">{customInfo?.promptGuide || initialCanvasDataStructure[sectionId].promptGuide}</div>
                    </div>
                </div>
            );
        };

        const CanvasSection = ({ sectionKey, canvasData, activeSection, setActiveSection, newItemText, setNewItemText, handleAddItem, handleDeleteItem, openConsultant, openItemRefiner, aiSuggestions, setAiSuggestions, openTopicGuide, customGuides, className = "", t }) => {
          const section = canvasData[sectionKey]; 
          const staticText = t.sections[sectionKey];
          const customGuide = customGuides?.[sectionKey];
          const displaySubtitle = customGuide?.subtitle || staticText.subtitle;
          const isAdding = activeSection === sectionKey;
          const hasSuggestions = aiSuggestions?.sectionId === sectionKey;
          const inputRef = useRef(null);
          const style = section.style || STYLE_BLUE; // Fallback

          useEffect(() => { if (isAdding && !hasSuggestions && inputRef.current) inputRef.current.focus(); }, [isAdding, hasSuggestions]);

          return (
            <div className={`relative flex flex-col p-3 md:p-4 border transition-all min-h-[180px] ${style.bg} ${style.border} border-r border-b ${style.accent || ''} ${className}`}>
              <div className="flex justify-between items-start mb-2">
                <div className="flex items-center gap-2"><div><h3 className={`font-bold text-sm md:text-base tracking-wide flex items-center gap-2 ${section.iconColor || 'text-slate-600'}`}>{staticText.title}</h3><span className="text-[10px] md:text-xs font-medium text-gray-500 uppercase">{displaySubtitle}</span></div></div>
                <button onClick={() => openTopicGuide(sectionKey)} className={`text-gray-400 hover:text-gray-600 transition-colors no-print`}><HelpCircle size={14} /></button>
              </div>
              
              <div className="flex-1 space-y-2 overflow-y-auto max-h-[300px] scrollbar-thin scrollbar-thumb-gray-300 pr-1">
                {section.items.map(item => (
                    <div key={item.id} className="group relative bg-white/90 p-2.5 rounded shadow-sm border border-gray-100 text-sm text-gray-700 animate-slideIn hover:shadow-md transition-all cursor-pointer backdrop-blur-sm" onClick={(e) => { e.stopPropagation(); openItemRefiner(item, staticText.title); }}>
                        {item.text}
                        <div className="absolute top-1 right-1 opacity-0 group-hover:opacity-100 flex gap-1 transition-opacity no-print">
                            <button className="p-1 bg-white text-indigo-600 hover:bg-indigo-50 rounded shadow-sm" title="AI Refine"><Edit3 size={12} /></button>
                            <button onClick={(e) => { e.stopPropagation(); handleDeleteItem(sectionKey, item.id); }} className="p-1 bg-white text-red-500 hover:bg-red-50 rounded shadow-sm"><X size={12} /></button>
                        </div>
                    </div>
                ))}
              </div>
              
              {hasSuggestions && Array.isArray(aiSuggestions?.items) && (
                  <div className="mt-3 bg-white/80 backdrop-blur p-3 rounded-lg border border-indigo-100 animate-fadeIn shadow-sm">
                      <div className="flex justify-between items-center mb-2">
                          <span className="text-xs font-bold text-indigo-600 flex items-center gap-1"><Lightbulb size={12}/> AI:</span>
                          <button onClick={() => setAiSuggestions(null)} className="text-gray-400 hover:text-gray-700"><X size={12}/></button>
                      </div>
                      <div className="space-y-2">
                          {aiSuggestions.items.map((suggestion, idx) => (
                              <button key={idx} onClick={() => handleAddItem(sectionKey, suggestion)} className="w-full text-left text-xs p-2 bg-white hover:bg-indigo-50 text-gray-700 border border-indigo-100 rounded transition-colors flex items-center justify-between group">
                                  {typeof suggestion === 'string' ? suggestion : JSON.stringify(suggestion)}
                                  <Plus size={12} className="opacity-0 group-hover:opacity-100 text-indigo-600"/>
                              </button>
                          ))}
                      </div>
                  </div>
              )}
              
              <div className="mt-3 pt-2 border-t border-gray-200/50 no-print">
                {isAdding && !hasSuggestions ? (<div className="flex flex-col gap-2 animate-fadeIn"><textarea ref={inputRef} placeholder={t.addItem} className="w-full p-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-200 focus:outline-none resize-none bg-white shadow-inner text-gray-800" rows={2} value={newItemText} onChange={(e) => setNewItemText(e.target.value)} onKeyDown={(e) => { if(e.key === 'Enter' && !e.shiftKey && !e.nativeEvent.isComposing) { e.preventDefault(); handleAddItem(sectionKey, newItemText); } if(e.key === 'Escape') { setActiveSection(null); setNewItemText(''); } }} /><div className="flex justify-end gap-2"><button onClick={() => { setActiveSection(null); setNewItemText(''); }} className="px-3 py-1 text-xs text-gray-500 hover:text-gray-700">Cancel</button><button onClick={() => handleAddItem(sectionKey, newItemText)} className="px-3 py-1 text-xs bg-indigo-600 text-white rounded hover:bg-indigo-700 shadow-sm font-medium">Add</button></div></div>) : (!hasSuggestions && (<div className="flex gap-2"><button onClick={() => setActiveSection(sectionKey)} className="flex-1 flex items-center gap-1.5 text-xs font-medium text-gray-400 hover:text-indigo-600 transition-colors p-1.5 rounded hover:bg-white/50 group"><div className="w-5 h-5 rounded-full bg-white border border-gray-200 flex items-center justify-center group-hover:border-indigo-300 group-hover:text-indigo-600 transition-colors"><Plus size={12} /></div><span>{t.addItem}</span></button><div className="flex gap-1"><button onClick={() => openConsultant('section', sectionKey)} className="p-1.5 bg-white/50 text-indigo-400 hover:text-indigo-600 hover:bg-white rounded shadow-sm border border-transparent hover:border-indigo-100 transition-all" title={t.aiSpark}><Sparkles size={14} /></button></div></div>))}
              </div>
            </div>
          );
        };

        export default function BusinessCanvasAI() {
          const [canvasData, setCanvasData] = useState(initialCanvasDataStructure); 
          const [activeSection, setActiveSection] = useState(null);
          const [newItemText, setNewItemText] = useState('');
          const [businessContext, setBusinessContext] = useState('');
          const [customGuides, setCustomGuides] = useState({});
          const [aiSuggestions, setAiSuggestions] = useState(null); 
          const [lang, setLang] = useState('zh');
          const [isSustainableMode, setIsSustainableMode] = useState(false);
          const [dailyUsage, setDailyUsage] = useState(getLocalUsage());
          
          const [isContextModalOpen, setIsContextModalOpen] = useState(false);
          const [brandModalOpen, setBrandModalOpen] = useState(false); 
          const [isEmailModalOpen, setIsEmailModalOpen] = useState(false); 
          const [encyclopediaOpen, setEncyclopediaOpen] = useState(false);
          const [topicGuide, setTopicGuide] = useState({ isOpen: false, sectionId: null });
          const [consultant, setConsultant] = useState({ isOpen: false, mode: 'global', sectionId: null });
          const [itemRefiner, setItemRefiner] = useState({ isOpen: false, item: null, sectionTitle: '' });
          
          const [isBrandAnalyzing, setIsBrandAnalyzing] = useState(false);
          const [isAnalyzing, setIsAnalyzing] = useState(false);
          const [loadingPersonalize, setLoadingPersonalize] = useState(false);

          const t = TRANSLATIONS[lang];

          // Áõ£ËÅΩÈ°çÂ∫¶Êõ¥Êñ∞
          useEffect(() => {
            const handleUpdate = () => setDailyUsage(getLocalUsage());
            window.addEventListener('usageUpdated', handleUpdate);
            return () => window.removeEventListener('usageUpdated', handleUpdate);
          }, []);

          // ÂæπÂ∫ïÁöÑÈáçÁΩÆÂäüËÉΩ
          const handleFullReset = () => {
              if (!confirm(t.resetModalDesc)) return;
              setCanvasData(initialCanvasDataStructure);
              setBusinessContext('');
              setCustomGuides({});
              setAiSuggestions(null);
          };

          const handleAddItem = (sectionId, text) => { if (!text || !text.trim()) return; setCanvasData(prev => ({ ...prev, [sectionId]: { ...prev[sectionId], items: [...prev[sectionId].items, { id: Date.now() + Math.random(), text: text.trim() }] } })); setNewItemText(''); };
          const handleDeleteItem = (sectionId, itemId) => { setCanvasData(prev => ({ ...prev, [sectionId]: { ...prev[sectionId], items: prev[sectionId].items.filter(item => item.id !== itemId) } })); };
          
          const openConsultant = (mode, sectionId = null) => { if (!businessContext.trim()) { setIsContextModalOpen(true); return; } setConsultant({ isOpen: true, mode, sectionId }); };
          const openItemRefiner = (item, sectionTitle) => { setItemRefiner({ isOpen: true, item, sectionTitle }); };
          const openTopicGuide = (sectionId) => { setTopicGuide({ isOpen: true, sectionId }); };
          const saveRefinedItem = (newText) => { if (itemRefiner.item) { setCanvasData(prev => { const newData = { ...prev }; for (const key in newData) { const items = newData[key].items; const index = items.findIndex(i => i.id === itemRefiner.item.id); if (index !== -1) { newData[key] = { ...newData[key], items: items.map(i => i.id === itemRefiner.item.id ? { ...i, text: newText } : i) }; break; } } return newData; }); } setItemRefiner({ ...itemRefiner, isOpen: false }); };

          const handlePersonalizeGuides = async () => {
              if (!businessContext) return;
              setLoadingPersonalize(true);
              try {
                  const keys = Object.keys(canvasData);
                  const prompt = `Context: ${businessContext}. Rewrite 1-sentence UI subtitle for BMC sections. Return JSON { sectionId: { subtitle: "text" } }. Keys: ${keys.join(',')}. Lang: ${lang==='zh'?'Traditional Chinese':'English'}.`;
                  const res = await geminiCall(prompt, true);
                  setCustomGuides(res);
              } catch(e) { console.error(e); } finally { setLoadingPersonalize(false); }
          };

          const handleBrandAnalysis = async (brandName) => {
              if (!brandName) return;
              setIsBrandAnalyzing(true);
              setBusinessContext(brandName); 
              const keys = Object.keys(initialCanvasDataStructure);
              const prompt = `Analyze "${brandName}". Generate full BMC. Return JSON. Keys: ${keys.join(',')}. Values: Array of 3 strings. Lang: ${lang==='zh'?'Traditional Chinese':'English'}.`;
              try {
                  const result = await geminiCall(prompt, true);
                  setCanvasData(prev => {
                      const newData = { ...prev };
                      Object.keys(result).forEach(key => { if (newData[key]) { newData[key] = { ...newData[key], items: result[key].map(t => ({ id: Date.now() + Math.random(), text: t })) }; } });
                      return newData;
                  });
              } catch (e) { console.error(e); } finally { setIsBrandAnalyzing(false); }
          };

          const handleAnalysis = async () => {
              if (!businessContext.trim()) { setIsContextModalOpen(true); return; }
              setIsAnalyzing(true);
              const content = {}; Object.keys(canvasData).forEach(key => { content[key] = canvasData[key].items.map(i => i.text); });
              const prompt = `Diagnose this BMC. Theme: ${businessContext}. Content: ${JSON.stringify(content)}. Provide concise feedback. Lang: ${lang==='zh'?'Traditional Chinese':'English'}. No Markdown.`;
              try { const result = await geminiCall(prompt, false); alert(result); } catch (err) { console.error(err); } finally { setIsAnalyzing(false); }
          };

          const sectionProps = { canvasData, activeSection, setActiveSection, newItemText, setNewItemText, handleAddItem, handleDeleteItem, openConsultant, openItemRefiner, aiSuggestions, setAiSuggestions, openTopicGuide, t, customGuides };

          return (
            <div className="min-h-screen bg-[#F3F4F6] p-2 md:p-6 font-sans text-slate-800">
              <ContextModal isOpen={isContextModalOpen} onClose={() => setIsContextModalOpen(false)} value={businessContext} onChange={setBusinessContext} t={t} lang={lang} onStart={handlePersonalizeGuides} />
              <EmailModal isOpen={isEmailModalOpen} onClose={() => setIsEmailModalOpen(false)} canvasData={canvasData} t={t} context={businessContext} />
              <AiConsultantModal isOpen={consultant.isOpen} onClose={() => setConsultant({ ...consultant, isOpen: false })} mode={consultant.mode} sectionId={consultant.sectionId} context={businessContext} canvasData={canvasData} onComplete={(res, mode)=>{ if(mode==='global'){ setCanvasData(prev => { const n={...prev}; Object.keys(res).forEach(k=>{ if(n[k]) n[k].items = res[k].map(t=>({id:Date.now()+Math.random(), text:t})) }); return n; }); } else { setAiSuggestions({ sectionId: consultant.sectionId, items: res }); } }} t={t} lang={lang} />
              <ItemRefineModal isOpen={itemRefiner.isOpen} onClose={() => setItemRefiner({ ...itemRefiner, isOpen: false })} item={itemRefiner.item} context={businessContext} sectionTitle={itemRefiner.sectionTitle} onSave={saveRefinedItem} t={t} lang={lang} />
              <BrandModal isOpen={brandModalOpen} onClose={() => setBrandModalOpen(false)} onSelect={handleBrandAnalysis} t={t} />
              <TopicGuideModal isOpen={topicGuide.isOpen} onClose={() => setTopicGuide({ ...topicGuide, isOpen: false })} sectionId={topicGuide.sectionId} t={t} customGuides={customGuides} />
              <EncyclopediaModal isOpen={encyclopediaOpen} onClose={() => setEncyclopediaOpen(false)} t={t} customGuides={customGuides} />
              {isBrandAnalyzing && (<div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[10000] flex flex-col items-center justify-center text-white"><Loader2 size={64} className="animate-spin mb-4 text-blue-400" /><h2 className="text-2xl font-bold mb-2">{t.loadingAnalysis}</h2></div>)}
              {isAnalyzing && (<div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[10000] flex flex-col items-center justify-center text-white"><ClipboardCheck size={64} className="animate-bounce mb-4 text-emerald-400" /><h2 className="text-2xl font-bold mb-2">{t.loadingDiagnose}</h2></div>)}
              {loadingPersonalize && (<div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[10000] flex flex-col items-center justify-center text-white"><Wand2 size={64} className="animate-pulse mb-4 text-purple-400" /><h2 className="text-2xl font-bold mb-2">{t.loadingPersonalize}</h2></div>)}

              <header className="max-w-[1440px] mx-auto mb-4 flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-200 no-print">
                <div className="flex items-center gap-4 w-full md:w-auto shrink-0">
                    <div className="p-2.5 bg-slate-800 rounded-lg shadow-lg text-white"><Layout size={24} /></div>
                    <div>
                        <h1 className="text-2xl font-bold text-slate-800 tracking-tight">{t.title} <span className="text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full ml-2">v5.3</span></h1>
                        <div className="text-sm text-gray-500 mt-1 flex items-center gap-2">
                            <button onClick={()=>setIsContextModalOpen(true)} className="flex items-center gap-1 hover:text-indigo-600 transition-colors border-b border-dashed border-gray-300 hover:border-indigo-500"><Edit3 size={12}/> {businessContext || t.setupAI}</button>
                        </div>
                    </div>
                </div>
                
                <div className="flex items-center justify-end w-full overflow-x-auto no-scrollbar gap-2 py-2">
                     <div className={`flex items-center gap-1.5 px-3 py-2 rounded-lg border text-xs font-bold shrink-0 ${dailyUsage >= (firebaseConfig ? GLOBAL_DAILY_LIMIT : 50) ? "bg-red-50 text-red-600 border-red-200" : "bg-emerald-50 text-emerald-600 border-emerald-200"}`} title={t.quotaDesc}><Activity size={14} /><span>{dailyUsage}/{firebaseConfig ? GLOBAL_DAILY_LIMIT : 50}</span></div>
                     <button onClick={()=>setLang(l => l==='zh'?'en':'zh')} className="flex items-center gap-1.5 px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm text-gray-600 hover:bg-gray-50 font-medium shrink-0"><Globe size={16}/> {lang === 'zh' ? 'En' : '‰∏≠'}</button>
                     <button onClick={()=>setEncyclopediaOpen(true)} className="px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm hover:bg-gray-50 flex items-center gap-2 text-gray-700 font-medium shrink-0"><BookOpen size={16}/> {t.encyclopediaBtn}</button>
                     <button onClick={()=>setIsSustainableMode(!isSustainableMode)} className={`px-3 py-2 rounded-lg border text-sm font-bold flex items-center gap-2 transition-colors shrink-0 ${isSustainableMode ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'bg-white border-gray-200 text-gray-600'}`}>{isSustainableMode ? <ToggleRight size={18}/> : <ToggleLeft size={18}/>} {isSustainableMode ? t.modeSustainable : t.modeStandard}</button>
                     <button onClick={()=>setBrandModalOpen(true)} className="px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm hover:bg-gray-50 flex items-center gap-2 text-gray-700 font-medium shrink-0"><Building2 size={16}/> {t.brandCases}</button>
                     <button onClick={()=>openConsultant('global')} className="px-4 py-2 bg-slate-800 text-white rounded-lg shadow hover:bg-slate-900 flex items-center gap-2 font-bold transition-transform hover:scale-105 active:scale-95 shrink-0"><Wand2 size={16}/> {t.generateOneClick}</button>
                     <div className="w-px h-8 bg-gray-200 mx-1 shrink-0"></div>
                     <button onClick={handleFullReset} className="p-2 hover:bg-red-50 hover:text-red-500 rounded text-gray-400 shrink-0" title={t.reset}><RotateCcw size={18}/></button>
                </div>
              </header>

              <InstructionCard t={t} />

              <main className="max-w-[1440px] mx-auto bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200 print-border">
                <div className="grid grid-cols-1 md:grid-cols-5 divide-y md:divide-y-0 md:divide-x divide-gray-100 print:grid-cols-5 print:divide-x print:divide-gray-300">
                    <div className="md:col-span-5 bg-slate-50 p-1 px-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest flex items-center gap-1 border-b border-gray-100"><Briefcase size={10}/> {t.layers.biz}</div>
                    <div className="md:row-span-2 flex flex-col"><CanvasSection sectionKey="keyPartners" canvasData={canvasData} {...sectionProps} className="h-full" /></div>
                    <div className="md:col-span-1 flex flex-col"><CanvasSection sectionKey="keyActivities" canvasData={canvasData} {...sectionProps} className="flex-1" /><CanvasSection sectionKey="keyResources" canvasData={canvasData} {...sectionProps} className="flex-1" /></div>
                    <div className="md:row-span-2 flex flex-col z-10 bg-indigo-50/10 border-l border-r border-indigo-100"><CanvasSection sectionKey="valuePropositions" canvasData={canvasData} {...sectionProps} className="h-full" /></div>
                    <div className="md:col-span-1 flex flex-col"><CanvasSection sectionKey="customerRelationships" canvasData={canvasData} {...sectionProps} className="flex-1" /><CanvasSection sectionKey="channels" canvasData={canvasData} {...sectionProps} className="flex-1" /></div>
                    <div className="md:row-span-2 flex flex-col"><CanvasSection sectionKey="customerSegments" canvasData={canvasData} {...sectionProps} className="h-full" /></div>
                    <div className="md:col-span-5 grid grid-cols-1 md:grid-cols-2 border-t border-gray-100">
                        <div className="p-1 px-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest col-span-2 bg-slate-50 border-b border-gray-100 flex items-center gap-1"><Coins size={10}/> {t.layers.eco}</div>
                        <CanvasSection sectionKey="costStructure" canvasData={canvasData} {...sectionProps} />
                        <CanvasSection sectionKey="revenueStreams" canvasData={canvasData} {...sectionProps} />
                    </div>
                    {isSustainableMode && (
                        <>
                            <div className="md:col-span-5 grid grid-cols-1 md:grid-cols-2 border-t border-gray-100">
                                <div className="p-1 px-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest col-span-2 bg-slate-50 border-b border-gray-100 flex items-center gap-1"><Leaf size={10}/> {t.layers.env}</div>
                                <CanvasSection sectionKey="envCost" canvasData={canvasData} {...sectionProps} />
                                <CanvasSection sectionKey="envBenefit" canvasData={canvasData} {...sectionProps} />
                            </div>
                            <div className="md:col-span-5 grid grid-cols-1 md:grid-cols-2 border-t border-gray-100">
                                <div className="p-1 px-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest col-span-2 bg-slate-50 border-b border-gray-100 flex items-center gap-1"><Heart size={10}/> {t.layers.soc}</div>
                                <CanvasSection sectionKey="socCost" canvasData={canvasData} {...sectionProps} />
                                <CanvasSection sectionKey="socBenefit" canvasData={canvasData} {...sectionProps} />
                            </div>
                        </>
                    )}
                </div>
              </main>

              <div className="max-w-[1440px] mx-auto mt-8 mb-12 p-8 bg-white rounded-2xl border border-gray-200 text-center shadow-sm relative overflow-hidden no-print">
                  <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-400 to-indigo-500"></div>
                  <h2 className="text-2xl font-bold text-slate-800 mb-3 flex items-center justify-center gap-2"><ClipboardCheck className="text-indigo-600" /> {t.diagnoseTitle}</h2>
                  <p className="text-gray-500 mb-6 max-w-2xl mx-auto">{t.diagnoseDesc}</p>
                  <div className="flex justify-center gap-4">
                      <button onClick={handleAnalysis} className="px-8 py-3 bg-white border border-gray-300 rounded-xl shadow-sm hover:bg-gray-50 font-bold flex items-center gap-2 text-slate-700"><ClipboardCheck size={20}/> {t.btnDiagnose}</button>
                      <button onClick={()=>setIsEmailModalOpen(true)} className="px-8 py-3 bg-slate-800 text-white rounded-xl shadow-lg hover:bg-slate-900 font-bold flex items-center gap-2"><Mail size={20}/> {t.btnEmail}</button>
                  </div>
              </div>
              <footer className="text-center text-gray-400 text-xs mt-8 pb-8 no-print">Designed for Strategy & Clarity (Public Edition)</footer>
            </div>
          );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<BusinessCanvasAI />);
    </script>
</body>
</html>