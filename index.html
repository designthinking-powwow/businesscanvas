<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å•†æ¥­æ¨¡å¼ç•«å¸ƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.2s ease-out forwards; }
        .animate-slideIn { animation: slideIn 0.2s ease-out forwards; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @media print {
            body { background: white; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            .print-border { border: 2px solid #333 !important; }
            .print-shadow-none { box-shadow: none !important; }
        }
    </style>
</head>
<body class="bg-[#F3F4F6] text-slate-800 font-sans">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // =================================================================================
        //  ç³»çµ±è¨­å®šå€ (System Configuration)
        // =================================================================================
        
        // 1. API Key è¨­å®š
        const apiKey = "AIzaSyBGC9_EOIRNkUA1Sf0VH1S9Ua9Cxmj8Uh4"; 

        // 2. Firebase è¨­å®š (ç”¨æ–¼å…¨åŸŸé¡åº¦æ§åˆ¶ï¼Œé¸å¡«)
        const firebaseConfig = null; 

        // å…¨ç«™æ¯æ—¥æœ€å¤§ API å‘¼å«æ¬¡æ•¸ (Firebase ç”¨)
        const GLOBAL_DAILY_LIMIT = 1000; 
        
        // å€‹äººæœ¬æ©Ÿæ¯æ—¥é™åˆ¶ (å·²æ”¹å› 50 æ¬¡)
        const LOCAL_DAILY_LIMIT = 50; 

        // =================================================================================

        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import * as LucideReact from 'https://esm.sh/lucide-react@0.292.0';
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, getDoc, updateDoc, increment, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const { 
            Plus, X, Trash2, Layout, RotateCcw, Sparkles, Lightbulb, MessageSquare, 
            Loader2, Settings, Leaf, Heart, Coins, Wand2, HelpCircle, ChevronUp, 
            ClipboardCheck, AlertTriangle, CheckCircle2, Mail, 
            Send, FileText, ShieldCheck, MessageCircleQuestion, Edit3, Bot, 
            Building2, Globe, Lock, Briefcase, BookOpen, ToggleLeft, ToggleRight, Activity, AlertCircle
        } = LucideReact;

        // --- Firebase åˆå§‹åŒ– ---
        let db = null;
        if (firebaseConfig) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const auth = getAuth(app);
                signInAnonymously(auth).catch(console.error);
            } catch (e) {
                console.warn("Firebase Init Error (Using Local Mode):", e);
            }
        }

        // --- é¡åº¦æ§åˆ¶é‚è¼¯ ---
        const checkAndIncrementUsage = async () => {
            const today = new Date().toISOString().slice(0, 10);

            // 1. Firebase å…¨åŸŸæª¢æŸ¥
            if (db) {
                const docRef = doc(db, "usage_stats", today);
                try {
                    const docSnap = await getDoc(docRef);
                    let currentCount = 0;
                    if (docSnap.exists()) {
                        currentCount = docSnap.data().count || 0;
                    } else {
                        await setDoc(docRef, { count: 0 });
                    }
                    if (currentCount >= GLOBAL_DAILY_LIMIT) throw new Error(`ç³»çµ±ä»Šæ—¥å…¨ç«™é¡åº¦å·²æ»¿ï¼Œè«‹æ˜æ—¥å†è©¦ã€‚`);
                    await updateDoc(docRef, { count: increment(1) });
                } catch (e) {
                    if (e.message.includes("å·²æ»¿")) throw e;
                    console.warn("Firestore access failed, falling back to local.");
                }
            }

            // 2. æœ¬æ©Ÿæª¢æŸ¥
            const LOCAL_KEY = 'local_usage_stats';
            const stored = localStorage.getItem(LOCAL_KEY);
            let stats = { date: today, count: 0 };
            if (stored) {
                const parsed = JSON.parse(stored);
                if (parsed.date === today) stats = parsed;
            }
            
            if (stats.count >= LOCAL_DAILY_LIMIT) {
                throw new Error(`æ³¨æ„ï¼šé€™æ˜¯å…è²»æœ‰é¡åº¦é™åˆ¶çš„æœå‹™ã€‚\n\næ‚¨å·²è¶…éæ¯æ—¥ ${LOCAL_DAILY_LIMIT} æ¬¡çš„ä½¿ç”¨é¡åº¦ï¼Œè«‹æ˜å¤©å†ä¾†ï¼`);
            }
            
            stats.count += 1;
            localStorage.setItem(LOCAL_KEY, JSON.stringify(stats));
            window.dispatchEvent(new Event('usageUpdated'));
            return true;
        };

        const getLocalUsage = () => {
            const today = new Date().toISOString().slice(0, 10);
            const stored = localStorage.getItem('local_usage_stats');
            if (stored) {
                const parsed = JSON.parse(stored);
                if (parsed.date === today) return parsed.count;
            }
            return 0;
        };

        // --- ç¿»è­¯è³‡æ–™åº« ---
        const TRANSLATIONS = {
          zh: {
            title: "å•†æ¥­æ¨¡å¼ç•«å¸ƒ",
            subtitle: "AI Power", 
            setupAI: "è¨­å®šä¸»é¡Œ",
            reset: "é‡ç½®",
            brandCases: "å“ç‰Œæ¡ˆä¾‹",
            generateOneClick: "ä¸€éµç”Ÿæˆ",
            instructionShow: "æ–°æ‰‹æŒ‡å—",
            instructionHide: "æ”¶èµ·èªªæ˜",
            encyclopediaBtn: "å•†æ¥­ç™¾ç§‘",
            modeStandard: "æ¨™æº–æ¨¡å¼",
            modeSustainable: "æ°¸çºŒæ¨¡å¼",
            usageTitle: "ä»Šæ—¥é¡åº¦",
            language: "English",
            version: "v1",
            instructionTitle: "å¦‚ä½•ä½¿ç”¨æœ¬å·¥å…·ï¼š",
            step1Title: "1. è¨­å®šä¸»é¡Œ",
            step1Desc: "é»æ“Šå·¦ä¸Šè§’çš„ã€Œè¨­å®šä¸»é¡Œã€ï¼ŒAI æœƒæ ¹æ“šæ‚¨çš„è¡Œæ¥­è‡ªå‹•æ”¹å¯«å¼•å°æ–‡å­—ã€‚",
            step2Title: "2. æ™ºèƒ½ç™¼æƒ³",
            step2Desc: "ä½¿ç”¨å€å¡Šä¸‹æ–¹çš„ã€ŒAI éˆæ„Ÿã€å¿«é€Ÿç”Ÿæˆå…§å®¹ã€‚é»æ“Šä¾¿æ¢ç´™å¯ä½¿ç”¨ AI å„ªåŒ–ã€‚",
            step3Title: "3. è¨ºæ–·èˆ‡åˆ†äº«",
            step3Desc: "ä½¿ç”¨ã€Œå•†æ¥­è¨ºæ–·ã€æ‰¾å‡ºç›²é»ï¼Œå®Œæˆå¾Œå¯å°‡å ±å‘Šå¯„è‡³ Email ä¿å­˜ã€‚",
            quotaTitle: "4. å…è²»é¡åº¦é™åˆ¶",
            quotaDesc: "æœ¬å·¥å…·ç‚ºå…è²»æä¾›ï¼Œè¨­æœ‰æ¯æ—¥ä½¿ç”¨ä¸Šé™ã€‚å¦‚æœæ‚¨æ”¶åˆ°é€šçŸ¥ï¼Œè¡¨ç¤ºå·²è¶…éæ¯æ—¥é¡åº¦ï¼Œè«‹æ˜æ—¥å†è©¦ã€‚", // æ‚¨æŒ‡å®šçš„èªªæ˜
            aiConsultantTitle: "AI å‰µæ¥­å°å¸«",
            aiConsultantDesc: "è«‹å›ç­”å¹¾å€‹ç°¡å–®å•é¡Œï¼Œè®“æˆ‘ç‚ºæ‚¨æ§‹æ€ã€‚",
            submitAndGenerate: "ç”Ÿæˆç•«å¸ƒ",
            skipAndGenerate: "ç›´æ¥ç”Ÿæˆ",
            loadingAnalysis: "AI æ­£åœ¨åˆ†æ...",
            loadingGlobal: "AI æ­£åœ¨æ§‹æ€æ•´å¼µè—åœ–...",
            loadingDiagnose: "AI é¡§å•æ­£åœ¨é€²è¡Œå•†æ¥­å¥æª¢...",
            loadingPersonalize: "AI æ­£åœ¨å®¢è£½åŒ–å¼•å°æ–‡å­—...",
            diagnoseTitle: "å•†æ¥­æ¨¡å¼è¨ºæ–·",
            diagnoseDesc: "è®“ AI é¡§å•å¹«æ‚¨æ‰¾å‡ºæ½›åœ¨ç›²é»ã€é¢¨éšªèˆ‡å„ªå‹¢åˆ†æã€‚",
            btnDiagnose: "é–‹å§‹è¨ºæ–·",
            btnEmail: "Email å¯„é€å ±å‘Š",
            modalContextTitle: "æ‚¨æƒ³åšä»€éº¼ç”Ÿæ„ï¼Ÿ",
            modalContextDesc: "å‘Šè¨´æˆ‘å€‘æ‚¨çš„æƒ³æ³•ï¼ŒAI å°‡æœƒç‚ºæ‚¨ã€Œå®¢è£½åŒ–ã€ä»‹é¢ä¸Šçš„å¼•å°èªªæ˜ã€‚",
            placeholderContext: "ä¾‹å¦‚ï¼šæˆ‘æƒ³åœ¨å°åŒ—å¸‚é–‹ä¸€é–“ä¸»æ‰“å¯é Œçš„ç²¾å“å’–å•¡å»³...",
            btnNoSet: "æš«ä¸è¨­å®š",
            btnStartPlan: "é–‹å§‹è¦åŠƒ",
            brandModalTitle: "å“ç‰Œæ¡ˆä¾‹æ™ºåº«",
            brandModalDesc: "é¸æ“‡ä¸€å€‹çŸ¥åå“ç‰Œï¼ŒAI å°‡ç‚ºæ‚¨æ‹†è§£å…¶å•†æ¥­æ¨¡å¼ã€‚",
            searchPlaceholder: "è¼¸å…¥ä»»ä½•å“ç‰Œ...",
            btnAnalyze: "AI åˆ†æ (è¦†è“‹)",
            brandOverwriteWarning: "âš ï¸ æ­¤æ“ä½œå°‡è¦†è“‹ç›®å‰å…§å®¹",
            brandDisclaimer: "å…§å®¹ç”± AI ç”Ÿæˆï¼Œåƒ…ä¾›åƒè€ƒã€‚",
            refineTitle: "å…§å®¹å„ªåŒ–å™¨",
            refineLabel: "åŸå§‹å…§å®¹",
            btnSpecific: "ğŸ¯ æ›´å…·é«”åŒ–",
            btnAttractive: "âœ¨ æ›´å¸å¼•äºº",
            btnCritique: "ğŸ§ æ‰¾ç›²é»",
            placeholderRefine: "æˆ–è¼¸å…¥è‡ªå®šç¾©æŒ‡ä»¤...",
            btnConfirmRefine: "ç¢ºèªä¿®æ”¹",
            emailTitle: "å¯„é€æ‚¨çš„å•†æ¥­æ¨¡å¼åœ–",
            emailDesc: "æ³¨æ„ï¼šå—é™æ–¼ç¶²é æŠ€è¡“ï¼Œæˆ‘å€‘ç„¡æ³•ç›´æ¥å¤¾å¸¶æª”æ¡ˆã€‚ç³»çµ±å°‡æœƒè‡ªå‹•æŠŠç•«å¸ƒå…§å®¹æ•´ç†æˆã€Œæ–‡å­—å ±å‘Šã€ï¼Œä¸¦å¡«å…¥æ‚¨çš„éƒµä»¶å…§æ–‡ä¸­ã€‚",
            labelName: "æ‚¨çš„ç¨±å‘¼",
            labelEmail: "æ”¶ä»¶ä¿¡ç®±",
            privacyNote: "æ­¤æ“ä½œå°‡é–‹å•Ÿæ‚¨è£ç½®ä¸Šçš„é è¨­éƒµä»¶ App (å¦‚ Gmail/Outlook)ã€‚",
            btnSend: "é–‹å•Ÿéƒµä»¶è»Ÿé«” (å¡«å…¥æ–‡å­—å ±å‘Š)",
            btnSending: "æº–å‚™ä¸­...",
            sentTitle: "å·²é–‹å•Ÿ",
            sentDesc: "è«‹åœ¨è·³å‡ºçš„éƒµä»¶è¦–çª—ä¸­ç¢ºèªå…§å®¹ä¸¦æŒ‰ä¸‹å‚³é€ã€‚",
            btnBack: "è¿”å›ç•«å¸ƒ",
            reportTitle: "AI è¨ºæ–·å ±å‘Š",
            btnUnderstand: "äº†è§£",
            resetModalTitle: "ç¢ºèªé‡ç½®ï¼Ÿ",
            resetModalDesc: "é€™å°‡æ¸…ç©ºç•«å¸ƒä¸Šçš„æ‰€æœ‰å…§å®¹ã€ä¸»é¡Œèˆ‡å»ºè­°ã€‚ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ",
            btnSaveAndReset: "é‡ç½®",
            btnClearOnly: "é‡ç½®",
            btnCancel: "å–æ¶ˆ",
            encyclopediaModalTitle: "å•†æ¥­æ¨¡å¼ç™¾ç§‘å…¨æ›¸",
            encyclopediaModalDesc: "é»é¸å·¦å´é …ç›®ï¼Œæ·±å…¥äº†è§£æ¯å€‹å€å¡Šçš„å®šç¾©èˆ‡å¡«å¯«æŠ€å·§ã€‚",
            addItem: "æ–°å¢é …ç›®...",
            aiSpark: "AI éˆæ„Ÿ",
            topicHelp: "å®šç¾©",
            sections: {
              keyPartners: { title: "é—œéµåˆä½œå¤¥ä¼´", subtitle: "èª°å¹«æˆ‘å€‘åˆ†æ“”é¢¨éšªï¼Ÿ", desc: "éã€Œä¸€èˆ¬æ¡è³¼ã€å°è±¡ï¼Œè€Œæ˜¯ç­–ç•¥ç›Ÿå‹ã€‚(ä¾‹ï¼šéç«¶çˆ­è€…çš„ç•°æ¥­çµç›Ÿã€ç«¶åˆå¤¥ä¼´ã€é—œéµå¤–åŒ…å•†)" },
              keyActivities: { title: "é—œéµæ´»å‹•", subtitle: "å…·é«”è¦åŸ·è¡Œä»€éº¼è¡Œå‹•ï¼Ÿ", desc: "è«‹å¯«å…·é«”å‹•ä½œï¼Œä¸è¦åªå¯«ã€Œè¡ŒéŠ·ã€ï¼Œè¦å¯«ã€Œç¶“ç‡Ÿ FB ç¤¾ç¾¤ã€æˆ–ã€ŒæŠ•æ”¾é—œéµå­—å»£å‘Šã€ã€‚(æ ¸å¿ƒåŸ·è¡Œé …ç›®)" },
              keyResources: { title: "é—œéµè³‡æº", subtitle: "ä½ æ‰‹ä¸Šæœ‰ä»€éº¼æ­¦å™¨ï¼Ÿ", desc: "æ²’äº†é€™äº›æ±è¥¿ï¼Œç”Ÿæ„å°±åšä¸ä¸‹å»ã€‚(ä¾‹ï¼šåº—é¢ã€è³‡é‡‘ã€å°ˆåˆ©æŠ€è¡“ã€å°ˆæ¥­äººæ‰)" },
              valuePropositions: { title: "åƒ¹å€¼ä¸»å¼µ", subtitle: "å®¢äººç‚ºä»€éº¼é¸ä½ ä¸é¸åˆ¥äººï¼Ÿ", desc: "ä½ å¹«å®¢äººè§£æ±ºäº†ä»€éº¼ç…©æƒ±ï¼Ÿ(ä¾‹ï¼šä¸æ˜¯ã€Œè³£é›»é‘½ã€è€Œæ˜¯ã€Œæä¾›ç‰†ä¸Šçš„æ´ã€ã€æ›´çœæ™‚ã€æ›´ä¾¿å®œ)" },
              customerRelationships: { title: "å®¢æˆ¶é—œä¿‚", subtitle: "ä½ æ€éº¼è·Ÿå®¢äººææ„Ÿæƒ…ï¼Ÿ", desc: "æ˜¯åƒè€æœ‹å‹ä¸€æ¨£é•·æœŸäº’å‹•ï¼Œé‚„æ˜¯éŠ€è²¨å…©è¨–ï¼Ÿ(ä¾‹ï¼šæœƒå“¡åˆ¶ã€å°ˆäººæœå‹™ã€ç¤¾ç¾¤å°ç·¨)" },
              channels: { title: "é€šè·¯", subtitle: "å®¢äººåœ¨å“ªè£¡çœ‹åˆ°ä½ ã€è²·åˆ°ä½ ï¼Ÿ", desc: "ä½ çš„æ±è¥¿æ€éº¼é€åˆ°å®¢äººæ‰‹ä¸Šï¼Ÿ(ä¾‹ï¼šå¯¦é«”åº—é¢ã€ç¶²ç«™ã€Appã€å¤–é€å¹³å°)" },
              customerSegments: { title: "ç›®æ¨™å®¢ç¾¤", subtitle: "èª°æœƒè²·ä½ çš„å–®ï¼Ÿ", desc: "ä½ çš„ç”¢å“æ˜¯è¦è³£çµ¦èª°ï¼Ÿè«‹å…·é«”æç¹ªä»–å€‘çš„æ¨£å­ã€‚(ä¾‹ï¼šå¿™ç¢Œçš„ä¸Šç­æ—ã€ç´ é£Ÿæ„›å¥½è€…)" },
              costStructure: { title: "æˆæœ¬çµæ§‹", subtitle: "éŒ¢éƒ½èŠ±å»å“ªäº†ï¼Ÿ", desc: "åšé€™é–€ç”Ÿæ„ï¼Œæœ€å¤§çš„é–‹éŠ·æœ‰å“ªäº›ï¼Ÿ(ä¾‹ï¼šæˆ¿ç§Ÿã€å“¡å·¥è–ªæ°´ã€åŸç‰©æ–™è²»ç”¨)" },
              revenueStreams: { title: "æ”¶ç›Šæµ", subtitle: "éŒ¢å¾å“ªè£¡é€²ä¾†ï¼Ÿ", desc: "ä½ é ä»€éº¼æ–¹å¼æ”¶éŒ¢ï¼Ÿ(ä¾‹ï¼šè³£ç”¢å“è³ºåƒ¹å·®ã€æ”¶æœƒå“¡è²»ã€æŠ½æˆã€æ”¶å»£å‘Šè²»)" },
              envCost: { title: "ç’°å¢ƒæˆæœ¬", subtitle: "æœƒä¸æœƒå¼„é«’ç’°å¢ƒï¼Ÿ", desc: "åœ¨ç”Ÿç”¢æˆ–éŠ·å”®éç¨‹ä¸­ï¼Œæœƒè£½é€ ä»€éº¼æ±™æŸ“æˆ–åƒåœ¾ï¼Ÿ(ä¾‹ï¼šå…æ´—é¤å…·ã€å»¢æ°£ã€å¤§é‡å»šé¤˜)" },
              envBenefit: { title: "ç’°å¢ƒæ•ˆç›Š", subtitle: "èƒ½ç‚ºåœ°çƒåšä»€éº¼å¥½äº‹ï¼Ÿ", desc: "ä½ çš„ç”Ÿæ„èƒ½è®“ç’°å¢ƒè®Šæ›´å¥½å—ï¼Ÿ(ä¾‹ï¼šä½¿ç”¨å›æ”¶æè³ªã€ç¯€çœèƒ½æºã€æ¸›å°‘æµªè²»)" },
              socCost: { title: "ç¤¾æœƒæˆæœ¬", subtitle: "æœƒä¸æœƒæœ‰è² é¢å½±éŸ¿ï¼Ÿ", desc: "æœ‰æ²’æœ‰å¯èƒ½è®“å“¡å·¥å¤ªç´¯ï¼Œæˆ–åµåˆ°é„°å±…ï¼Ÿ(ä¾‹ï¼šå·¥æ™‚éé•·ã€å™ªéŸ³å¹²æ“¾ã€å€‹è³‡å¤–æ´©é¢¨éšª)" },
              socBenefit: { title: "ç¤¾æœƒæ•ˆç›Š", subtitle: "èƒ½å¹«ç¤¾æœƒè§£æ±ºä»€éº¼å•é¡Œï¼Ÿ", desc: "é™¤äº†è³ºéŒ¢ï¼Œä½ é‚„å¹«åŠ©äº†èª°ï¼Ÿ(ä¾‹ï¼šé›‡ç”¨äºŒåº¦å°±æ¥­ã€æ”¯æŒåœ¨åœ°å°è¾²ã€ææ¬¾å…¬ç›Š)" },
            },
            layers: { biz: "å•†æ¥­æ ¸å¿ƒå±¤é¢", eco: "ç¶“æ¿Ÿå±¤é¢", env: "ç’°å¢ƒå±¤é¢", soc: "ç¤¾æœƒå±¤é¢" }
          },
          en: {
            title: "Business Model Canvas",
            subtitle: "Public AI",
            version: "v1",
            setupAI: "Set Topic",
            reset: "Reset",
            brandCases: "Brand Cases",
            generateOneClick: "One-Click",
            instructionShow: "Guide & Limits",
            instructionHide: "Hide Guide",
            encyclopediaBtn: "Encyclopedia",
            modeStandard: "Standard",
            modeSustainable: "Sustainable",
            usageTitle: "Quota",
            language: "ç¹é«”ä¸­æ–‡",
            instructionTitle: "Quick Guide & Limits:",
            step1Title: "1. Topic",
            step1Desc: "Set Topic top-left. AI customizes guides.",
            step2Title: "2. Ideate",
            step2Desc: "Use AI Spark. Click notes to refine.",
            step3Title: "3. Diagnose",
            step3Desc: "Find blind spots, then Email report.",
            quotaTitle: "4. Daily Quota",
            quotaDesc: `This is a free service with limits. If you get a notification, you've exceeded the daily limit (${LOCAL_DAILY_LIMIT}).`,
            aiConsultantTitle: "AI Consultant",
            aiConsultantDesc: "Answer to get started.",
            submitAndGenerate: "Generate",
            skipAndGenerate: "Skip & Generate",
            loadingAnalysis: "Analyzing...",
            loadingGlobal: "Generating Blueprint...",
            loadingDiagnose: "Diagnosing...",
            loadingPersonalize: "Personalizing...",
            diagnoseTitle: "Diagnosis",
            diagnoseDesc: "Find risks and blind spots.",
            btnDiagnose: "Start Diagnosis",
            btnEmail: "Email Report",
            modalContextTitle: "Business Idea?",
            modalContextDesc: "Tell us your idea for customized guides.",
            placeholderContext: "e.g., A coffee shop...",
            btnNoSet: "Skip",
            btnStartPlan: "Start",
            brandModalTitle: "Brand Library",
            brandModalDesc: "Select a brand to analyze.",
            searchPlaceholder: "Enter brand...",
            btnAnalyze: "Analyze",
            brandOverwriteWarning: "âš ï¸ Overwrites content",
            brandDisclaimer: "AI generated.",
            refineTitle: "Refiner",
            refineLabel: "Original Text",
            btnSpecific: "ğŸ¯ Specific",
            btnAttractive: "âœ¨ Attractive",
            btnCritique: "ğŸ§ Critique",
            placeholderRefine: "Or command...",
            btnConfirmRefine: "Confirm",
            emailTitle: "Send Report",
            emailDesc: "We will open your mail app with the text report in the body (No attachment).",
            labelName: "Name",
            labelEmail: "Recipient Email",
            privacyNote: "Opens your default mail app.",
            btnSend: "Open Mail App",
            btnSending: "Preparing...",
            sentTitle: "Opened",
            sentDesc: "Check mail window.",
            btnBack: "Back",
            reportTitle: "Report",
            btnUnderstand: "OK",
            resetModalTitle: "Reset?",
            resetModalDesc: "Clear all content? Cannot be undone.",
            btnSaveAndReset: "Reset",
            btnClearOnly: "Reset",
            btnCancel: "Cancel",
            encyopediaModalTitle: "Encyclopedia",
            encyopediaModalDesc: "Click sections for info.",
            addItem: "Add...",
            aiSpark: "AI Spark",
            topicHelp: "Info",
            sections: {
              keyPartners: { title: "Key Partners", subtitle: "Strategic alliances." },
              keyActivities: { title: "Key Activities", subtitle: "Core actions." },
              keyResources: { title: "Key Resources", subtitle: "Key assets." },
              valuePropositions: { title: "Value Propositions", subtitle: "Value created." },
              customerRelationships: { title: "Relationships", subtitle: "Interactions." },
              channels: { title: "Channels", subtitle: "Touchpoints." },
              customerSegments: { title: "Segments", subtitle: "Target audience." },
              costStructure: { title: "Cost Structure", subtitle: "Major costs." },
              revenueStreams: { title: "Revenue Streams", subtitle: "Income sources." },
              envCost: { title: "Env. Costs", subtitle: "Negative impact." },
              envBenefit: { title: "Env. Benefits", subtitle: "Positive impact." },
              socCost: { title: "Social Costs", subtitle: "Negative impact." },
              socBenefit: { title: "Social Benefits", subtitle: "Positive impact." },
            },
            layers: { biz: "Business", eco: "Economic", env: "Environmental", soc: "Social" }
          }
        };

        // --- Morandi Pro Palette ---
        const STYLE_BLUE = { bg: 'bg-slate-50', border: 'border-slate-200 hover:border-blue-300', icon: 'text-slate-600', accent: 'border-t-4 border-t-slate-400' };
        const STYLE_CYAN = { bg: 'bg-cyan-50/50', border: 'border-cyan-200 hover:border-cyan-400', icon: 'text-cyan-700', accent: 'border-t-4 border-t-cyan-500' };
        const STYLE_SKY  = { bg: 'bg-sky-50/50', border: 'border-sky-200 hover:border-sky-400', icon: 'text-sky-700', accent: 'border-t-4 border-t-sky-500' };
        const STYLE_VIOLET = { bg: 'bg-violet-50/60', border: 'border-violet-200 hover:border-violet-400', icon: 'text-violet-700', accent: 'border-t-4 border-t-violet-500' };
        const STYLE_ROSE = { bg: 'bg-rose-50/50', border: 'border-rose-200 hover:border-rose-400', icon: 'text-rose-700', accent: 'border-t-4 border-t-rose-500' };
        const STYLE_PINK = { bg: 'bg-pink-50/50', border: 'border-pink-200 hover:border-pink-400', icon: 'text-pink-700', accent: 'border-t-4 border-t-pink-500' };
        const STYLE_FUCHSIA = { bg: 'bg-fuchsia-50/50', border: 'border-fuchsia-200 hover:border-fuchsia-400', icon: 'text-fuchsia-700', accent: 'border-t-4 border-t-fuchsia-500' };
        const STYLE_ORANGE = { bg: 'bg-orange-50/60', border: 'border-orange-200 hover:border-orange-400', icon: 'text-orange-700', accent: 'border-t-4 border-t-orange-500' };
        const STYLE_EMERALD = { bg: 'bg-emerald-50/60', border: 'border-emerald-200 hover:border-emerald-400', icon: 'text-emerald-700', accent: 'border-t-4 border-t-emerald-500' };
        const STYLE_STONE = { bg: 'bg-stone-100/60', border: 'border-stone-300 hover:border-stone-400', icon: 'text-stone-600', accent: 'border-t-4 border-t-stone-500' };
        const STYLE_TEAL = { bg: 'bg-teal-50/60', border: 'border-teal-200 hover:border-teal-400', icon: 'text-teal-700', accent: 'border-t-4 border-t-teal-500' };
        const STYLE_RED = { bg: 'bg-red-50/60', border: 'border-red-200 hover:border-red-400', icon: 'text-red-700', accent: 'border-t-4 border-t-red-500' };
        const STYLE_AMBER = { bg: 'bg-amber-50/60', border: 'border-amber-200 hover:border-amber-400', icon: 'text-amber-700', accent: 'border-t-4 border-t-amber-500' };

        const initialCanvasDataStructure = {
          keyPartners: { id: 'keyPartners', style: STYLE_CYAN, items: [] },
          keyActivities: { id: 'keyActivities', style: STYLE_SKY, items: [] },
          keyResources: { id: 'keyResources', style: STYLE_BLUE, items: [] },
          valuePropositions: { id: 'valuePropositions', style: STYLE_VIOLET, items: [] },
          customerRelationships: { id: 'customerRelationships', style: STYLE_FUCHSIA, items: [] },
          channels: { id: 'channels', style: STYLE_PINK, items: [] },
          customerSegments: { id: 'customerSegments', style: STYLE_ROSE, items: [] },
          costStructure: { id: 'costStructure', style: STYLE_ORANGE, items: [] },
          revenueStreams: { id: 'revenueStreams', style: STYLE_EMERALD, items: [] },
          envCost: { id: 'envCost', style: STYLE_STONE, items: [] },
          envBenefit: { id: 'envBenefit', style: STYLE_TEAL, items: [] },
          socCost: { id: 'socCost', style: STYLE_RED, items: [] },
          socBenefit: { id: 'socBenefit', style: STYLE_AMBER, items: [] }
        };

        const geminiCall = async (prompt, isJson = false) => {
            if (!apiKey) {
                alert("è«‹å¡«å…¥ API Keyï¼\n\n(å¦‚æœæ˜¯é–‹ç™¼è€…ï¼Œè«‹åœ¨ç¨‹å¼ç¢¼çš„ const apiKey è®Šæ•¸ä¸­å¡«å…¥æ‚¨çš„é‡‘é‘°)");
                return "";
            }
            await checkAndIncrementUsage();
            try {
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                if (isJson) payload.generationConfig = { responseMimeType: "application/json" };
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await response.json();
                
                if (data.error) {
                    if (data.error.message && data.error.message.includes("referer")) {
                        throw new Error(`âš ï¸ API Key å—é™\n\næ‚¨çš„ API Key è¨­å®šäº† HTTP Referrer é™åˆ¶ï¼Œä½†ç›®å‰çš„ç¶²å€ä¸åœ¨å…è¨±æ¸…å–®ä¸­ã€‚\n\nè«‹å°‡ä»¥ä¸‹ç¶²å€åŠ å…¥ Google Cloud Console ç™½åå–®ï¼š\n${window.location.origin}/*\n\næˆ–è€…æš«æ™‚å°‡é™åˆ¶è¨­ç‚ºã€Œç„¡ (None)ã€ã€‚`);
                    }
                    throw new Error(data.error.message);
                }
                
                let text = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                if (isJson) {
                    text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    try {
                        const start = text.indexOf('{'); const end = text.lastIndexOf('}');
                        if(start !== -1 && end !== -1) return JSON.parse(text.substring(start, end+1));
                        const startArr = text.indexOf('['); const endArr = text.lastIndexOf(']');
                        if(startArr !== -1 && endArr !== -1) return JSON.parse(text.substring(startArr, endArr+1));
                    } catch(e) {} 
                }
                return text;
            } catch (err) { console.error(err); alert(err.message); throw err; }
        };

        // --- çµ„ä»¶ ---

        const InstructionCard = ({ t }) => {
            const [isOpen, setIsOpen] = useState(false); 
            if (!isOpen) return (<div className="max-w-[1440px] mx-auto mb-4 flex justify-end no-print"><button onClick={() => setIsOpen(true)} className="flex items-center gap-2 px-3 py-1.5 bg-white text-indigo-600 text-xs font-medium rounded-full shadow-sm hover:bg-indigo-50 border border-indigo-100 transition-all"><HelpCircle size={14} /> {t.instructionShow}</button></div>);
            return (
                <div className="max-w-[1440px] mx-auto mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 rounded-xl p-4 shadow-sm relative animate-fadeIn no-print">
                    <button onClick={() => setIsOpen(false)} className="absolute top-2 right-2 text-blue-400 hover:text-blue-600 p-1 rounded-full hover:bg-blue-100/50 transition-colors"><ChevronUp size={18} /></button>
                    <h3 className="text-blue-800 font-bold text-sm mb-3 flex items-center gap-2"><HelpCircle size={16}/> {t.instructionTitle}</h3>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm text-blue-900/80">
                        <div className="flex items-start gap-3 bg-white/60 p-3 rounded-lg border border-blue-100"><div className="bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 text-xs font-bold">1</div><div><span className="font-bold text-blue-800 block mb-1">{t.step1Title}</span>{t.step1Desc}</div></div>
                        <div className="flex items-start gap-3 bg-white/60 p-3 rounded-lg border border-blue-100"><div className="bg-purple-600 text-white w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 text-xs font-bold">2</div><div><span className="font-bold text-purple-800 block mb-1">{t.step2Title}</span>{t.step2Desc}</div></div>
                        <div className="flex items-start gap-3 bg-white/60 p-3 rounded-lg border border-blue-100"><div className="bg-emerald-600 text-white w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 text-xs font-bold">3</div><div><span className="font-bold text-emerald-800 block mb-1">{t.step3Title}</span>{t.step3Desc}</div></div>
                        <div className="flex items-start gap-3 bg-white/60 p-3 rounded-lg border border-blue-100"><div className="bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 text-xs font-bold">!</div><div><span className="font-bold text-red-800 block mb-1">{t.quotaTitle}</span>{t.quotaDesc}</div></div>
                    </div>
                </div>
            );
        };

        const EncyclopediaModal = ({ isOpen, onClose, t, customGuides }) => {
            const [selectedSection, setSelectedSection] = useState('valuePropositions'); 
            if (!isOpen) return null;
            const layers = { biz: ['keyPartners', 'keyActivities', 'keyResources', 'valuePropositions', 'customerRelationships', 'channels', 'customerSegments'], eco: ['costStructure', 'revenueStreams'], env: ['envCost', 'envBenefit'], soc: ['socCost', 'socBenefit'] };
            const currentSectionInfo = t.sections[selectedSection];
            const displayDesc = customGuides?.[selectedSection]?.description || currentSectionInfo.desc;
            const displayPrompt = customGuides?.[selectedSection]?.promptGuide || initialCanvasDataStructure[selectedSection].promptGuide;
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[10000] p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[80vh] animate-fadeIn relative flex overflow-hidden">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10"><X size={24} /></button>
                        <div className="w-1/3 bg-gray-50 border-r border-gray-200 overflow-y-auto p-4">
                            <div className="flex items-center gap-2 text-indigo-800 font-bold mb-4 px-2"><BookOpen size={20} /> {t.encyclopediaModalTitle}</div>
                            <div className="space-y-6">{Object.keys(layers).map(k => (<div key={k}><h5 className="text-xs font-bold text-gray-400 uppercase tracking-wider px-2 mb-2">{t.layers[k]}</h5><div className="space-y-1">{layers[k].map(key => (<button key={key} onClick={() => setSelectedSection(key)} className={`w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition-all ${selectedSection === key ? 'bg-white text-indigo-600 shadow-sm border border-gray-100' : 'text-gray-600 hover:bg-gray-100'}`}>{t.sections[key].title}</button>))}</div></div>))}</div>
                        </div>
                        <div className="w-2/3 p-8 overflow-y-auto">
                            <div className="mb-6 pb-6 border-b border-gray-100"><h2 className="text-3xl font-bold text-gray-900 mb-2">{currentSectionInfo.title}</h2><p className="text-lg text-indigo-600 font-medium">{currentSectionInfo.subtitle}</p></div>
                            <div className="space-y-8">
                                <div><h4 className="flex items-center gap-2 text-sm font-bold text-gray-500 uppercase tracking-wide mb-3"><FileText size={16}/> å®šç¾©</h4><p className="text-gray-700 leading-relaxed text-lg bg-gray-50 p-6 rounded-xl border border-gray-100">{displayDesc}</p></div>
                                <div><h4 className="flex items-center gap-2 text-sm font-bold text-gray-500 uppercase tracking-wide mb-3"><Lightbulb size={16}/> æ€è€ƒæ–¹å‘</h4><div className="text-gray-700 leading-relaxed p-6 rounded-xl border border-indigo-100 bg-indigo-50/30">{displayPrompt}</div></div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ContextModal = ({ isOpen, onClose, value, onChange, t, onStart }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[9999] p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 animate-fadeIn relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400"><X size={20}/></button>
                        <h2 className="text-xl font-bold mb-2 flex items-center gap-2 text-indigo-600"><Sparkles/> {t.modalContextTitle}</h2>
                        <p className="text-sm text-gray-500 mb-4">{t.modalContextDesc}</p>
                        <textarea value={value} onChange={e=>onChange(e.target.value)} className="w-full p-3 border border-indigo-100 rounded-lg mb-4 h-32 focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder={t.placeholderContext}></textarea>
                        <div className="flex justify-end gap-2"><button onClick={onClose} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">{t.btnNoSet}</button><button onClick={() => { onStart(); onClose(); }} className="px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 shadow-md">{t.btnStartPlan}</button></div>
                    </div>
                </div>
            )
        };

        const AiConsultantModal = ({ isOpen, onClose, mode, sectionId, context, canvasData, onComplete, t, lang }) => {
            const [step, setStep] = useState('loading_questions');
            const [questions, setQuestions] = useState([]);
            const [answers, setAnswers] = useState({});
            useEffect(() => {
                if (isOpen) {
                    setStep('loading_questions'); setQuestions([]); setAnswers({});
                    const fetchQuestions = async () => {
                        try {
                            const langInst = lang === 'zh' ? "ç¹é«”ä¸­æ–‡" : "English";
                            const prompt = mode === 'global' ? `é‡å°ã€Œ${context}ã€ä¸»é¡Œï¼Œæå‡º 5 å€‹å¼•å°å•é¡Œå¹«åŠ©ç™¼æƒ³å•†æ¥­æ¨¡å¼ã€‚ç”¨${langInst}å›å‚³ JSON Arrayã€‚` : `é‡å°ã€Œ${context}ã€çš„ã€Œ${sectionId}ã€å€å¡Šï¼Œæå‡º 3 å€‹å¼•å°å•é¡Œã€‚ç”¨${langInst}å›å‚³ JSON Arrayã€‚`;
                            const result = await geminiCall(prompt, true);
                            if (Array.isArray(result)) { setQuestions(result); setStep('answering'); } else throw new Error("Format");
                        } catch (e) { handleGenerate(true); }
                    };
                    fetchQuestions();
                }
            }, [isOpen]);
            const handleGenerate = async (skip) => {
                setStep('generating');
                try {
                    const inputs = skip ? "Skipped" : Object.values(answers).join("\n");
                    const langInst = lang === 'zh' ? "ç¹é«”ä¸­æ–‡" : "English";
                    let res;
                    if(mode==='global') {
                        const keys = Object.keys(canvasData);
                        const p = `Theme:${context} Answers:${inputs} Generate Canvas. Keys:${keys.join(',')}. Values:Array of 3 strings. Lang:${langInst}. JSON Object.`;
                        res = await geminiCall(p, true);
                    } else {
                        const p = `Theme:${context} Section:${sectionId} Answers:${inputs} Give 3 suggestions. Lang:${langInst}. JSON Array.`;
                        res = await geminiCall(p, true);
                    }
                    
                    if (mode === 'section' && !Array.isArray(res)) throw new Error("Format error");
                    
                    onComplete(res, mode);
                    onClose();
                } catch(e) { 
                    console.error(e);
                    onClose(); 
                }
            };
            if(!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[10000] p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 animate-fadeIn relative min-h-[400px] flex flex-col">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400"><X size={20}/></button>
                        {step !== 'answering' ? (<div className="flex-1 flex flex-col items-center justify-center"><Loader2 size={48} className="animate-spin text-indigo-500 mb-4"/><p>{t.loadingGlobal}</p></div>) : 
                        (<div className="flex-1 flex flex-col"><h3 className="font-bold mb-4 flex gap-2 text-indigo-600"><MessageCircleQuestion/> {t.aiConsultantTitle}</h3><div className="flex-1 overflow-y-auto mb-4 space-y-4">{questions.map((q,i)=>(<div key={i}><p className="text-sm font-bold mb-1 text-slate-700">{i+1}. {q}</p><input className="w-full p-2 border rounded" value={answers[i]||''} onChange={e=>setAnswers({...answers, [i]:e.target.value})}/></div>))}</div><button onClick={()=>handleGenerate(false)} className="w-full py-3 bg-indigo-600 text-white rounded font-bold hover:bg-indigo-700">{t.submitAndGenerate}</button><button onClick={()=>handleGenerate(true)} className="text-xs text-center mt-2 text-gray-400 underline">{t.skipAndGenerate}</button></div>)}
                    </div>
                </div>
            );
        };

        const EmailModal = ({ isOpen, onClose, canvasData, t, context }) => {
            const [email, setEmail] = useState('');
            const [name, setName] = useState('');
            const handleSend = () => { 
                let reportText = `å•†æ¥­æ¨¡å¼ç•«å¸ƒå ±å‘Š - ${context || "æœªå‘½åå°ˆæ¡ˆ"}\n\n`;
                Object.keys(canvasData).forEach(key => {
                    if (canvasData[key].items.length > 0) {
                        reportText += `ã€${t.sections[key].title}ã€‘\n`;
                        canvasData[key].items.forEach(item => reportText += `- ${item.text}\n`);
                        reportText += `\n`;
                    }
                });
                
                if(reportText.length > 1500) reportText = reportText.substring(0, 1500) + "\n... (å…§å®¹éé•·å·²æˆªæ–·ï¼Œè«‹å›ç¶²é æŸ¥çœ‹å®Œæ•´ç‰ˆ)";

                const subject = encodeURIComponent(`å•†æ¥­æ¨¡å¼ç•«å¸ƒå ±å‘Š: ${context || "Project"}`);
                const body = encodeURIComponent(`Hi ${name},\n\né€™æ˜¯æ‚¨çš„å•†æ¥­æ¨¡å¼ç•«å¸ƒå ±å‘Šæ‘˜è¦ï¼š\n\n${reportText}\n\nGenerated by AI Business Canvas`);
                
                // ä½¿ç”¨ window.open é–‹å•Ÿæ–°è¦–çª—ï¼Œé¿å…è¦†è“‹ç•¶å‰é é¢
                window.open(`mailto:${email}?subject=${subject}&body=${body}`, '_blank');
                onClose();
            };
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[10000] p-4"><div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 animate-fadeIn relative"><button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><X size={20} /></button><div className="text-center mb-6"><div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3"><Mail className="text-blue-600" size={24} /></div><h2 className="text-xl font-bold text-gray-800">{t.emailTitle}</h2><p className="text-sm text-gray-500 mt-1">{t.emailDesc}</p></div><div className="space-y-4"><div><label className="block text-xs font-bold text-gray-700 mb-1 uppercase">{t.labelName}</label><input type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Name"/></div><div><label className="block text-xs font-bold text-gray-700 mb-1 uppercase">{t.labelEmail}</label><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="email@example.com"/></div><div className="bg-blue-50 p-3 rounded text-xs text-blue-700 flex gap-2"><ShieldCheck size={14} className="flex-shrink-0 mt-0.5"/>{t.privacyNote}</div><button onClick={handleSend} disabled={!email || !name} className={`w-full py-3 rounded-lg font-bold text-white flex items-center justify-center gap-2 transition-all ${(!email || !name) ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 shadow-md hover:shadow-lg'}`}><Send size={18}/>{t.btnSend}</button></div></div></div>
            );
        };

        const BrandModal = ({ isOpen, onClose, onSelect, t }) => {
            const brands = ["Tesla", "Uber", "Netflix", "Airbnb", "Starbucks", "IKEA", "Apple", "Nike"];
            const [custom, setCustom] = useState('');
            if(!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[10000] p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 animate-fadeIn relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400"><X size={20}/></button>
                        <h2 className="text-xl font-bold mb-4 text-center">{t.brandModalTitle}</h2>
                        <div className="flex gap-2 mb-6"><input placeholder={t.searchPlaceholder} className="flex-1 p-2 border rounded" value={custom} onChange={e=>setCustom(e.target.value)} /><button onClick={()=>{onSelect(custom); onClose();}} className="px-4 bg-indigo-600 text-white rounded font-bold">{t.btnAnalyze}</button></div>
                        <div className="grid grid-cols-4 gap-3">{brands.map(b=>(<button key={b} onClick={()=>{onSelect(b); onClose();}} className="p-3 border rounded hover:bg-gray-50 font-bold">{b}</button>))}</div>
                    </div>
                </div>
            );
        };

        const ItemRefineModal = ({ isOpen, onClose, item, context, sectionTitle, onSave, t, lang }) => {
            const [text, setText] = useState('');
            const [loading, setLoading] = useState(false);
            useEffect(()=>{ if(isOpen && item) setText(typeof item.text==='string'?item.text:JSON.stringify(item.text)); },[isOpen,item]);
            const run = async (act) => {
                setLoading(true);
                try { const res = await geminiCall(`Context:${context}. Section:${sectionTitle}. Text:${text}. Action:${act}. Lang:${lang==='zh'?'Traditional Chinese':'English'}. Return only revised text.`, false); setText(res); } catch(e){} finally { setLoading(false); }
            };
            if(!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[10000] p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 animate-fadeIn relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400"><X size={20}/></button>
                        <h3 className="font-bold mb-4 flex items-center gap-2 text-indigo-600"><Bot/> {t.refineTitle}</h3>
                        <textarea className="w-full p-2 border rounded mb-4 h-32" value={text} onChange={e=>setText(e.target.value)}/>
                        <div className="grid grid-cols-2 gap-2 mb-4"><button disabled={loading} onClick={()=>run('Specific')} className="p-2 bg-gray-100 rounded text-xs hover:bg-gray-200">{t.btnSpecific}</button><button disabled={loading} onClick={()=>run('Attractive')} className="p-2 bg-gray-100 rounded text-xs hover:bg-gray-200">{t.btnAttractive}</button></div>
                        <button onClick={()=>onSave(text)} className="w-full py-2 bg-indigo-600 text-white rounded font-bold hover:bg-indigo-700">{t.btnConfirmRefine}</button>
                    </div>
                </div>
            );
        };

        const TopicGuideModal = ({ isOpen, onClose, sectionId, t, customGuides }) => {
            if (!isOpen || !sectionId) return null;
            const section = t.sections[sectionId];
            const customInfo = customGuides && customGuides[sectionId];
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[10000] p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 animate-fadeIn relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400"><X size={20}/></button>
                        <h3 className="text-xl font-bold mb-4 text-indigo-600">{t.topicHelp}</h3>
                        <div className="mb-4"><h4 className="font-bold">{section.title}</h4><p className="text-gray-600">{customInfo?.description || section.desc}</p></div>
                        <div className="bg-indigo-50 p-3 rounded text-sm text-indigo-800">{customInfo?.promptGuide || initialCanvasDataStructure[sectionId].promptGuide}</div>
                    </div>
                </div>
            );
        };

        const CanvasSection = ({ sectionKey, canvasData, activeSection, setActiveSection, newItemText, setNewItemText, handleAddItem, handleDeleteItem, openConsultant, openItemRefiner, aiSuggestions, setAiSuggestions, openTopicGuide, customGuides, className = "", t }) => {
          const section = canvasData[sectionKey]; 
          const staticText = t.sections[sectionKey];
          const customGuide = customGuides?.[sectionKey];
          const displaySubtitle = customGuide?.subtitle || staticText.subtitle;
          const isAdding = activeSection === sectionKey;
          const hasSuggestions = aiSuggestions?.sectionId === sectionKey;
          const inputRef = useRef(null);
          const style = section.style || STYLE_BLUE; // Fallback

          useEffect(() => { if (isAdding && !hasSuggestions && inputRef.current) inputRef.current.focus(); }, [isAdding, hasSuggestions]);

          return (
            <div className={`relative flex flex-col p-3 md:p-4 border transition-all min-h-[180px] ${style.bg} ${style.border} border-r border-b ${style.accent || ''} ${className}`}>
              <div className="flex justify-between items-start mb-2">
                <div className="flex items-center gap-2"><div><h3 className={`font-bold text-sm md:text-base tracking-wide flex items-center gap-2 ${section.iconColor || 'text-slate-600'}`}>{staticText.title}</h3><span className="text-[10px] md:text-xs font-medium text-gray-500 uppercase">{displaySubtitle}</span></div></div>
                <button onClick={() => openTopicGuide(sectionKey)} className={`text-gray-400 hover:text-gray-600 transition-colors no-print`}><HelpCircle size={14} /></button>
              </div>
              
              <div className="flex-1 space-y-2 overflow-y-auto max-h-[300px] scrollbar-thin scrollbar-thumb-gray-300 pr-1">
                {section.items.map(item => (
                    <div key={item.id} className="group relative bg-white/90 p-2.5 rounded shadow-sm border border-gray-100 text-sm text-gray-700 animate-slideIn hover:shadow-md transition-all cursor-pointer backdrop-blur-sm" onClick={(e) => { e.stopPropagation(); openItemRefiner(item, staticText.title); }}>
                        {item.text}
                        <div className="absolute top-1 right-1 opacity-0 group-hover:opacity-100 flex gap-1 transition-opacity no-print">
                            <button className="p-1 bg-white text-indigo-600 hover:bg-indigo-50 rounded shadow-sm" title="AI Refine"><Edit3 size={12} /></button>
                            <button onClick={(e) => { e.stopPropagation(); handleDeleteItem(sectionKey, item.id); }} className="p-1 bg-white text-red-500 hover:bg-red-50 rounded shadow-sm"><X size={12} /></button>
                        </div>
                    </div>
                ))}
              </div>
              
              {hasSuggestions && Array.isArray(aiSuggestions?.items) && (
                  <div className="mt-3 bg-white/80 backdrop-blur p-3 rounded-lg border border-indigo-100 animate-fadeIn shadow-sm">
                      <div className="flex justify-between items-center mb-2">
                          <span className="text-xs font-bold text-indigo-600 flex items-center gap-1"><Lightbulb size={12}/> AI:</span>
                          <button onClick={() => setAiSuggestions(null)} className="text-gray-400 hover:text-gray-700"><X size={12}/></button>
                      </div>
                      <div className="space-y-2">
                          {aiSuggestions.items.map((suggestion, idx) => (
                              <button key={idx} onClick={() => handleAddItem(sectionKey, suggestion)} className="w-full text-left text-xs p-2 bg-white hover:bg-indigo-50 text-gray-700 border border-indigo-100 rounded transition-colors flex items-center justify-between group">
                                  {typeof suggestion === 'string' ? suggestion : JSON.stringify(suggestion)}
                                  <Plus size={12} className="opacity-0 group-hover:opacity-100 text-indigo-600"/>
                              </button>
                          ))}
                      </div>
                  </div>
              )}
              
              <div className="mt-3 pt-2 border-t border-gray-200/50 no-print">
                {isAdding && !hasSuggestions ? (<div className="flex flex-col gap-2 animate-fadeIn"><textarea ref={inputRef} placeholder={t.addItem} className="w-full p-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-200 focus:outline-none resize-none bg-white shadow-inner text-gray-800" rows={2} value={newItemText} onChange={(e) => setNewItemText(e.target.value)} onKeyDown={(e) => { if(e.key === 'Enter' && !e.shiftKey && !e.nativeEvent.isComposing) { e.preventDefault(); handleAddItem(sectionKey, newItemText); } if(e.key === 'Escape') { setActiveSection(null); setNewItemText(''); } }} /><div className="flex justify-end gap-2"><button onClick={() => { setActiveSection(null); setNewItemText(''); }} className="px-3 py-1 text-xs text-gray-500 hover:text-gray-700">Cancel</button><button onClick={() => handleAddItem(sectionKey, newItemText)} className="px-3 py-1 text-xs bg-indigo-600 text-white rounded hover:bg-indigo-700 shadow-sm font-medium">Add</button></div></div>) : (!hasSuggestions && (<div className="flex gap-2"><button onClick={() => setActiveSection(sectionKey)} className="flex-1 flex items-center gap-1.5 text-xs font-medium text-gray-400 hover:text-indigo-600 transition-colors p-1.5 rounded hover:bg-white/50 group"><div className="w-5 h-5 rounded-full bg-white border border-gray-200 flex items-center justify-center group-hover:border-indigo-300 group-hover:text-indigo-600 transition-colors"><Plus size={12} /></div><span>{t.addItem}</span></button><div className="flex gap-1"><button onClick={() => openConsultant('section', sectionKey)} className="p-1.5 bg-white/50 text-indigo-400 hover:text-indigo-600 hover:bg-white rounded shadow-sm border border-transparent hover:border-indigo-100 transition-all" title={t.aiSpark}><Sparkles size={14} /></button></div></div>))}
              </div>
            </div>
          );
        };

        export default function BusinessCanvasAI() {
          const [canvasData, setCanvasData] = useState(initialCanvasDataStructure); 
          const [activeSection, setActiveSection] = useState(null);
          const [newItemText, setNewItemText] = useState('');
          const [businessContext, setBusinessContext] = useState('');
          const [customGuides, setCustomGuides] = useState({});
          const [aiSuggestions, setAiSuggestions] = useState(null); 
          const [lang, setLang] = useState('zh');
          const [isSustainableMode, setIsSustainableMode] = useState(false);
          const [dailyUsage, setDailyUsage] = useState(getLocalUsage());
          
          const [isContextModalOpen, setIsContextModalOpen] = useState(false);
          const [brandModalOpen, setBrandModalOpen] = useState(false); 
          const [isEmailModalOpen, setIsEmailModalOpen] = useState(false); 
          const [encyclopediaOpen, setEncyclopediaOpen] = useState(false);
          const [topicGuide, setTopicGuide] = useState({ isOpen: false, sectionId: null });
          const [consultant, setConsultant] = useState({ isOpen: false, mode: 'global', sectionId: null });
          const [itemRefiner, setItemRefiner] = useState({ isOpen: false, item: null, sectionTitle: '' });
          
          const [isBrandAnalyzing, setIsBrandAnalyzing] = useState(false);
          const [isAnalyzing, setIsAnalyzing] = useState(false);
          const [loadingPersonalize, setLoadingPersonalize] = useState(false);
          const [apiError, setApiError] = useState('');

          const t = TRANSLATIONS[lang];

          // ç›£è½é¡åº¦æ›´æ–°
          useEffect(() => {
            const handleUpdate = () => setDailyUsage(getLocalUsage());
            window.addEventListener('usageUpdated', handleUpdate);
            return () => window.removeEventListener('usageUpdated', handleUpdate);
          }, []);

          // å¾¹åº•çš„é‡ç½®åŠŸèƒ½
          const handleFullReset = () => {
              if (!confirm(t.resetModalDesc)) return;
              setCanvasData(initialCanvasDataStructure);
              setBusinessContext('');
              setCustomGuides({});
              setAiSuggestions(null);
              setApiError('');
          };

          const handleAddItem = (sectionId, text) => { if (!text || !text.trim()) return; setCanvasData(prev => ({ ...prev, [sectionId]: { ...prev[sectionId], items: [...prev[sectionId].items, { id: Date.now() + Math.random(), text: text.trim() }] } })); setNewItemText(''); };
          const handleDeleteItem = (sectionId, itemId) => { setCanvasData(prev => ({ ...prev, [sectionId]: { ...prev[sectionId], items: prev[sectionId].items.filter(item => item.id !== itemId) } })); };
          
          const openConsultant = (mode, sectionId = null) => { if (!businessContext.trim()) { setIsContextModalOpen(true); return; } setConsultant({ isOpen: true, mode, sectionId }); };
          const openItemRefiner = (item, sectionTitle) => { setItemRefiner({ isOpen: true, item, sectionTitle }); };
          const openTopicGuide = (sectionId) => { setTopicGuide({ isOpen: true, sectionId }); };
          const saveRefinedItem = (newText) => { if (itemRefiner.item) { setCanvasData(prev => { const newData = { ...prev }; for (const key in newData) { const items = newData[key].items; const index = items.findIndex(i => i.id === itemRefiner.item.id); if (index !== -1) { newData[key] = { ...newData[key], items: items.map(i => i.id === itemRefiner.item.id ? { ...i, text: newText } : i) }; break; } } return newData; }); } setItemRefiner({ ...itemRefiner, isOpen: false }); };

          const handlePersonalizeGuides = async () => {
              if (!businessContext) return;
              setLoadingPersonalize(true); setApiError('');
              try {
                  const keys = Object.keys(canvasData);
                  const prompt = `Context: ${businessContext}. Rewrite 1-sentence UI subtitle for BMC sections. Return JSON { sectionId: { subtitle: "text" } }. Keys: ${keys.join(',')}. Lang: ${lang==='zh'?'Traditional Chinese':'English'}.`;
                  const res = await geminiCall(prompt, true);
                  setCustomGuides(res);
              } catch(e) { setApiError(e.message); } finally { setLoadingPersonalize(false); }
          };

          const handleBrandAnalysis = async (brandName) => {
              if (!brandName) return;
              setIsBrandAnalyzing(true); setApiError('');
              setBusinessContext(brandName); 
              const keys = Object.keys(initialCanvasDataStructure);
              const prompt = `Analyze "${brandName}". Generate full BMC. Return JSON. Keys: ${keys.join(',')}. Values: Array of 3 strings. Lang: ${lang==='zh'?'Traditional Chinese':'English'}.`;
              try {
                  const result = await geminiCall(prompt, true);
                  setCanvasData(prev => {
                      const newData = { ...prev };
                      Object.keys(result).forEach(key => { if (newData[key]) { newData[key] = { ...newData[key], items: result[key].map(t => ({ id: Date.now() + Math.random(), text: t })) }; } });
                      return newData;
                  });
              } catch (e) { setApiError(e.message); } finally { setIsBrandAnalyzing(false); }
          };

          const handleAnalysis = async () => {
              if (!businessContext.trim()) { setIsContextModalOpen(true); return; }
              setIsAnalyzing(true); setApiError('');
              const content = {}; Object.keys(canvasData).forEach(key => { content[key] = canvasData[key].items.map(i => i.text); });
              const prompt = `Diagnose this BMC. Theme: ${businessContext}. Content: ${JSON.stringify(content)}. Provide concise feedback. Lang: ${lang==='zh'?'Traditional Chinese':'English'}. No Markdown.`;
              try { const result = await geminiCall(prompt, false); alert(result); } catch (err) { setApiError(err.message); } finally { setIsAnalyzing(false); }
          };

          const sectionProps = { canvasData, activeSection, setActiveSection, newItemText, setNewItemText, handleAddItem, handleDeleteItem, openConsultant, openItemRefiner, aiSuggestions, setAiSuggestions, openTopicGuide, t, customGuides };

          return (
            <div className="min-h-screen bg-[#F3F4F6] p-2 md:p-6 font-sans text-slate-800">
              <ContextModal isOpen={isContextModalOpen} onClose={() => setIsContextModalOpen(false)} value={businessContext} onChange={setBusinessContext} t={t} lang={lang} onStart={handlePersonalizeGuides} />
              <EmailModal isOpen={isEmailModalOpen} onClose={() => setIsEmailModalOpen(false)} canvasData={canvasData} t={t} context={businessContext} />
              <AiConsultantModal isOpen={consultant.isOpen} onClose={() => setConsultant({ ...consultant, isOpen: false })} mode={consultant.mode} sectionId={consultant.sectionId} context={businessContext} canvasData={canvasData} onComplete={(res, mode)=>{ if(mode==='global'){ setCanvasData(prev => { const n={...prev}; Object.keys(res).forEach(k=>{ if(n[k]) n[k].items = res[k].map(t=>({id:Date.now()+Math.random(), text:t})) }); return n; }); } else { setAiSuggestions({ sectionId: consultant.sectionId, items: res }); } }} t={t} lang={lang} />
              <ItemRefineModal isOpen={itemRefiner.isOpen} onClose={() => setItemRefiner({ ...itemRefiner, isOpen: false })} item={itemRefiner.item} context={businessContext} sectionTitle={itemRefiner.sectionTitle} onSave={saveRefinedItem} t={t} lang={lang} />
              <BrandModal isOpen={brandModalOpen} onClose={() => setBrandModalOpen(false)} onSelect={handleBrandAnalysis} t={t} />
              <TopicGuideModal isOpen={topicGuide.isOpen} onClose={() => setTopicGuide({ ...topicGuide, isOpen: false })} sectionId={topicGuide.sectionId} t={t} customGuides={customGuides} />
              <EncyclopediaModal isOpen={encyclopediaOpen} onClose={() => setEncyclopediaOpen(false)} t={t} customGuides={customGuides} />
              {isBrandAnalyzing && (<div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[10000] flex flex-col items-center justify-center text-white"><Loader2 size={64} className="animate-spin mb-4 text-blue-400" /><h2 className="text-2xl font-bold mb-2">{t.loadingAnalysis}</h2></div>)}
              {isAnalyzing && (<div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[10000] flex flex-col items-center justify-center text-white"><ClipboardCheck size={64} className="animate-bounce mb-4 text-emerald-400" /><h2 className="text-2xl font-bold mb-2">{t.loadingDiagnose}</h2></div>)}
              {loadingPersonalize && (<div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[10000] flex flex-col items-center justify-center text-white"><Wand2 size={64} className="animate-pulse mb-4 text-purple-400" /><h2 className="text-2xl font-bold mb-2">{t.loadingPersonalize}</h2></div>)}

              {/* å…¨åŸŸéŒ¯èª¤æç¤ºå¡ç‰‡ */}
              {apiError && (
                  <div className="fixed bottom-4 right-4 z-[11000] max-w-sm bg-white border-l-4 border-red-500 rounded shadow-lg p-4 animate-slideIn flex items-start gap-3">
                      <AlertCircle className="text-red-500 shrink-0" size={24} />
                      <div className="flex-1">
                          <h3 className="font-bold text-red-600 mb-1">Error</h3>
                          <p className="text-sm text-gray-600 whitespace-pre-wrap">{apiError}</p>
                          <button onClick={() => setApiError('')} className="mt-2 text-xs text-gray-400 hover:text-gray-600 underline">Dismiss</button>
                      </div>
                  </div>
              )}

              <header className="max-w-[1440px] mx-auto mb-4 flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-200 no-print">
                <div className="flex items-center gap-4 w-full md:w-auto shrink-0">
                    <div className="p-2.5 bg-slate-800 rounded-lg shadow-lg text-white"><Layout size={24} /></div>
                    <div>
                        <h1 className="text-2xl font-bold text-slate-800 tracking-tight">{t.title} <span className="text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full ml-2">v5.7</span></h1>
                        <div className="text-sm text-gray-500 mt-1 flex items-center gap-2">
                            <button onClick={()=>setIsContextModalOpen(true)} className="flex items-center gap-1 hover:text-indigo-600 transition-colors border-b border-dashed border-gray-300 hover:border-indigo-500"><Edit3 size={12}/> {businessContext || t.setupAI}</button>
                        </div>
                    </div>
                </div>
                
                <div className="flex items-center justify-end w-full overflow-x-auto no-scrollbar gap-2 py-2">
                     <div className={`flex items-center gap-1.5 px-3 py-2 rounded-lg border text-xs font-bold shrink-0 ${dailyUsage >= LOCAL_DAILY_LIMIT ? "bg-red-50 text-red-600 border-red-200" : "bg-emerald-50 text-emerald-600 border-emerald-200"}`} title={t.quotaDesc}>
                        <Activity size={14} />
                        <span>{dailyUsage}/{LOCAL_DAILY_LIMIT}</span>
                        {dailyUsage >= LOCAL_DAILY_LIMIT && <AlertCircle size={14} className="text-red-600 animate-pulse ml-1" />}
                     </div>
                     <button onClick={()=>setLang(l => l==='zh'?'en':'zh')} className="flex items-center gap-1.5 px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm text-gray-600 hover:bg-gray-50 font-medium shrink-0"><Globe size={16}/> {lang === 'zh' ? 'En' : 'ä¸­'}</button>
                     <button onClick={()=>setEncyclopediaOpen(true)} className="px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm hover:bg-gray-50 flex items-center gap-2 text-gray-700 font-medium shrink-0"><BookOpen size={16}/> {t.encyclopediaBtn}</button>
                     <button onClick={()=>setIsSustainableMode(!isSustainableMode)} className={`px-3 py-2 rounded-lg border text-sm font-bold flex items-center gap-2 transition-colors shrink-0 ${isSustainableMode ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'bg-white border-gray-200 text-gray-600'}`}>{isSustainableMode ? <ToggleRight size={18}/> : <ToggleLeft size={18}/>} {isSustainableMode ? t.modeSustainable : t.modeStandard}</button>
                     <button onClick={()=>setBrandModalOpen(true)} className="px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm hover:bg-gray-50 flex items-center gap-2 text-gray-700 font-medium shrink-0"><Building2 size={16}/> {t.brandCases}</button>
                     <button onClick={()=>openConsultant('global')} className="px-4 py-2 bg-slate-800 text-white rounded-lg shadow hover:bg-slate-900 flex items-center gap-2 font-bold transition-transform hover:scale-105 active:scale-95 shrink-0"><Wand2 size={16}/> {t.generateOneClick}</button>
                     <div className="w-px h-8 bg-gray-200 mx-1 shrink-0"></div>
                     <button onClick={handleFullReset} className="p-2 hover:bg-red-50 hover:text-red-500 rounded text-gray-400 shrink-0" title={t.reset}><RotateCcw size={18}/></button>
                </div>
              </header>

              <InstructionCard t={t} />

              <main className="max-w-[1440px] mx-auto bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200 print-border">
                <div className="grid grid-cols-1 md:grid-cols-5 divide-y md:divide-y-0 md:divide-x divide-gray-100 print:grid-cols-5 print:divide-x print:divide-gray-300">
                    <div className="md:col-span-5 bg-slate-50 p-1 px-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest flex items-center gap-1 border-b border-gray-100"><Briefcase size={10}/> {t.layers.biz}</div>
                    <div className="md:row-span-2 flex flex-col"><CanvasSection sectionKey="keyPartners" canvasData={canvasData} {...sectionProps} className="h-full" /></div>
                    <div className="md:col-span-1 flex flex-col"><CanvasSection sectionKey="keyActivities" canvasData={canvasData} {...sectionProps} className="flex-1" /><CanvasSection sectionKey="keyResources" canvasData={canvasData} {...sectionProps} className="flex-1" /></div>
                    <div className="md:row-span-2 flex flex-col z-10 bg-indigo-50/10 border-l border-r border-indigo-100"><CanvasSection sectionKey="valuePropositions" canvasData={canvasData} {...sectionProps} className="h-full" /></div>
                    <div className="md:col-span-1 flex flex-col"><CanvasSection sectionKey="customerRelationships" canvasData={canvasData} {...sectionProps} className="flex-1" /><CanvasSection sectionKey="channels" canvasData={canvasData} {...sectionProps} className="flex-1" /></div>
                    <div className="md:row-span-2 flex flex-col"><CanvasSection sectionKey="customerSegments" canvasData={canvasData} {...sectionProps} className="h-full" /></div>
                    <div className="md:col-span-5 grid grid-cols-1 md:grid-cols-2 border-t border-gray-100">
                        <div className="p-1 px-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest col-span-2 bg-slate-50 border-b border-gray-100 flex items-center gap-1"><Coins size={10}/> {t.layers.eco}</div>
                        <CanvasSection sectionKey="costStructure" canvasData={canvasData} {...sectionProps} />
                        <CanvasSection sectionKey="revenueStreams" canvasData={canvasData} {...sectionProps} />
                    </div>
                    {isSustainableMode && (
                        <>
                            <div className="md:col-span-5 grid grid-cols-1 md:grid-cols-2 border-t border-gray-100">
                                <div className="p-1 px-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest col-span-2 bg-slate-50 border-b border-gray-100 flex items-center gap-1"><Leaf size={10}/> {t.layers.env}</div>
                                <CanvasSection sectionKey="envCost" canvasData={canvasData} {...sectionProps} />
                                <CanvasSection sectionKey="envBenefit" canvasData={canvasData} {...sectionProps} />
                            </div>
                            <div className="md:col-span-5 grid grid-cols-1 md:grid-cols-2 border-t border-gray-100">
                                <div className="p-1 px-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest col-span-2 bg-slate-50 border-b border-gray-100 flex items-center gap-1"><Heart size={10}/> {t.layers.soc}</div>
                                <CanvasSection sectionKey="socCost" canvasData={canvasData} {...sectionProps} />
                                <CanvasSection sectionKey="socBenefit" canvasData={canvasData} {...sectionProps} />
                            </div>
                        </>
                    )}
                </div>
              </main>

              <div className="max-w-[1440px] mx-auto mt-8 mb-12 p-8 bg-white rounded-2xl border border-gray-200 text-center shadow-sm relative overflow-hidden no-print">
                  <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-400 to-indigo-500"></div>
                  <h2 className="text-2xl font-bold text-slate-800 mb-3 flex items-center justify-center gap-2"><ClipboardCheck className="text-indigo-600" /> {t.diagnoseTitle}</h2>
                  <p className="text-gray-500 mb-6 max-w-2xl mx-auto">{t.diagnoseDesc}</p>
                  <div className="flex justify-center gap-4">
                      <button onClick={handleAnalysis} className="px-8 py-3 bg-white border border-gray-300 rounded-xl shadow-sm hover:bg-gray-50 font-bold flex items-center gap-2 text-slate-700"><ClipboardCheck size={20}/> {t.btnDiagnose}</button>
                      <button onClick={()=>setIsEmailModalOpen(true)} className="px-8 py-3 bg-slate-800 text-white rounded-xl shadow-lg hover:bg-slate-900 font-bold flex items-center gap-2"><Mail size={20}/> {t.btnEmail}</button>
                  </div>
              </div>
              <footer className="text-center text-gray-400 text-xs mt-8 pb-8 no-print">Designed for Strategy & Clarity (Public Edition)</footer>
            </div>
          );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<BusinessCanvasAI />);
    </script>
</body>
</html>